---
id: story-001-001
epic: epic-001
title: Create Database Schema with 16 Tables and Constraints
priority: high
story_points: [TBD]
source_requirements: [FR-013, DB-CONFIG, DB-AUTHORS, DB-POSTS, DB-SIGNALS, DB-PORTFOLIOS, DB-POSITIONS, DB-PRICE-HISTORY, DB-EVAL-PERIODS, DB-COMMENTS, DB-ANALYSIS-RUNS, DB-SIGNAL-COMMENTS, DB-COMMENT-TICKERS, DB-POSITION-EXITS, DB-PREDICTIONS, DB-PREDICTION-OUTCOMES, DB-PREDICTION-EXITS, DB-FK-ENFORCE]
dependencies: []
blocks: [story-001-002, story-001-003, story-001-004, story-001-005]
---

# Story: Create Database Schema with 16 Tables and Constraints

## Description
Create the complete SQLite database schema containing all 16 tables as defined in PRD Appendix B. This includes all column definitions, data types, constraints, UNIQUE indexes on junction tables, foreign key relationships with cascade behavior, and the PRAGMA statements for foreign key enforcement and WAL mode. The schema is delivered as an executable SQL file (`schema.sql`) that can initialize a fresh database from scratch.

## Acceptance Criteria
- [ ] All 16 tables are created with exact column names, types, and constraints matching PRD Appendix B: system_config, authors, reddit_posts, signals, portfolios, positions, price_history, evaluation_periods, comments, analysis_runs, signal_comments, comment_tickers, position_exits, predictions, prediction_outcomes, prediction_exits
- [ ] UNIQUE constraints are present on junction tables: signal_comments (signal_id, comment_id), comment_tickers (comment_id, ticker), and on signals (ticker, signal_type, signal_date), price_history (ticker, date), predictions (comment_id, ticker), prediction_outcomes (prediction_id, day_offset)
- [ ] Foreign key relationships are defined for all FK columns (e.g., positions.portfolio_id -> portfolios.id, positions.signal_id -> signals.id, comments.analysis_run_id -> analysis_runs.id, comments.post_id -> reddit_posts.id, comments.parent_comment_id -> comments.id)
- [ ] Foreign key ON DELETE behavior matches PRD specification: CASCADE on position_exits.position_id, RESTRICT on comments.post_id (refer to PRD Appendix B for each FK relationship)
- [ ] Self-referential FK on comments.parent_comment_id allows NULL (top-level comments) and references comments.id
- [ ] `PRAGMA foreign_keys = ON;` and `PRAGMA journal_mode = WAL;` are included at the top of the schema file
- [ ] Schema file executes without errors on a fresh SQLite database, producing all 16 tables
- [ ] Default values are applied where specified (e.g., predictions.status DEFAULT 'tracking', predictions.trailing_stop_active DEFAULT FALSE, evaluation_periods.status DEFAULT 'active')
- [ ] Nullable fields are correctly nullable and non-nullable fields have NOT NULL constraints where the PRD specifies them (e.g., predictions.status VARCHAR(20) NOT NULL, predictions.created_at TIMESTAMP NOT NULL)

## Technical Notes
- All table definitions are in PRD Appendix B (lines 1812-2188)
- The schema should be a single `schema.sql` file that can be run via `sqlite3 wsb.db < schema.sql`
- Use `CREATE TABLE IF NOT EXISTS` to support idempotent re-runs
- The positions table has 28+ columns spanning stock-specific, option-specific, monitoring state, and closure fields
- The comments table uses `reddit_id VARCHAR(20) UNIQUE` as the deduplication key
- The self-referential FK on comments (parent_comment_id -> comments.id) supports comment threading
- Direction and option_type on positions are intentionally redundant per PRD note

## Dependencies
- Depends on: none (this is the foundational story)
- Blocks: story-001-002, story-001-003, story-001-004, story-001-005
