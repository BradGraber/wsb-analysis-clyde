---
id: task-002-009-01
story: story-002-009
title: Write Reddit pipeline unit tests covering all algorithmic components
complexity: 2
---

# Task: Write Reddit pipeline unit tests covering all algorithmic components

## Description
Create `tests/test_reddit_pipeline.py` with comprehensive unit tests for the Reddit pipeline's core algorithms: priority scoring formula, parent chain building, financial keyword detection, image URL pattern matching, comment deduplication logic, and engagement score calculation. All tests use hand-crafted fixtures (no live API calls) and pytest parametrize for coverage breadth.

## Acceptance Criteria
- [ ] Priority scoring formula test: verify (financial*0.4) + (trust*0.3) + (engagement*0.3) - depth_penalty for at least 3 cases: all-zero inputs, max-value inputs (1.0 each, depth=0), typical mixed values
- [ ] Parent chain building test: 3-level nested thread (root -> reply -> sub-reply) produces correct parent_chain arrays; top-level comment has empty parent_chain
- [ ] Financial keyword detection tests: zero keywords (score=0.0), single keyword, multiple keywords, case-insensitive matching ("CALLS" vs "calls"), word boundary (no false positive for "called")
- [ ] Image URL pattern matching tests: all 3 positive patterns (i.redd.it, imgur, preview.redd.it) and at least 2 negative patterns (youtube.com, reddit.com/r/...)
- [ ] Comment deduplication test: existing reddit_id flagged as duplicate with analysis_run_id updated; new reddit_id not flagged
- [ ] Engagement score tests: zero upvotes -> 0.0, zero replies -> 0.0, typical values (100 upvotes, 5 replies) produce correct result
- [ ] Depth penalty tests: depth=0 -> 0.0, depth=6 -> 0.3, depth=10 -> 0.3 (capped)
- [ ] All tests run with pytest, require no network access, no live API credentials
- [ ] Tests use pytest parametrize for keyword detection and URL pattern matching
- [ ] All tests pass (green) against the implementations from tasks 002-001 through 002-008

## Technical Notes
- Use hand-crafted fixtures per planning decision qc-qa-003 (VCR.py is for integration tests)
- Test data should include WSB-realistic comment bodies ("$TSLA calls looking good, strike at 420")
- Priority scoring tests verify formula weight application, not just ranking order
- For dedup tests, use an in-memory SQLite database with the comments schema from epic-001
- Mock PRAW objects for parent chain tests (provide .parent() method chain)
- PRD reference: PIPE-008 formula, INT-REDDIT integration requirements

## Dependencies
- Depends on: task-002-008-03 (all pipeline components must be implemented)
- Blocks: none
