---
id: task-006-005-01
story: story-006-005
title: Implement options expiration protection exit condition
complexity: 2
---

# Task: Implement options expiration protection exit condition

## Description
Implement the highest-priority options exit condition: expiration protection. Calculate DTE as calendar days between current date and the option's expiration_date. When DTE <= 2, trigger an immediate full close (100% of contracts_remaining) with exit_reason='expiration' and exit_price=current_premium. No further exit conditions are evaluated after expiration fires. Handle the edge case where DTE crosses the threshold between monitoring runs.

## Acceptance Criteria
- [ ] DTE calculated as calendar days: (expiration_date - current_date).days
- [ ] Triggers when DTE <= 2, exits 100% of contracts_remaining
- [ ] Exit reason is 'expiration'
- [ ] Exit price is current_premium at time of exit
- [ ] Evaluated FIRST in options exit cascade (highest priority, PIPE-045)
- [ ] No further exit conditions evaluated after expiration fires
- [ ] Handles DTE threshold crossing between runs (DTE=3 yesterday, DTE=1 today)
- [ ] Function accepts MonitoredInstrument (not concrete Position type)

## Technical Notes
- FR-044: Exit 100% when DTE <= 2, highest priority
- PIPE-045: Options priority: expiration > stop-loss > take-profit > trailing > time
- Full close invokes finalization (story-006-011)
- DTE uses calendar days, not trading days

## Dependencies
- Depends on: task-006-008-01 (candle iteration framework)
- Blocks: task-006-006-01 (premium exits run after expiration check)
