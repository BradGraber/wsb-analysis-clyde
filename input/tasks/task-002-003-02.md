---
id: task-002-003-02
story: story-002-003
title: Implement parent chain building for threaded comment context
complexity: 2
---

# Task: Implement parent chain building for threaded comment context

## Description
Add a `build_parent_chains(comments: list[ProcessedComment], comment_forest) -> None` function that populates the parent_chain field on each ProcessedComment by walking up the Async PRAW comment tree from each comment to the root, collecting ParentChainEntry objects (id, body, depth, author) in order from immediate parent to root. Top-level comments get an empty parent_chain.

## Acceptance Criteria
- [ ] Top-level comments (depth=0) have parent_chain set to an empty list
- [ ] Nested comments include all ancestors as ParentChainEntry objects, ordered from immediate parent to root
- [ ] Each ParentChainEntry has: id (reddit comment ID string), body (comment text), depth (int), author (username string)
- [ ] A comment at depth=3 has exactly 3 entries in parent_chain (depth=2, depth=1, depth=0)
- [ ] Deleted parent comments use "[deleted]" for author and body fields as returned by Async PRAW
- [ ] Orphaned comments (parent not in fetched set) have parent_chain truncated at the last known ancestor
- [ ] Mutates ProcessedComment objects in-place (sets parent_chain field)
- [ ] Unit test: 3-level thread (root -> reply -> sub-reply) produces correct parent_chain arrays
- [ ] Unit test: top-level comment has empty parent_chain

## Technical Notes
- Async PRAW's comment.parent() returns the parent Comment or Submission; walk until reaching a Submission (the post)
- Build a lookup dict of reddit_id -> comment for efficient parent resolution within the fetched set
- For comments whose parent was not fetched (beyond 1000 limit), truncate the chain at the last available ancestor
- ParentChainEntry is defined in task-002-008-01 (Appendix D.3)
- PRD reference: PIPE-006, Appendix D.3

## Dependencies
- Depends on: task-002-003-01 (comments must be fetched first), task-002-008-01 (ParentChainEntry dataclass)
- Blocks: task-002-007-01 (priority scoring preserves parent chains on selected comments)
