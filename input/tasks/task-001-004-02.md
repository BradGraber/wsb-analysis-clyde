---
id: task-001-004-02
story: story-001-004
epic: epic-001
title: Implement get_config helper and write unit tests for connection manager
complexity: 2
---

# Task: Implement get_config helper and write unit tests for connection manager

## Description
Add a `get_config(key: str, db_path: str = None) -> str` helper function to `db.py` that reads a single value from the system_config table by key. If the key does not exist, raise a KeyError with a descriptive message. Write unit tests covering: FK enforcement (insert violating FK raises IntegrityError), WAL mode verification, get_config success and missing-key error, and context manager cleanup.

## Acceptance Criteria
- [ ] `get_config(key)` returns the string value for the given key from system_config
- [ ] `get_config(key)` raises KeyError with message including the key name if key not found
- [ ] Unit test: inserting a row with invalid FK raises sqlite3.IntegrityError (proves FK enforcement)
- [ ] Unit test: get_config returns correct value for a known key
- [ ] Unit test: get_config raises KeyError for non-existent key
- [ ] Unit test: connection is properly closed after context manager exits

## Technical Notes
- get_config uses get_connection internally; it is a convenience wrapper
- Test with an in-memory database or temporary file database for isolation
- For FK test: create two tables (parent + child), insert child with non-existent parent_id
- get_config enforces CFG-RUNTIME-READ: all config must be read from DB, not hardcoded
- Consider adding a get_config_float(key) or get_config_int(key) variant if useful, but keep it simple for now

## Files to Create/Modify
- `src/db.py` (add get_config function)
- `tests/test_db.py` (new test file)
