---
id: task-007-003-02
story: story-007-003
title: Implement GET /positions, /positions/{id} with convenience fields and exit history
complexity: 2
---

# Task: Implement GET /positions, /positions/{id} with convenience fields and exit history

## Description
Implement the two position GET endpoints. The list endpoint supports filters (portfolio_id, status, ticker, instrument_type, signal_type) and computes convenience fields on-demand for each position. The detail endpoint returns a single position with full exit strategy state and complete position_exits history. Phase 7a task (Weeks 2-3).

## Acceptance Criteria
- [ ] GET /positions returns paginated positions with all 5 filter parameters working individually and combined
- [ ] Each position includes computed convenience fields: current_price, unrealized_return_pct, nearest_exit_distance_pct, hold_days, dte, premium_change_pct
- [ ] Each position includes its position_exits records as a nested array
- [ ] GET /positions/{id} returns single position with exit strategy state (stop_loss_price, trailing_stop_active, etc.) and full position_exits history
- [ ] Returns NOT_FOUND for invalid position ID
- [ ] Response time under 500ms for up to 40 open positions
- [ ] Convenience fields are NULL/omitted for closed positions where not applicable (e.g., unrealized_return_pct for closed positions)
- [ ] Options positions include dte (days to expiration) and premium_change_pct; stock positions include hold_days

## Technical Notes
- Convenience field calculations:
  - `current_price`: latest price from price_history table for position's ticker
  - `unrealized_return_pct`: (current_price - entry_price) / entry_price * 100 for stocks; similar for options with premium
  - `nearest_exit_distance_pct`: MIN distance to any active exit threshold (stop_loss, take_profit, trailing)
  - `hold_days`: (today - opened_at).days
  - `dte`: (expiration_date - today).days for options, NULL for stocks
  - `premium_change_pct`: (current_premium - entry_premium) / entry_premium * 100 for options
- Optimize with SELECT specific columns (positions has 28+ columns)
- Consider SQL subquery for current_price to avoid N+1 queries
- Create `src/api/routes/positions.py` router module

## Dependencies
- Depends on: task-007-002-01, task-007-002-02 (response envelope, pagination, error handlers)
- Blocks: task-007-004-01 (seed data should verify these endpoints)
