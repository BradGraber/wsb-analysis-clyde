---
id: task-002-007-01
story: story-002-007
title: Implement composite priority scoring formula and top-50-per-post selection
complexity: 2
---

# Task: Implement composite priority scoring formula and top-50-per-post selection

## Description
Create a `score_and_select_comments(posts: list[ProcessedPost], weights: tuple = (0.4, 0.3, 0.3)) -> list[ProcessedPost]` function that computes the composite priority_score for every comment using the weighted formula, ranks comments within each post by priority_score descending, selects the top 50 per post, and discards non-selected comments. Parent chain context is preserved on selected comments.

## Acceptance Criteria
- [ ] Composite priority_score = (financial_score * 0.4) + (author_trust * 0.3) + (engagement * 0.3) - depth_penalty
- [ ] All comments across all posts are scored (approximately 10,000 total)
- [ ] Selection is per-post: top 50 comments from each post are retained (not global top 500)
- [ ] Posts with fewer than 50 comments retain all of their comments
- [ ] Selected comments retain their parent_chain arrays unchanged
- [ ] Non-selected comments are removed from ProcessedPost.comments lists
- [ ] priority_score field is populated on each selected ProcessedComment
- [ ] priority_score is clamped to minimum 0.0 (depth_penalty cannot make it negative)
- [ ] Formula weights default to (0.4, 0.3, 0.3) but are configurable (read from system_config if available, else use defaults)
- [ ] Unit test: verify formula produces correct composite score for known inputs (all-zero, max-value, typical mixed)
- [ ] Unit test: verify per-post selection retains exactly top 50 by priority_score
- [ ] Unit test: post with <50 comments retains all

## Technical Notes
- The formula weights (0.4, 0.3, 0.3) are from PRD Section 3.2.2 Phase 2; consider loading from system_config table for runtime tunability
- This function orchestrates the output of stories 002-004, 002-005, and 002-006
- The ~500 selected comments (50 per post x 10 posts) become the input to epic-003 (AI analysis)
- Depth penalty was computed in task-002-006-01; it is subtracted here in the composite formula
- PRD reference: PIPE-008, PIPE-013, PIPE-014, Section 3.2.2 Phase 2 steps 1-4

## Dependencies
- Depends on: task-002-004-01 (financial_score), task-002-005-01 (author_trust), task-002-006-01 (engagement + depth_penalty)
- Blocks: task-002-008-02 (storage needs final selected comments)
