---
id: task-006-011-01
story: story-006-011
title: Implement full close finalization logic
complexity: 2
---

# Task: Implement full close finalization logic

## Description
Implement the position finalization function that executes when a position is fully closed (shares_remaining or contracts_remaining reaches 0). Set position status='closed', record exit_date, calculate hold_days as calendar days from open_date, and compute realized_return_pct as SUM(position_exits.realized_pnl) / position_size. Recalculate portfolio current_value. Prevent division-by-zero when position_size is 0.

## Acceptance Criteria
- [ ] Position status set to 'closed' when remaining quantity reaches 0
- [ ] exit_date set to the date of the final exit
- [ ] hold_days = (exit_date - open_date).days using calendar days
- [ ] realized_return_pct = SUM(all position_exits.realized_pnl) / position_size
- [ ] position_size: entry_price * shares (stocks) or entry_premium * contracts * 100 (options)
- [ ] Handles multiple partial exits: sums ALL exit records for the position
- [ ] Portfolio current_value recalculated: cash_available + SUM(open values)
- [ ] Division-by-zero prevented: if position_size is 0, realized_return_pct = 0.0

## Technical Notes
- PIPE-049: Full close finalization sets status, exit_date, hold_days, realized_return_pct
- Called by partial exit mechanics (story-006-009) when remaining=0
- Also called directly by full-exit conditions (stop-loss 100%, expiration, time stop)
- Must handle both single-exit and multi-exit closes
- Foundational function with no dependencies within epic-006

## Dependencies
- Depends on: none (foundational exit mechanic)
- Blocks: task-006-009-01 (partial exit calls finalization when remaining=0)
