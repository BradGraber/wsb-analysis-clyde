---
id: task-005-004-01
story: story-005-004
title: Implement position count check and replacement candidate identification
complexity: 3
---

# Task: Implement position count check and replacement candidate identification

## Description
Implement the per-portfolio position count check (10-position maximum) and the replacement candidate selection logic. When a portfolio has 10 open positions, identify the lowest-confidence position, verify the new signal exceeds it by >0.1 confidence, and check the +5% unrealized gain safeguard. Returns a decision: proceed (under limit), replace (candidate identified), or reject (no valid replacement).

## Acceptance Criteria
- [ ] Counts open positions per portfolio: SELECT COUNT(*) FROM positions WHERE portfolio_id = X AND status = 'open'
- [ ] When count < 10, returns "proceed" decision (no replacement needed)
- [ ] When count = 10, finds lowest-confidence open position in that specific portfolio
- [ ] Replacement requires: new_signal_confidence > lowest_position_confidence + 0.1
- [ ] Safeguard: if lowest position has unrealized_gain_pct > +5%, replacement is blocked
- [ ] Unrealized gain calculation: (current_price - entry_price) / entry_price for stocks; (current_premium - entry_premium) / entry_premium for options
- [ ] Returns "reject" with log message when confidence delta is insufficient or safeguard blocks
- [ ] Duplicate ticker positions are allowed (same ticker can exist in portfolio)
- [ ] Unit tests: under limit, at limit with valid replacement, confidence delta insufficient, unrealized gain safeguard, all-winners edge case

## Technical Notes
- FR-025 and PIPE-036 requirements
- The "all positions with >+5% unrealized gain" edge case means no replacement is possible -- signal is rejected for that portfolio
- Replacement is evaluated independently per portfolio: a signal may qualify for replacement in one portfolio but not another
- Current price for unrealized gain check requires a Schwab API call -- this should use cached price if already fetched in this pipeline run
- The position count of 10 should come from system_config for configurability

## Dependencies
- Depends on: task-005-003-01 (sizing determines what we are trying to open)
- Blocks: task-005-004-02
