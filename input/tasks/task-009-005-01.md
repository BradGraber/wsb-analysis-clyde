---
id: task-009-005-01
story: story-009-005
title: Implement evaluation period creation for 4 portfolios in lockstep
complexity: 2
---

# Task: Implement evaluation period creation for 4 portfolios in lockstep

## Description
Implement the evaluation period creation logic for Phase 7b. When no active evaluation period exists (first-ever run or after all previous periods completed), create 4 evaluation_periods rows -- one for each portfolio (stocks_quality, stocks_consensus, options_quality, options_consensus). All 4 share identical period_start (today) and period_end (today + 30 days) with status='active'. Each records instrument_type, signal_type, and value_at_period_start (current portfolio value). All 4 inserts in a single transaction. Includes idempotent check: if active periods already exist and have not expired, no new periods are created. PRD Section 3.2.2 lines 383-389.

## Acceptance Criteria
- [ ] When no active evaluation period exists, exactly 4 rows created (stocks_quality, stocks_consensus, options_quality, options_consensus)
- [ ] All 4 rows share identical period_start (today) and period_end (today + 30 days)
- [ ] Each row has correct instrument_type ('stock' or 'option') and signal_type ('quality' or 'consensus')
- [ ] value_at_period_start populated from portfolio's current_value
- [ ] All 4 INSERTs in single transaction (atomicity -- all or none)
- [ ] status='active' for all 4 rows
- [ ] Idempotent: if active period exists and period_end >= today, no new periods created
- [ ] If multiple active periods exist for a portfolio (integrity issue), log warning, do not create additional
- [ ] Unit tests cover: first-ever creation, idempotent skip, data integrity warning

## Technical Notes
- The 4 portfolios are defined in the portfolios table by epic-001
- Portfolio lookup: SELECT from portfolios to get current_value for each of the 4 portfolio types
- The check query: SELECT COUNT(*) FROM evaluation_periods WHERE status='active' AND period_end >= date('now')
- Transaction wrapping: BEGIN; INSERT x4; COMMIT; with rollback on any failure
- This story handles creation only; completion/rollover is in story-009-006

## Dependencies
- Depends on: epic-001 (evaluation_periods and portfolios table schemas)
- Blocks: task-009-006-01 (completion depends on active periods existing)
