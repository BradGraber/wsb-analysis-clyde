---
id: task-005-009-01
story: story-005-009
title: Write concurrent quote fetch and ThreadPoolExecutor integration tests
complexity: 2
---

# Task: Write concurrent quote fetch and ThreadPoolExecutor integration tests

## Description
Write integration-style unit tests verifying that concurrent Schwab quote fetches via ThreadPoolExecutor work correctly during position opening. Tests must verify no race conditions, no SQLite locking issues with concurrent writes, and correct behavior when one fetch fails while others succeed. Uses VCR.py cassettes for Schwab responses and in-memory SQLite with full schema.

## Acceptance Criteria
- [ ] Test: multiple portfolios fetch Schwab quotes simultaneously via ThreadPoolExecutor, all return valid prices
- [ ] Test: one Schwab fetch fails (timeout/error) while others succeed -- successful fetches still create positions
- [ ] Test: no SQLite locking errors when concurrent position INSERTs happen across different portfolios
- [ ] Test: portfolio value recalculation is correct after concurrent position opens
- [ ] All tests use VCR.py cassettes for Schwab API responses
- [ ] All tests use in-memory SQLite with full project schema for database state
- [ ] Tests run deterministically (no flaky timing-dependent assertions)

## Technical Notes
- This tests the concurrency aspect of task-005-007-02
- SQLite with WAL mode should handle concurrent reads but serialize writes; tests should verify this works in practice
- Use threading.Event or similar synchronization primitives if needed to control test timing
- VCR.py cassettes should include both successful and error responses
- Consider using a small thread pool (2-3 workers) for faster test execution

## Dependencies
- Depends on: task-005-008-01 (all position management implementation complete)
- Blocks: none
