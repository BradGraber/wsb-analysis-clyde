---
id: task-006-020-01
story: story-006-020
title: Write prediction monitoring unit tests (7 tests)
complexity: 3
---

# Task: Write prediction monitoring unit tests (7 tests)

## Description
Write 7 unit tests covering core prediction monitoring functionality: (1) expiration protection at DTE<=2, (2) stop-loss at -50% premium, (3) take-profit at +100% with 50% partial exit, (4) trailing stop at peak_premium * 0.70 after partial, (5) time stop at 10 days, (6) peak_premium tracking updates, (7) no-cash-impact verification (portfolio cash unchanged). Use fixture/mock prediction data satisfying MonitoredInstrument protocol with in-memory SQLite.

## Acceptance Criteria
- [ ] Test 1: Prediction expiration at DTE<=2, resolves with exit_reason='expiration'
- [ ] Test 2: Prediction stop-loss at -50% premium, resolves with exit_reason='stop_loss'
- [ ] Test 3: Prediction take-profit at +100%, exits 50% contracts, sets trailing_stop_active
- [ ] Test 4: Prediction trailing stop at peak_premium*0.70 after partial, resolves prediction
- [ ] Test 5: Prediction time stop at 10 days, resolves with exit_reason='time_stop'
- [ ] Test 6: Peak tracking updates prediction's peak_premium correctly
- [ ] Test 7: Portfolio cash_available unchanged after prediction processing (critical assertion)
- [ ] All tests verify prediction_exits records created (not position_exits)
- [ ] Tests verify simulated_return_pct calculation

## Technical Notes
- Mock predictions satisfy MonitoredInstrument protocol with is_real_position=False
- Test 7 is the critical no-cash-impact test: asserting portfolio unchanged
- Use pytest with in-memory SQLite for database assertions on prediction_exits
- Tests mirror options exit tests but verify prediction-specific behavior

## Dependencies
- Depends on: task-006-019-02 (prediction monitoring implementation)
- Blocks: none
