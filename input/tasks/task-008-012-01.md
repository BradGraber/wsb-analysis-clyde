---
id: task-008-012-01
story: story-008-012
title: Write 8 exit edge case integration tests
complexity: 2
---

# Task: Write 8 exit edge case integration tests

## Description
Write 8 integration tests covering exit scenarios via the REST API: stop_loss trigger, take_profit trigger (partial 50% exit), trailing_stop trigger, breakeven_stop trigger, time_stop exit, expiration exit, manual_close flow, and prediction-based accuracy flow. Each test verifies: correct exit_reason recorded, position status updated, portfolio cash adjusted, and position_exits record created.

## Acceptance Criteria
- [ ] Test 1: stop_loss trigger -> exit_reason='stop_loss', position closed, cash updated
- [ ] Test 2: take_profit partial 50% -> exit_reason='take_profit', shares_remaining updated, partial exit record
- [ ] Test 3: trailing_stop trigger -> exit_reason='trailing_stop', position closed
- [ ] Test 4: breakeven_stop trigger -> exit_reason='breakeven_stop', position closed
- [ ] Test 5: time_stop exit -> exit_reason='time_stop', position closed after 30-day limit
- [ ] Test 6: expiration exit -> exit_reason='expiration', options position expired
- [ ] Test 7: manual_close flow -> exit_reason='manual_close', reason text recorded
- [ ] Test 8: prediction accuracy flow -> prediction created, exit simulated, prediction_outcomes record correct
- [ ] All tests use seed data or test fixtures, runnable via `pytest`

## Technical Notes
- Integration tests: call REST API endpoints, not internal functions
- Use seed data from story-007-004 or dedicated fixtures
- Prediction test: create prediction -> simulate exit -> verify prediction_outcomes and is_correct
- Cover both stock and options positions where applicable
- pytest fixtures for database setup/teardown between tests

## Dependencies
- Depends on: task-008-007-01 (position rendering exists to validate against)
- Blocks: none
