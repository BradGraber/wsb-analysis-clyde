---
id: task-009-003-01
story: story-009-003
title: Implement Phase 3.5 prediction creation pipeline step with sentiment-to-option mapping
complexity: 2
---

# Task: Implement Phase 3.5 prediction creation pipeline step with sentiment-to-option mapping

## Description
Create the Phase 3.5 pipeline step that runs after Phase 3 (AI analysis) and before Phase 4 (signal detection). For each comment_ticker from the current run: determine option_type from per-ticker sentiment (bullish -> call, bearish -> put; skip neutral). Create prediction record with status='tracking'. Use INSERT OR IGNORE keyed on UNIQUE(comment_id, ticker) for dedup to prevent duplicates on re-runs. Register this step in the pipeline phase registry. PRD Section 3.2.2 lines 196-212.

## Acceptance Criteria
- [ ] Pipeline step registered as Phase 3.5, runs after Phase 3 and before Phase 4
- [ ] For each comment_ticker: bullish sentiment maps to option_type='call', bearish to 'put'
- [ ] Neutral sentiment tickers are skipped (no prediction created)
- [ ] INSERT OR IGNORE deduplicates on UNIQUE(comment_id, ticker) constraint
- [ ] Prediction record created with: comment_id, ticker, option_type, status='tracking', entry_date=current date
- [ ] Commit strategy: COMMIT per ticker batch (not per individual prediction)

## Technical Notes
- Sentiment determination: uses the per-ticker sentiment from Phase 3 AI analysis (not the overall comment sentiment)
- comment_tickers table has: comment_id, ticker, sentiment (bullish/bearish/neutral)
- ~50-100 unique tickers per cycle expected
- This task handles the core loop and record creation; strike selection and Schwab integration are in task-009-003-02
- Pipeline phase registry pattern from epic-002 (discrete entry points)

## Dependencies
- Depends on: epic-001 (predictions table schema), epic-003 (Phase 3 produces comment_tickers with sentiment)
- Blocks: task-009-003-02 (strike selection fills in remaining prediction fields)
