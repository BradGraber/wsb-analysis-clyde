---
id: task-005-008-01
story: story-005-008
title: Implement stop-loss and take-profit calculation at position entry
complexity: 2
---

# Task: Implement stop-loss and take-profit calculation at position entry

## Description
Calculate and write stop-loss and take-profit price levels on position records at creation time. For stocks: stop_loss_price = entry_price * (1 + stock_stop_loss_pct) and take_profit_price = entry_price * (1 + stock_take_profit_pct), where percentages are read from system_config. For options: entry_price (premium) is stored as the baseline; percentage-based thresholds are evaluated by epic-006 at monitoring time (no separate price fields needed). Integrate this calculation into the position creation flow (task-005-007-02) rather than as a separate UPDATE.

## Acceptance Criteria
- [ ] Stock stop_loss_price = entry_price * (1 + stock_stop_loss_pct), e.g., $100 * (1 + (-0.10)) = $90
- [ ] Stock take_profit_price = entry_price * (1 + stock_take_profit_pct), e.g., $100 * (1 + 0.15) = $115
- [ ] stock_stop_loss_pct and stock_take_profit_pct read from system_config (negative and positive values respectively)
- [ ] Options: no stop_loss_price/take_profit_price fields set; entry_price serves as premium baseline for epic-006 percentage monitoring
- [ ] Calculation handles long stock positions correctly (stop < entry < take_profit)
- [ ] Values written to positions table at creation time (part of INSERT, not separate UPDATE)
- [ ] Unit tests: stock stop/take-profit calculation, options baseline verification, system_config read

## Technical Notes
- PIPE-038 requirement
- This should be integrated into the position INSERT in task-005-007-02 rather than a separate UPDATE, per story-005-008 technical notes
- For Phase 1, only long stock positions exist (no short stocks), so directional math is straightforward
- Put options have entry_price = premium; epic-006 monitors (current_premium / entry_premium) against thresholds
- System_config keys: stock_stop_loss_pct (e.g., -0.10), stock_take_profit_pct (e.g., 0.15)

## Dependencies
- Depends on: task-005-007-03 (position must be created with entry_price)
- Blocks: task-005-009-01
