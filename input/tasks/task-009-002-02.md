---
id: task-009-002-02
story: story-009-002
title: Implement conviction score calculation with running average update
complexity: 2
---

# Task: Implement conviction score calculation with running average update

## Description
Implement the per-comment conviction score formula and running average update for author.avg_conviction_score. Per-comment conviction = (length_factor * 0.20) + (reasoning_bonus * 0.20) + (ai_confidence * 0.60), where length_factor = min(1.0, char_count/500), reasoning_bonus = 1.0 if has_reasoning else 0.0, ai_confidence from comment record. Running average uses: old_sum = old_avg * old_count, new_sum = sum of per-comment convictions, new_avg = (old_sum + new_sum) / new_total. Handle NULL avg_conviction_score for new authors. PRD Appendix F.3 lines 2970-3019.

## Acceptance Criteria
- [ ] Per-comment conviction formula applied correctly: length_factor = min(1.0, char_count/500), reasoning_bonus = 1.0 if has_reasoning else 0.0, conviction = (length_factor*0.20) + (reasoning_bonus*0.20) + (ai_confidence*0.60)
- [ ] Running average updated correctly: old_sum = old_avg * old_count, new_sum = sum of per-comment convictions for this run, new_avg = (old_sum + new_sum) / (old_count + new_count)
- [ ] Handles old_count=0 (new author) where avg_conviction_score is NULL -- new_avg = new_sum / new_count
- [ ] Conviction score is stored per-author (avg_conviction_score), not per-comment
- [ ] After metrics update, trust score is recalculated by calling calculate_trust_score (from task-009-001-01)
- [ ] Unit tests cover: new author conviction calc, update with existing average, edge cases (0-length comment, no reasoning, ai_confidence=0)

## Technical Notes
- Conviction is calculated for every comment, but stored as a running average on the author record
- The running average formula avoids floating-point drift by using sum-based recalculation
- ai_confidence comes from Phase 3 AI analysis (epic-003); values in [0.0, 1.0]
- char_count is the character count of the comment body
- Integration point: this runs as part of the same Phase 7a step as task-009-002-01 (author metrics upsert)

## Dependencies
- Depends on: task-009-002-01 (metrics upsert provides the author record context), task-009-001-01 (trust score recalculation after update)
- Blocks: none
