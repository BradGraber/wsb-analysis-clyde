---
id: task-007-005-01
story: story-007-005
title: Implement phase registry and background thread runner with isolated SQLite connection
complexity: 2
---

# Task: Implement phase registry and background thread runner with isolated SQLite connection

## Description
Create the pipeline orchestration module with a phase registry pattern (list of named callables) and a background thread runner that creates its own SQLite connection, iterates through registered phases sequentially, and updates analysis_runs progress at each phase boundary. The thread runner wraps execution in try/except to catch unhandled exceptions and set the run to 'failed'. Phase 7b task (Weeks 10-12).

## Acceptance Criteria
- [ ] Phase registry defined as ordered list of tuples: `[(phase_num, phase_label, callable), ...]`
- [ ] Background thread function creates a new SQLite connection with WAL mode and FK enforcement (separate from FastAPI request thread)
- [ ] Each phase callable receives the DB connection and run context (run_id, warnings list, etc.)
- [ ] At each phase boundary, UPDATE analysis_runs SET current_phase, phase_label, progress_current, progress_total
- [ ] On successful completion of all phases, SET status='completed', completed_at=UTC now
- [ ] Outer try/except catches any unhandled exception: SET status='failed', error_message=str(exception), log full traceback at ERROR level
- [ ] If exception occurs during a transaction, ROLLBACK before updating status to 'failed'
- [ ] Thread is a `threading.Thread` with daemon=False (should complete even if main thread shuts down)

## Technical Notes
- Phase registry example: `PHASES = [(1, "Fetching Reddit", reddit_phase), (2, "Analyzing comments", ai_phase), ...]`
- The actual phase callables will be provided by epics 002-006; this task creates the orchestration skeleton with placeholder/stub phases for testing
- DB connection: `sqlite3.connect(db_path, check_same_thread=False)` with PRAGMA foreign_keys=ON
- progress_current/progress_total: phase_num / len(PHASES) for simple progress; individual phases can update sub-progress
- Create `src/pipeline/orchestrator.py` module

## Dependencies
- Depends on: task-001-004-01 (get_connection pattern for reference), epic-001 through epic-006 (phase callables)
- Blocks: task-007-005-02, task-007-006-01
