---
id: task-006-010-01
story: story-006-010
title: Implement peak price and peak premium tracking
complexity: 2
---

# Task: Implement peak price and peak premium tracking

## Description
Implement peak tracking for open positions. After every monitoring pass (after exit evaluation), update peak_price for stocks (MAX of current peak_price and highest candle high) and peak_premium for options (MAX of current peak_premium and current_premium). Peaks are persisted via UPDATE to the positions table and are monotonically increasing. The peak used for trailing stop evaluation is from prior monitoring cycles, not updated mid-iteration.

## Acceptance Criteria
- [ ] peak_price updated to MAX(current peak_price, highest candle high) for stocks
- [ ] peak_premium updated to MAX(current peak_premium, current_premium) for options
- [ ] Peak values persisted to positions table via UPDATE
- [ ] Peak tracking occurs AFTER exit condition evaluation (not mid-iteration)
- [ ] Peak values never decrease (monotonically increasing)
- [ ] Handles positions with no candle data (peak unchanged)

## Technical Notes
- FR-028: Trailing stop for stocks uses peak_price (peak_price * 0.93)
- FR-043: Trailing stop for options uses peak_premium (peak_premium * 0.70)
- Initial peak values set at position open (epic-005); this task only handles updates
- Peak update timing is important: evaluate exits with old peak, then update peak for next cycle
- For stocks, peak_price is derived from candle highs, not current_price

## Dependencies
- Depends on: task-006-008-01 (candle iteration provides price data for peak tracking)
- Blocks: task-006-003-01, task-006-003-02, task-006-006-02 (trailing stops use peak values)
