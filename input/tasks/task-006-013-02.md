---
id: task-006-013-02
story: story-006-013
title: Implement fallback strategy and auth error handling
complexity: 3
---

# Task: Implement fallback strategy and auth error handling

## Description
Implement the fallback strategy for Schwab API failures: on stock quote failure after retries, fall back to yfinance for price data; on options quote failure after retries, skip options monitoring for that ticker. Handle Schwab auth token expiration: attempt proactive token refresh, and if refresh token is also expired, log error with re-authentication instructions. Handle yfinance unavailability as Tier 4 warning (skip monitoring, retry next run). All events logged via structlog.

## Acceptance Criteria
- [ ] Stock quote failure after retries: fall back to yfinance for that ticker
- [ ] Options quote failure after retries: skip options monitoring, log warning
- [ ] Auth token expiration: attempt proactive refresh
- [ ] Refresh token expired: log error with re-auth instructions, fall back to yfinance for stocks, skip options
- [ ] yfinance data unavailability: log Tier 4 warning, skip monitoring for ticker, retry next run
- [ ] All fallback activations logged with structlog (ticker, error, fallback action)
- [ ] Fallback decisions are per-ticker, not global (one ticker failure does not affect others)

## Technical Notes
- ERR-SCHWAB-STOCK: Retry 3x, skip ticker on failure (Tier 2)
- ERR-SCHWAB-OPTIONS: Same retry, skip options monitoring (Tier 2)
- ERR-SCHWAB-AUTH: Proactive refresh, fallback to yfinance, skip options
- ERR-YFINANCE: Log warning, skip, retry next run (Tier 4)
- Integrates with retry wrapper (task-006-013-01) for retry exhaustion detection
- ThreadPoolExecutor concurrent fetches: each thread handles its own fallback independently

## Dependencies
- Depends on: task-006-013-01 (retry wrapper provides exhaustion signal)
- Blocks: none
