---
id: task-002-006-01
story: story-002-006
title: Implement engagement score calculation, normalization, and depth penalty
complexity: 2
---

# Task: Implement engagement score calculation, normalization, and depth penalty

## Description
Create two scoring functions: (1) `calculate_engagement(upvotes: int, reply_count: int) -> float` using the formula log(upvotes + 1) x reply_count, and (2) `calculate_depth_penalty(depth: int) -> float` using min(0.3, depth * 0.05). After computing raw engagement scores for all comments in a batch, normalize engagement values to the 0-1 range (min-max normalization across the batch) so the 0.3 weight in the priority formula is meaningful.

## Acceptance Criteria
- [ ] Engagement score uses exact formula: math.log(upvotes + 1) * reply_count (natural logarithm)
- [ ] Zero upvotes: log(0+1) = log(1) = 0, engagement = 0.0 regardless of reply_count
- [ ] Zero replies: engagement = 0.0 regardless of upvote count
- [ ] Depth penalty uses exact formula: min(0.3, depth * 0.05)
- [ ] Depth=0 (top-level): penalty = 0.0; depth=6+: penalty capped at 0.3
- [ ] Engagement scores are normalized to 0-1 range across all comments in the current batch using min-max normalization
- [ ] If all comments have the same raw engagement score, normalized score is 0.0 (avoid division by zero)
- [ ] Both scores are computed for every ProcessedComment in the current run
- [ ] Unit test: zero upvotes returns engagement 0.0
- [ ] Unit test: zero replies returns engagement 0.0
- [ ] Unit test: typical values (100 upvotes, 5 replies) produce correct raw score
- [ ] Unit test: depth penalty at depth=0 is 0.0, depth=6 is 0.3, depth=10 is 0.3 (capped)
- [ ] Unit test: normalization of [0, 5, 10] produces [0.0, 0.5, 1.0]

## Technical Notes
- reply_count = number of direct replies to the comment (from Async PRAW comment.replies length, captured during fetch)
- Normalization must happen AFTER all comments are scored (two-pass: compute raw, then normalize)
- The reply_count should be captured during comment fetching (task-002-003-01) as an additional field or computed here from Async PRAW data
- Engagement feeds into priority formula at 30% weight; depth penalty is subtracted from the total
- PRD reference: PIPE-011, PIPE-012, Section 3.2.2 Phase 2 step 1 bullets 3-4

## Dependencies
- Depends on: task-002-003-01 (comments with score, depth, and reply data)
- Blocks: task-002-007-01 (priority scoring needs engagement and depth components)
