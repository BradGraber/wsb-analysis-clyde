---
id: task-005-007-02
story: story-005-007
title: Implement position INSERT with Schwab quote fetch and share/contract calculation
complexity: 3
---

# Task: Implement position INSERT with Schwab quote fetch and share/contract calculation

## Description
Implement the core position creation flow: fetch real-time price from Schwab (last trade for stocks, mark price for options), calculate shares or contracts, and INSERT the position record. For stocks: shares = floor(position_size / entry_price). For options: contracts = max(1, floor(position_size / (mark_price * 100))). The position record includes all required fields: entry_date, entry_price, position_size, status='open', signal_id, portfolio_id, ticker, direction, instrument_type, and option-specific fields when applicable.

## Acceptance Criteria
- [ ] Fetches real-time quote from Schwab: last trade price for stocks, mark price for options
- [ ] Stock shares calculated: floor(position_size / entry_price)
- [ ] Option contracts calculated: max(1, floor(position_size / (mark_price * 100)))
- [ ] Actual cost computed: stocks = shares * entry_price, options = contracts * mark_price * 100
- [ ] Position INSERT includes: entry_date, entry_price, shares/contracts, position_size, status='open', signal_id, portfolio_id, ticker, direction, instrument_type
- [ ] Option positions additionally include: contract_symbol, strike_price, expiration_date, option_type ('call'/'put'), contracts, underlying_price_at_entry
- [ ] Position record satisfies MonitoredInstrument Protocol properties: entry_price, remaining_quantity (shares_remaining or contracts_remaining), open_date, is_real_position=True
- [ ] Schwab quote fetch uses ThreadPoolExecutor for concurrent fetches across portfolios
- [ ] Unit tests: stock position creation, option position creation, Schwab failure handling

## Technical Notes
- PIPE-035 requirement
- The Position model must expose the MonitoredInstrument Protocol interface (story-006-015). Ensure the Position record has properties: entry_price, current_price, peak_price, remaining_quantity, open_date, trailing_stop_active, is_real_position
- shares_remaining = shares at creation (decremented by partial exits in epic-006)
- contracts_remaining = contracts at creation
- peak_price = entry_price at creation (updated by epic-006 monitoring)
- trailing_stop_active = false at creation
- ThreadPoolExecutor concurrency: use for fetching quotes when processing multiple portfolios for the same signal

## Dependencies
- Depends on: task-005-007-01 (cash guard must pass), task-005-006-02 (strike info for options)
- Blocks: task-005-007-03
