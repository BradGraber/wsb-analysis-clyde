---
id: task-002-003-01
story: story-002-003
title: Implement comment fetching with engagement sorting and replace_more handling
complexity: 2
---

# Task: Implement comment fetching with engagement sorting and replace_more handling

## Description
Add a `fetch_comments(submission, limit: int = 1000, replace_more_limit: int = 0) -> list[ProcessedComment]` function that fetches up to `limit` comments from a PRAW Submission, calls replace_more() to expand collapsed threads (with configurable limit), constructs ProcessedComment objects with correct depth tracking, and handles edge cases (zero comments, deleted authors, replace_more failures). Comments are sorted by engagement (score x replies) after fetching.

## Acceptance Criteria
- [ ] Fetches up to `limit` comments (default 1000) from the PRAW submission's comment forest
- [ ] Calls replace_more(limit=replace_more_limit) before iterating; default limit=0 skips deep expansion
- [ ] replace_more() timeout or failure logs a warning via structlog and proceeds with already-loaded comments
- [ ] Each comment produces a ProcessedComment with: reddit_id, post_id, author, body, score, depth, created_utc populated; priority_score=0.0, financial_score=0.0, author_trust_score=0.0, parent_chain=[] (chain built separately)
- [ ] Comment depth is correctly set from PRAW's comment.depth attribute (0 for top-level)
- [ ] Deleted/removed authors are stored as "[deleted]" as returned by PRAW
- [ ] Posts with zero comments return an empty list without error
- [ ] Comments are sorted by engagement metric (score x len(replies)) in descending order, top `limit` retained
- [ ] Unit test: mock submission with 3-level nested thread, verify depth values and comment count
- [ ] Unit test: submission with zero comments returns empty list

## Technical Notes
- PRAW provides comment.depth natively after replace_more(); no manual depth tracking needed
- Engagement sorting (score x replies) happens here for fetch prioritization; distinct from priority scoring in story-002-007
- reply_count for sorting = len(comment.replies) from PRAW forest (direct children only)
- The 1000-comment limit per post x 10 posts = ~10,000 total comments before prioritization
- PRD reference: PIPE-005, FR-010, Appendix D.1

## Dependencies
- Depends on: task-002-001-02 (posts must be fetched), task-002-008-01 (ProcessedComment dataclass)
- Blocks: task-002-003-02 (parent chain needs fetched comments)
