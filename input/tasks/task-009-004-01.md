---
id: task-009-004-01
story: story-009-004
title: Implement prediction resolution logic with HITL override support
complexity: 2
---

# Task: Implement prediction resolution logic with HITL override support

## Description
Implement the Phase 7a prediction resolution step. Query predictions with status='resolved' and contracts_remaining=0 (resolved by Phase 6 monitoring in story-006-019). For each resolved prediction: calculate blended simulated_return_pct = SUM(prediction_exits.simulated_pnl) / (entry_premium * contracts * 100). Determine is_correct = (simulated_return_pct > 0). Check hitl_override field: 'correct' forces is_correct=TRUE, 'incorrect' forces is_correct=FALSE, 'excluded' marks for skip. Update the prediction record with simulated_return_pct and is_correct. PRD Appendix F.4.2 lines 3045-3068.

## Acceptance Criteria
- [ ] Resolved predictions (status='resolved', contracts_remaining=0) are queried and processed
- [ ] simulated_return_pct = SUM(prediction_exits.simulated_pnl) / (entry_premium * contracts * 100) calculated correctly
- [ ] is_correct = TRUE when simulated_return_pct > 0, FALSE when <= 0
- [ ] HITL override takes absolute precedence: 'correct' -> is_correct=TRUE, 'incorrect' -> is_correct=FALSE
- [ ] 'excluded' override marks prediction for accuracy skip (passed to task-009-004-02)
- [ ] Prediction record updated with final simulated_return_pct and is_correct values
- [ ] Handles batch of resolved predictions per run (multiple may resolve in one cycle)

## Technical Notes
- Phase 6 (story-006-019) resolves predictions and populates prediction_exits; this task reads the results
- The HITL override is set via PATCH /predictions/{id} endpoint (epic-007); this task only reads the field
- Multiple predictions may resolve for the same author -- the list must be passed to task-009-004-02 for sequential EMA
- The > 0 boundary is the sole correctness criterion; there is no separate neutral threshold
- simulated_pnl in prediction_exits mirrors the realized_pnl pattern from position_exits

## Dependencies
- Depends on: story-006-019 (Phase 6 produces resolved predictions with prediction_exits)
- Blocks: task-009-004-02 (EMA accuracy update uses is_correct results)
