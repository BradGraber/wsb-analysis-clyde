---
id: task-006-016-01
story: story-006-016
title: Write stock stop-loss, take-profit, and partial exit unit tests (Tests 1-4)
complexity: 3
---

# Task: Write stock stop-loss, take-profit, and partial exit unit tests (Tests 1-4)

## Description
Write 4 unit tests covering the core stock bracket and partial exit conditions: (1) stop-loss triggers when candle low breaches entry_price * 0.90, (2) take-profit triggers when candle high breaches entry_price * 1.15, (3) partial take-profit exits 50% shares and sets trailing_stop_active=TRUE, (4) trailing stop triggers at peak_price * 0.93 after partial and closes remaining shares. Use hand-written fixtures with mock candle data and mock position objects.

## Acceptance Criteria
- [ ] Test 1: Stop-loss triggers correctly at candle.low <= stop_loss_price
- [ ] Test 2: Take-profit triggers correctly at candle.high >= take_profit_price
- [ ] Test 3: Partial take-profit exits floor(shares_remaining * 0.50), sets trailing_stop_active=TRUE
- [ ] Test 4: Trailing stop triggers at peak_price * 0.93, closes all remaining shares
- [ ] All tests use pytest with mock positions and mock candle sequences
- [ ] Edge cases: exact trigger price match, prices barely missing triggers

## Technical Notes
- Tests isolate individual exit condition functions (hybrid architecture)
- Mock data should use realistic price levels with known trigger outcomes
- Each test verifies exit_reason, exit_price, and quantity assertions
- Uses hand-written fixtures, not VCR.py (VCR.py for API mocking, not unit tests)

## Dependencies
- Depends on: task-006-002-01, task-006-002-02, task-006-003-01, task-006-003-02
- Blocks: none
