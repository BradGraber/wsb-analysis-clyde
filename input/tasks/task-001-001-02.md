---
id: task-001-001-02
story: story-001-001
epic: epic-001
title: Create tracking, junction, and prediction tables with FK relationships
complexity: 2
---

# Task: Create tracking, junction, and prediction tables with FK relationships

## Description
Add the remaining 10 tables to `schema.sql`: price_history, evaluation_periods, comments, analysis_runs, signal_comments, comment_tickers, position_exits, predictions, prediction_outcomes, and prediction_exits. Include all foreign key relationships with correct ON DELETE behavior (CASCADE on position_exits.position_id, RESTRICT on comments.post_id), self-referential FK on comments.parent_comment_id, UNIQUE constraints on junction tables, and DEFAULT values on predictions and evaluation_periods.

## Acceptance Criteria
- [ ] price_history has UNIQUE(ticker, date) for UPSERT pattern
- [ ] evaluation_periods has FK to portfolios(id), status DEFAULT 'active'
- [ ] comments has FKs to analysis_runs(id), reddit_posts(id), self-referential parent_comment_id -> comments(id) nullable, reddit_id UNIQUE
- [ ] analysis_runs has all 13 columns including current_phase_label, progress_current/total, warnings TEXT
- [ ] signal_comments has UNIQUE(signal_id, comment_id), FKs to signals(id) and comments(id)
- [ ] comment_tickers has UNIQUE(comment_id, ticker), FKs to comments(id)
- [ ] position_exits has FK to positions(id) ON DELETE CASCADE, exit_reason VARCHAR(20)
- [ ] predictions has UNIQUE(comment_id, ticker), FKs to comments(id) and analysis_runs(id), status DEFAULT 'tracking', trailing_stop_active DEFAULT FALSE, created_at NOT NULL
- [ ] prediction_outcomes has UNIQUE(prediction_id, day_offset), FK to predictions(id)
- [ ] prediction_exits has FK to predictions(id), exit_reason VARCHAR(30)
- [ ] Schema file executes without errors on a fresh SQLite database producing all 16 tables

## Technical Notes
- PRD Appendix B lines 2009-2188 define these tables
- comments.parent_comment_id allows NULL for top-level comments
- prediction_exits.exit_reason is VARCHAR(30) not VARCHAR(20) (broader set)
- position_exits ON DELETE CASCADE means deleting a position cascades to its exits
- After writing this task, run `sqlite3 :memory: < schema.sql` to verify no syntax errors

## Files to Create/Modify
- `schema.sql` (append to file from task-001-001-01)
