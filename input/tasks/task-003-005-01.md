---
id: task-003-005-01
story: story-003-005
title: Implement JSON extraction and field validation for AI responses
complexity: 2
---

# Task: Implement JSON extraction and field validation for AI responses

## Description
Create an `src/ai_parser.py` module with a `parse_ai_response(raw_content: str)` function that extracts JSON from the raw GPT-4o-mini response (stripping markdown code fences or extra text), parses it, and validates the 7-field structure. Validates field types, value constraints (sentiment enum, confidence range), and cross-field rules (reasoning_summary null when has_reasoning false, ticker_sentiments count matches tickers count).

## Acceptance Criteria
- [ ] Strips markdown code fences (```json...```) and surrounding whitespace/text before JSON parsing
- [ ] Parses JSON and extracts all 7 fields: tickers, ticker_sentiments, sentiment, sarcasm_detected, has_reasoning, confidence, reasoning_summary
- [ ] Validates sentiment accepts only "bullish", "bearish", "neutral" (case-insensitive, normalized to lowercase)
- [ ] Validates confidence is float; clamps to [0.0, 1.0] range with debug-level log when clamped
- [ ] Validates reasoning_summary is null when has_reasoning is false; logs warning if violated
- [ ] Validates ticker_sentiments array count matches tickers array count; logs warning if mismatch
- [ ] Extra fields beyond the 7 expected are silently ignored
- [ ] Missing required fields raise a validation error (handled by retry logic in story-003-006)
- [ ] Returns a validated `AIAnalysisResult` dataclass with all 7 fields
- [ ] Raises `MalformedResponseError` for unparseable JSON (consumed by story-003-006 retry logic)

## Technical Notes
- Use json.loads() for parsing; catch json.JSONDecodeError
- The stripping logic should handle: bare JSON, ```json\n{...}\n```, "Here is the analysis:\n{...}", etc.
- Consider a regex to extract the first JSON object from the response text
- PRD reference: Appendix E.4 (format), E.5 (field definitions)

## Dependencies
- Depends on: none (pure parsing logic; receives raw string)
- Blocks: task-003-005-02, task-003-006-01
