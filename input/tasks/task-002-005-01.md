---
id: task-002-005-01
story: story-002-005
title: Implement batch author trust score lookup with default fallback
complexity: 2
---

# Task: Implement batch author trust score lookup with default fallback

## Description
Create a `lookup_author_trust_scores(authors: list[str], default_trust: float = 0.5) -> dict[str, float]` function that performs a single batch query against the authors table for all unique usernames in the current run, returning a dict mapping username to trust_score. Authors not found in the database receive the configurable default value (0.5). Apply the resulting scores to each ProcessedComment's author_trust_score field.

## Acceptance Criteria
- [ ] Performs a single batch SELECT query for all unique author usernames (not one query per comment)
- [ ] Returns a dict mapping username -> trust_score (float 0.0-1.0)
- [ ] Authors found in the database return their stored trust_score value
- [ ] Authors NOT found return the default value of 0.5 (configurable via parameter, aligned with CFG-TRUST-WEIGHTS default_accuracy)
- [ ] "[deleted]" authors receive the default trust score (0.5)
- [ ] Each ProcessedComment's author_trust_score field is populated from the lookup result
- [ ] Unit test: known author returns stored trust score (mock DB)
- [ ] Unit test: unknown author returns default 0.5
- [ ] Unit test: batch query with mix of known/unknown authors returns correct mapping

## Technical Notes
- Use a single SQL query: SELECT username, trust_score FROM authors WHERE username IN (?, ?, ...)
- SQLite has a limit on parameter count (~999); for >999 unique authors, batch the query into chunks
- Trust scores change slowly (updated per run by epic-009), so per-run caching is the correct approach
- The authors table is populated by epic-009 (Author Trust Tracker); during early runs, most/all authors will get the 0.5 default
- Uses get_connection() from task-001-004-01
- PRD reference: PIPE-010, Section 3.2.2 Phase 2 step 1 bullet 2, Appendix F.1

## Dependencies
- Depends on: task-002-003-01 (comments must be fetched with author names), task-001-004-01 (DB connection)
- Blocks: task-002-007-01 (priority scoring needs author_trust component)
