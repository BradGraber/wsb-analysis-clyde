---
id: task-004-006-02
story: story-004-006
epic: epic-004
title: Implement Phase 4 pipeline orchestrator integrating all signal detection steps
complexity: 2
---

# Task: Implement Phase 4 pipeline orchestrator integrating all signal detection steps

## Description
Create a `run_signal_detection(conn, analysis_run_id)` orchestrator function that ties together all signal detection components for a single pipeline run. It calls aggregate_comments_by_ticker, then iterates each (ticker, signal_date) group to run Quality and Consensus detection, emergence detection, and persists any fired signals via the UPSERT function. Loads all needed config from system_config once at the start. Loads author trust scores once. Logs summary of signals detected. This is the Phase 4 entry point in the pipeline registry pattern.

## Acceptance Criteria
- [ ] Loads signal thresholds and confidence weights from system_config at start of run (single DB read)
- [ ] Loads author trust scores from authors table at start of run (single DB read)
- [ ] Calls aggregate_comments_by_ticker for the given analysis_run_id
- [ ] For each (ticker, signal_date) group: runs detect_quality_signal and detect_consensus_signal
- [ ] For each ticker: runs detect_emergence (regardless of whether signals fired)
- [ ] Persists fired signals via persist_signal (UPSERT + signal_comments)
- [ ] Emergence-only tickers (emergence detected but no signal fired) logged at INFO level
- [ ] Logs summary at end: N quality signals, M consensus signals, K emergence flags detected
- [ ] Handles empty aggregation gracefully (no comments = no signals, log and return)
- [ ] Fails loudly if required system_config keys are missing (KeyError with descriptive message)

## Technical Notes
- Pipeline registry pattern: this function is registered as the Phase 4 entry point
- Config keys needed: quality_min_confidence, quality_min_users, consensus_min_comments, consensus_min_users, consensus_min_alignment, confidence_weight_volume, confidence_weight_alignment, confidence_weight_ai_confidence, confidence_weight_author_trust, signal_min_confidence
- Author trust dict: {username: trust_score} from authors table; missing authors default to 0.5 in calculate_signal_confidence
- Use structlog for JSON-formatted logging per project conventions
- The orchestrator should not catch exceptions from individual signal functions -- let errors propagate for Tier 2 handling

## Dependencies
- Depends on: task-004-006-01 (persist_signal), task-004-001-01, task-004-002-01, task-004-003-01, task-004-004-01, task-004-005-01
- Blocks: task-004-007-01
