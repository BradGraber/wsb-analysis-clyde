---
id: task-007-007-01
story: story-007-007
title: Add startup recovery to set stale running analysis runs to failed
complexity: 1
---

# Task: Add startup recovery to set stale running analysis runs to failed

## Description
Add recovery logic to the FastAPI lifespan context manager that detects and resolves stale analysis_runs records with status='running' on application startup. This prevents HTTP 409 lockout when the server crashed or restarted during an analysis. Simple UPDATE query with logging. Phase 7b task (Weeks 10-12).

## Acceptance Criteria
- [ ] On startup (within lifespan, after DB connection acquired, before accepting requests): query analysis_runs WHERE status='running'
- [ ] All matching records updated: status='failed', error_message='Recovered from unexpected shutdown', completed_at=UTC now
- [ ] Recovery logged at WARNING level with count and list of recovered run_ids
- [ ] If no stale runs found, log at INFO level: "No stale runs found"
- [ ] Multiple stale runs handled correctly (edge case: previous recovery also failed)
- [ ] Recovery executes before any route handlers are available

## Technical Notes
- SQL: `UPDATE analysis_runs SET status='failed', error_message='Recovered from unexpected shutdown', completed_at=? WHERE status='running'`
- Use RETURNING id (SQLite 3.35+) or a preceding SELECT to get run_ids for logging
- This runs inside the existing lifespan context manager from task-007-001-01; add after DB connection setup
- Trivial implementation: single SQL statement + logging

## Dependencies
- Depends on: task-007-006-01 (POST /analyze creates the 'running' records this recovers)
- Blocks: none
