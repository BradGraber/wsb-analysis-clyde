---
id: task-005-009-02
story: story-005-009
title: Write replacement flow and cash guard integration tests
complexity: 2
---

# Task: Write replacement flow and cash guard integration tests

## Description
Write integration-style unit tests covering the position replacement close-then-open flow end-to-end and the cash guard preventing overdraft scenarios. Verify transaction atomicity, correct position_exits records, portfolio cash accounting, and the replacement safeguard (unrealized gain > +5%). Uses hand-written fixtures and in-memory SQLite.

## Acceptance Criteria
- [ ] Test: full replacement flow -- position_exits INSERT, position status='closed', portfolio cash += exit_proceeds, new position opened
- [ ] Test: replacement blocked when lowest position has unrealized_gain > +5%
- [ ] Test: all 10 positions have > +5% gain -- no replacement possible, signal rejected
- [ ] Test: cash guard skips position when cash_available < position_size, pipeline continues to next portfolio
- [ ] Test: cascading cash depletion -- after opening several positions, subsequent ones correctly skipped when cash runs out
- [ ] Test: replacement transaction rollback -- if any DB step fails, no partial state remains
- [ ] Test: portfolio current_value correctly reflects cash + open position MTM after opens and closes
- [ ] Hand-written fixtures for portfolio state, position records, and signal data
- [ ] In-memory SQLite with full schema for all tests

## Technical Notes
- This tests the integration of task-005-004-01, task-005-004-02, and task-005-007-01
- The "all winners" edge case (10 positions all > +5% gain) is explicitly called out in epic risk assessment
- Transaction atomicity is critical: use SQLite's built-in transaction support, verify with intentional failure injection
- Fixtures should cover portfolios at various fill levels (0, 5, 9, 10 positions)
- Cash guard tests should simulate realistic scenarios with portfolio_value = $100,000

## Dependencies
- Depends on: task-005-008-01 (all position management implementation complete)
- Blocks: none
