---
id: task-007-010-02
story: story-007-010
title: Write Phase 7b API tests (analyze lifecycle, recovery, manual close)
complexity: 2
---

# Task: Write Phase 7b API tests (analyze lifecycle, recovery, manual close)

## Description
Write the second set of API unit tests covering Phase 7b mutation endpoints: POST /analyze success and concurrent rejection, startup recovery behavior, and manual position close validation and success. These tests exercise the async pipeline trigger, single-run enforcement, and transactional position close logic.

## Acceptance Criteria
- [ ] Test 5 (concurrent 409 rejection): insert analysis_run with status='running', POST /analyze; verify HTTP 409 with ANALYSIS_ALREADY_RUNNING and active run_id
- [ ] Test 6 (POST /analyze success): POST /analyze when no active run; verify HTTP 202 with run_id in data
- [ ] Test 7 (startup recovery): insert analysis_run with status='running', invoke startup/lifespan logic; verify status changed to 'failed' with error message
- [ ] Test 8 (manual close validation): POST /positions/{id}/close with missing reason; verify VALIDATION_ERROR
- [ ] Test 9 (manual close success): POST /positions/{id}/close with valid payload; verify position_exits record created with exit_reason='manual_close', portfolio cash updated, position shares_remaining updated
- [ ] All tests use FastAPI TestClient with test database; no external API calls
- [ ] Total test suite (task-007-010-01 + this task) runs in under 10 seconds

## Technical Notes
- Test 5: INSERT INTO analysis_runs (status) VALUES ('running') before making the POST request
- Test 6: may need to mock the background thread to prevent actual pipeline execution; use `unittest.mock.patch` on the thread spawn
- Test 7: trigger startup recovery by calling the recovery function directly or by re-initializing the lifespan
- Test 9: create an open position with seed data, POST close, then verify: SELECT from position_exits, SELECT from positions (shares_remaining), SELECT from portfolios (cash_available)
- These 5 tests correspond to tests 5, 6, 7, 8, 9 from story-007-010 acceptance criteria

## Dependencies
- Depends on: task-007-006-01 (POST /analyze), task-007-007-01 (startup recovery), task-007-008-01 (manual close)
- Blocks: none
