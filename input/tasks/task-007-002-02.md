---
id: task-007-002-02
story: story-007-002
title: Override FastAPI default exception handlers for envelope compliance
complexity: 1
---

# Task: Override FastAPI default exception handlers for envelope compliance

## Description
Register custom exception handlers on the FastAPI app so that all error responses (404, 422 validation errors, 500 internal errors) use the standard error envelope format instead of FastAPI's defaults. This ensures the Vue frontend receives a consistent error shape regardless of how the error originated. Phase 7a task (Weeks 2-3).

## Acceptance Criteria
- [ ] `RequestValidationError` handler returns 422 with `{error: {code: "VALIDATION_ERROR", message: <details>}}`
- [ ] `HTTPException` handler returns the exception's status code with `{error: {code: <mapped_code>, message: <detail>}}`
- [ ] Unhandled exceptions return 500 with `{error: {code: "DATABASE_ERROR", message: "Internal server error"}}` (no stack trace leaked)
- [ ] Unhandled exceptions are logged at ERROR level with full stack trace via structlog
- [ ] All error responses include `Content-Type: application/json`
- [ ] FastAPI's auto-generated 404 for unknown routes uses the error envelope format

## Technical Notes
- Use `@app.exception_handler(RequestValidationError)` and `@app.exception_handler(HTTPException)`
- Add a catch-all `@app.exception_handler(Exception)` for unexpected errors
- Map HTTPException status codes to error codes: 404->NOT_FOUND, 409->ANALYSIS_ALREADY_RUNNING, etc.
- Validation error messages should extract field-level details from Pydantic's error list for developer-friendly messages

## Dependencies
- Depends on: task-007-002-01 (ErrorEnvelope model and error code constants)
- Blocks: task-007-003-01 through task-007-003-04
