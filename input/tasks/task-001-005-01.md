---
id: task-001-005-01
story: story-001-005
epic: epic-001
title: Implement schema validation script checking tables, columns, config, and portfolios
complexity: 2
---

# Task: Implement schema validation script checking tables, columns, config, and portfolios

## Description
Create `scripts/validate_schema.py` that verifies the database is correctly initialized. The script checks: (1) all 16 tables exist via sqlite_master, (2) each table has expected key columns via PRAGMA table_info, (3) all 34 system_config keys are present, (4) 4 portfolio rows exist with correct values, (5) PRAGMA foreign_keys returns 1, and (6) PRAGMA journal_mode returns 'wal'. Output a clear pass/fail summary and exit with code 0 (all pass) or 1 (any fail).

## Acceptance Criteria
- [ ] Verifies all 16 tables exist by name, reports any missing
- [ ] For each table, checks at least the column count and key column names
- [ ] Verifies all 34 system_config keys are present, reports any missing keys by name
- [ ] Verifies 4 portfolio rows with correct name/instrument_type/signal_type combinations
- [ ] Verifies PRAGMA foreign_keys returns 1
- [ ] Verifies PRAGMA journal_mode returns 'wal'
- [ ] Outputs clear pass/fail for each check (e.g., "PASS: All 16 tables present" or "FAIL: Missing table 'prediction_exits'")
- [ ] Exit code 0 when all pass, exit code 1 when any fail
- [ ] Uses connection manager from db.py (story-001-004)

## Technical Notes
- Use `SELECT name FROM sqlite_master WHERE type='table'` for table list
- Use `PRAGMA table_info(table_name)` for column inspection
- Use `SELECT key FROM system_config` and compare against hardcoded expected list of 34 keys
- Expected 34 keys: system_start_date, phase, quality_min_users, quality_min_confidence, consensus_min_comments, consensus_min_users, consensus_min_alignment, confidence_weight_volume, confidence_weight_alignment, confidence_weight_ai_confidence, confidence_weight_author_trust, trust_weight_quality, trust_weight_accuracy, trust_weight_tenure, trust_default_accuracy, trust_tenure_saturation_days, accuracy_ema_weight, stock_stop_loss_pct, stock_take_profit_pct, stock_trailing_stop_pct, stock_breakeven_trigger_pct, stock_breakeven_min_days, stock_time_stop_base_days, stock_time_stop_base_min_gain, stock_time_stop_extended_days, stock_time_stop_max_days, stock_take_profit_exit_pct, option_stop_loss_pct, option_take_profit_pct, option_trailing_stop_pct, option_time_stop_days, option_expiration_protection_dte, option_take_profit_exit_pct, signal_min_confidence
- Runnable as `python scripts/validate_schema.py` or `python -m scripts.validate_schema`

## Files to Create/Modify
- `scripts/validate_schema.py` (new file)
