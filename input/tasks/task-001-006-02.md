---
id: task-001-006-02
story: story-001-006
epic: epic-001
title: Implement Schwab token refresh logic with proactive and 401-retry strategies
complexity: 2
---

# Task: Implement Schwab token refresh logic with proactive and 401-retry strategies

## Description
Create a `src/schwab_client.py` module with a SchwabClient class that loads tokens from `./data/schwab_token.json`, proactively refreshes the access token before expiration (when remaining TTL < 5 minutes), handles 401 responses with immediate refresh + single retry, and logs an error with re-authentication instructions when the refresh token is expired (inactive > 7 days). Provide a generic `_request()` method wrapping requests with token management.

## Acceptance Criteria
- [ ] SchwabClient loads tokens from ./data/schwab_token.json on initialization
- [ ] Before each API call, checks if access token expires within 5 minutes and proactively refreshes
- [ ] On 401 response, immediately refreshes access token and retries the request once
- [ ] If refresh token is expired (7+ days), logs ERROR with message instructing user to re-run schwab_setup.py
- [ ] Updated tokens are written back to ./data/schwab_token.json after refresh (maintaining chmod 600)
- [ ] _request(method, url, **kwargs) method handles GET/POST with automatic token management

## Technical Notes
- Access token TTL ~30 minutes; refresh via POST to Schwab token endpoint with grant_type=refresh_token
- Refresh token TTL ~7 days; if expired, no automated recovery (user must re-authorize)
- Use expires_at timestamp comparison for proactive refresh
- On token refresh, update both access_token and expires_at in the JSON file
- This client is consumed by epic-005 (position entry) and epic-006 (price monitoring)
- Keep the client focused on auth; API-specific methods (get_quote, get_options_chain) are in the next task

## Files to Create/Modify
- `src/schwab_client.py` (new module)
