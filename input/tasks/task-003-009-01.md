---
id: task-003-009-01
story: story-003-009
title: Insert comment_tickers junction records within batch transaction
complexity: 2
---

# Task: Insert comment_tickers junction records within batch transaction

## Description
For each AI-extracted ticker-sentiment pair from the parsed response, INSERT a record into the comment_tickers junction table within the batch-of-5 transaction (task-003-008-01). Uses INSERT OR IGNORE to handle the UNIQUE(comment_id, ticker) constraint gracefully. Comments with empty tickers arrays produce zero junction inserts.

## Acceptance Criteria
- [ ] For each entry in ticker_sentiments array: INSERT OR IGNORE INTO comment_tickers (comment_id, ticker, sentiment)
- [ ] comment_id is the database id from the comments table (not reddit_id)
- [ ] Ticker values stored as uppercase (already normalized by task-003-005-02)
- [ ] INSERT OR IGNORE handles UNIQUE(comment_id, ticker) constraint without error
- [ ] Empty tickers array results in zero inserts (valid per Appendix E.9)
- [ ] All junction inserts are within the same transaction as the parent comment INSERT/UPDATE (task-003-008-01)
- [ ] Unit test: 3 tickers produce 3 junction records
- [ ] Unit test: empty tickers produce 0 junction records
- [ ] Unit test: duplicate ticker in response produces 1 junction record (OR IGNORE)

## Technical Notes
- Schema: comment_tickers(id INTEGER PRIMARY KEY, comment_id INTEGER FK, ticker VARCHAR, sentiment VARCHAR) with UNIQUE(comment_id, ticker)
- Per-ticker sentiment from ticker_sentiments may differ from overall comment sentiment (e.g., bullish NVDA but bearish AMD)
- Junction table feeds Phase 4 signal detection and Phase 3.5 prediction creation
- PRD reference: PIPE-021, FR-021

## Dependencies
- Depends on: task-003-005-02 (normalized tickers), task-003-008-01 (transaction boundary)
- Blocks: none
