---
id: task-006-003-01
story: story-006-003
title: Implement stock partial take-profit exit logic
complexity: 2
---

# Task: Implement stock partial take-profit exit logic

## Description
Implement the logic that, when take-profit is detected at +15% gain, exits exactly 50% of shares_remaining (rounded down for odd counts) and activates the trailing stop by setting trailing_stop_active=TRUE on the position. This function wraps the take-profit detection from story-006-002 with the partial exit quantity calculation and trailing stop activation.

## Acceptance Criteria
- [ ] At take-profit trigger, exits floor(shares_remaining * 0.50) shares
- [ ] Sets trailing_stop_active = TRUE on the position after partial exit
- [ ] Exit reason is 'take_profit' for the partial exit record
- [ ] Calls partial exit mechanics (story-006-009) to create exit record and update position
- [ ] Handles odd share counts correctly (floor rounding: 7 shares -> 3 exited)

## Technical Notes
- FR-027: At +15% gain, exit 50% position and apply trailing stop to remainder
- Partial exit mechanics (INSERT position_exits, UPDATE shares_remaining, UPDATE cash) delegated to story-006-009
- This function orchestrates: detect take-profit -> calculate 50% quantity -> call partial exit -> set trailing_stop_active
- The trailing stop activation state persists on the position for subsequent monitoring cycles

## Dependencies
- Depends on: task-006-002-02 (take-profit detection), task-006-009-01 (partial exit mechanics), task-006-010-01 (peak tracking)
- Blocks: none
