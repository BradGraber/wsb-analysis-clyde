---
id: task-002-002-02
story: story-002-002
title: Implement GPT-4o-mini vision analysis with retry logic and graceful degradation
complexity: 2
---

# Task: Implement GPT-4o-mini vision analysis with retry logic and graceful degradation

## Description
Add an `analyze_post_image(image_url: str) -> Optional[str]` function that sends an image URL to the OpenAI GPT-4o-mini vision API to extract visual context (charts, earnings data, tickers from screenshots). Uses retry_with_backoff from epic-001 with custom delays [2, 5, 10] seconds. On complete failure after 3 retries, logs a warning and returns None for graceful degradation. Integrate with fetch_hot_posts to populate image_url and image_analysis on ProcessedPost objects.

## Acceptance Criteria
- [ ] Calls OpenAI GPT-4o-mini vision API with the image URL (not downloaded bytes) and a prompt requesting chart/earnings/ticker extraction
- [ ] On success, returns the vision API response text (image analysis description)
- [ ] On failure (network error, API error, timeout), retries up to 3 times with delays of 2s, 5s, 10s using retry_with_backoff
- [ ] After 3 failed retries: logs warning "Image analysis failed for post {reddit_id}: {error}" via structlog, returns None
- [ ] Posts without detected image URLs skip the API call entirely (no wasted requests)
- [ ] Successfully analyzed posts have both image_url and image_analysis populated on ProcessedPost
- [ ] Failed or skipped posts have image_analysis=None on ProcessedPost
- [ ] Unit test: successful vision API call returns analysis text (mock OpenAI)
- [ ] Unit test: 3 failures trigger warning log and return None (mock OpenAI + mock sleep)

## Technical Notes
- Uses retry_with_backoff from task-001-008-01 with custom delay list [2, 5, 10]
- The OpenAI client should use OPENAI_API_KEY from environment variables
- Image analysis is synchronous and occurs before comment fetching (Phase 1 order)
- Only ~10 posts max, so synchronous per-post analysis is acceptable
- The analysis text becomes image_context in the AI prompt (epic-003, Appendix E.1)
- PRD reference: PIPE-004, FR-046, ERR-IMAGE-FAIL, Appendix E.9

## Dependencies
- Depends on: task-002-002-01 (image URL detection), task-001-008-01 (retry_with_backoff)
- Blocks: none (image analysis is supplementary; pipeline continues regardless)
