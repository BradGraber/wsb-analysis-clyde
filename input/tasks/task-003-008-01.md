---
id: task-003-008-01
story: story-003-008
title: Implement batch-of-5 transaction commit with rollback handling
complexity: 2
---

# Task: Implement batch-of-5 transaction commit with rollback handling

## Description
Implement a `commit_analysis_batch(db_conn, batch_results)` function that commits each batch of 5 analyzed comments in a single SQLite transaction. The transaction includes INSERT/UPDATE of comment AI annotations (sentiment, sarcasm_detected, has_reasoning, confidence, reasoning_summary, author_trust_score, analysis_run_id) and comment_tickers junction inserts (task-003-009-01). On transaction failure, ROLLBACK the entire batch and log the error.

## Acceptance Criteria
- [ ] Each batch of 5 comments committed in a single transaction: BEGIN, INSERT/UPDATE all comments, INSERT comment_tickers, COMMIT
- [ ] Transaction includes all comment AI annotation fields plus author_trust_score and analysis_run_id
- [ ] On SQLite error during any INSERT/UPDATE: ROLLBACK entire batch
- [ ] Rolled-back batch logged via structlog ERROR with batch comment reddit_ids and error details
- [ ] Rolled-back comments are NOT retried (AI cost already spent; will be picked up on next run via dedup miss)
- [ ] Commit boundary aligns exactly with ThreadPoolExecutor batch boundary (all 5 responses collected before commit)
- [ ] Final partial batch (fewer than 5 comments) also committed in a single transaction
- [ ] Unit test: successful 5-comment batch commits all records
- [ ] Unit test: SQLite error triggers rollback and logging, no records persisted from that batch

## Technical Notes
- Use SQLite `with conn:` context manager for automatic commit/rollback, or explicit BEGIN/COMMIT/ROLLBACK
- The transaction must include both comments table and comment_tickers inserts (atomic)
- Maximum data loss on crash: 5 comments' AI cost (~$0.03) -- acceptable per PRD
- PRD reference: PIPE-020, Section 3.2.2 Phase 3 step 2 bullet 5

## Dependencies
- Depends on: task-003-004-01 (produces batch results to commit)
- Blocks: task-003-009-01 (junction inserts within same transaction), task-003-007-01 (trust snapshot included in commit)
