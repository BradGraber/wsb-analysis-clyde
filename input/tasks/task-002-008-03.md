---
id: task-002-008-03
story: story-002-008
title: Implement atomic post and comment storage with transaction handling
complexity: 2
---

# Task: Implement atomic post and comment storage with transaction handling

## Description
Create `store_posts_and_comments(posts: list[ProcessedPost], run_id: int, duplicate_ids: set[str]) -> None` that inserts new posts into reddit_posts and new (non-duplicate) comments into the comments table within a database transaction. Each post and its comments are stored atomically. Transaction failures for one post log the error and continue to the next post. Parent chain data is serialized as JSON for storage.

## Acceptance Criteria
- [ ] New posts are inserted into reddit_posts with all fields: reddit_id, title, selftext, upvotes, total_comments, image_url, image_analysis
- [ ] New comments (not in duplicate_ids set) are inserted into comments table with all metadata: post_id (FK), reddit_id (UNIQUE), author, body, score, depth, created_utc, priority_score, financial_score, author_trust_score, parent_chain (JSON)
- [ ] Duplicate comments (in duplicate_ids set) are skipped for INSERT (already handled by dedup task)
- [ ] Each post + its comments are wrapped in a single database transaction for atomicity
- [ ] If a transaction fails (e.g., constraint violation), the error is logged via structlog and processing continues to the next post
- [ ] parent_chain is serialized as a JSON string before INSERT (list of ParentChainEntry dicts)
- [ ] Handles the case where a reddit_post already exists (UPDATE or INSERT OR IGNORE based on reddit_id UNIQUE constraint)
- [ ] Unit test: insert a post with 3 comments, verify all records in DB
- [ ] Unit test: transaction failure on one post does not prevent storage of other posts
- [ ] Unit test: duplicate comments are skipped during insert

## Technical Notes
- Use sqlite3 connection.execute() within a transaction (conn.commit() on success, conn.rollback() on failure)
- parent_chain serialization: json.dumps([entry.to_dict() for entry in comment.parent_chain])
- Post reddit_id has UNIQUE constraint; on re-runs, use INSERT OR REPLACE or check existence first
- Reddit outage handling (ERR-REDDIT-OUTAGE) is at the fetch level (task-002-001), not storage level
- Uses get_connection() from task-001-004-01
- PRD reference: PIPE-007, CFG-INTERNAL-DATA

## Dependencies
- Depends on: task-002-007-01 (scored and selected comments), task-002-008-01 (data models), task-002-008-02 (dedup results), task-001-004-01 (DB connection)
- Blocks: task-002-009-01 (tests need storage implementation)
