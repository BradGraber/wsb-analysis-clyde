---
id: task-003-004-01
story: story-003-004
title: Implement ThreadPoolExecutor batch orchestrator for concurrent AI calls
complexity: 5
---

# Task: Implement ThreadPoolExecutor batch orchestrator for concurrent AI calls

## Description
Create an `src/ai_batch.py` module with a `process_comments_in_batches(comments, openai_client, prompt_builder, db_conn)` function that groups non-deduplicated comments into batches of 5 and processes each batch concurrently using ThreadPoolExecutor(max_workers=5). Each worker sends one comment to OpenAI (1 comment per API call per AI-INDIVIDUAL). Results are collected before proceeding to the next batch. Failed individual workers do not cancel the remaining workers in the batch.

## Acceptance Criteria
- [ ] ThreadPoolExecutor configured with max_workers=5
- [ ] Comments are grouped into batches of 5; final batch may have fewer than 5
- [ ] Each worker receives a fully rendered prompt (system + user) and sends one API call via OpenAI client
- [ ] All workers in a batch complete before proceeding to the next batch (using concurrent.futures.as_completed or wait)
- [ ] If one worker raises an exception, remaining workers complete normally; failed comment is logged with reddit_id and error details
- [ ] Each batch returns a list of (comment, result_or_error) tuples for downstream processing
- [ ] Progress counter updated after each batch completes: logs "Processed batch {n}/{total}: {completed} comments complete"
- [ ] Batch orchestrator tracks comment-to-worker mapping for error attribution

## Technical Notes
- ThreadPoolExecutor was chosen over asyncio per planning decision qc-sd-002 for simplicity with the synchronous openai SDK
- Use `concurrent.futures.as_completed()` to collect results and handle per-worker exceptions
- Each worker function: build_prompt -> send_chat_completion -> return (comment, raw_response)
- Batch size of 5 aligns with commit granularity (story-003-008)
- Expected: ~500 comments / 5 = 100 batches, ~2-4 minutes total at 1-2s per call
- PRD reference: PIPE-017, AI-INDIVIDUAL, Section 3.2.2 Phase 3 step 2 bullet 3

## Dependencies
- Depends on: task-003-001-01 (OpenAI client), task-003-002-01 (prompt templates), task-003-002-02 (parent chain formatter), task-003-003-02 (filtered comment list)
- Blocks: task-003-005-01, task-003-008-01
