---
id: task-009-002-01
story: story-009-002
title: Implement author metrics upsert pipeline step (Phase 7a)
complexity: 2
---

# Task: Implement author metrics upsert pipeline step (Phase 7a)

## Description
Create the Phase 7a pipeline step that processes each unique author from the current analysis run. For each author: upsert into the authors table (INSERT on first encounter with first_seen=now, or UPDATE existing). Increment total_comments, high_quality_comments (where has_reasoning=true), total_upvotes. Update last_active timestamp. Initialize flagged_comments to 0 for new authors (not incremented in Phase 1). Uses INSERT OR UPDATE (upsert) keyed on author username. PRD Section 3.2.2 lines 370-381.

## Acceptance Criteria
- [ ] For each unique author in the current run, total_comments incremented by count of new comments from that author
- [ ] high_quality_comments incremented only for comments where has_reasoning=true
- [ ] total_upvotes incremented by sum of upvotes across new comments per author
- [ ] last_active updated to current timestamp for every author with new comments
- [ ] New authors inserted with first_seen=current timestamp, all counters initialized from current run data
- [ ] flagged_comments initialized to 0 for new authors, not incremented in Phase 1
- [ ] Upsert is keyed on author username -- idempotent for re-runs of the same data

## Technical Notes
- Author identification: JOIN comments to comment authors, GROUP BY unique author
- Depends on epic-003 annotations (has_reasoning, ai_confidence) being present on comments
- This step runs after Phase 6 (exit monitoring) and before evaluation period management
- The upsert pattern: INSERT ... ON CONFLICT(username) DO UPDATE SET total_comments = total_comments + excluded.total_comments, ...
- flagged_comments is populated but unused in Phase 1 per TRUST-FLAGGED; flagging logic deferred to Phase 2

## Dependencies
- Depends on: epic-001 (authors table schema), epic-003 (AI annotations on comments)
- Blocks: task-009-002-02
