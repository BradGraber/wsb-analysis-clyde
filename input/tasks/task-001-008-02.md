---
id: task-001-008-02
story: story-001-008
epic: epic-001
title: Implement WarningsCollector class with thread-safe append and JSON serialization
complexity: 2
---

# Task: Implement WarningsCollector class with thread-safe append and JSON serialization

## Description
Add a `WarningsCollector` class to `src/errors.py` that accumulates non-fatal warning events during an analysis run. It provides `append(warning_type, message, context)` to add warnings and `to_json()` to serialize as a JSON array string (returning None if empty). The append method must be thread-safe via an internal lock. Supports all 7 warning types defined in PRD PIPE-055.

## Acceptance Criteria
- [ ] `WarningsCollector()` initializes with an empty warnings list
- [ ] `append(warning_type: str, message: str, context: dict)` adds a warning with type, message, timestamp (ISO format), and context
- [ ] `to_json() -> Optional[str]` returns JSON array string of all warnings, or None if no warnings collected
- [ ] Supports 7 warning types: schwab_stock_unavailable, schwab_options_unavailable, image_analysis_failed, market_hours_skipped, insufficient_cash, schwab_prediction_unavailable, prediction_strike_unavailable
- [ ] append() is thread-safe (uses threading.Lock internally)
- [ ] Unit test: to_json() returns None when empty
- [ ] Unit test: single warning serializes correctly with all 4 fields
- [ ] Unit test: multiple warnings from multiple threads produce correct JSON

## Technical Notes
- Warning JSON structure per PIPE-056: [{"type": "...", "message": "...", "timestamp": "2026-...", "context": {...}}, ...]
- Use json.dumps() for serialization
- Use datetime.utcnow().isoformat() for timestamp
- Thread safety: wrap self._warnings list access with threading.Lock
- When analysis_runs.warnings is written, NULL means no warnings (not empty array "[]")
- Warning type validation is optional (can validate or just document expected types)

## Files to Create/Modify
- `src/errors.py` (add WarningsCollector class)
- `tests/test_errors.py` (add WarningsCollector tests)
