---
id: task-006-018-01
story: story-006-018
title: Write concurrency unit tests for ThreadPoolExecutor Schwab fetching
complexity: 2
---

# Task: Write concurrency unit tests for ThreadPoolExecutor Schwab fetching

## Description
Write 2 unit tests validating concurrent Schwab quote fetching via ThreadPoolExecutor: (1) happy path with 40 concurrent ticker requests all succeeding, (2) mixed success/failure where some tickers fail and trigger retry/fallback without cross-contamination. Both tests use mocked Schwab API responses with no real network calls. Verify ThreadPoolExecutor is used and no shared mutable state issues.

## Acceptance Criteria
- [ ] Test 1: ThreadPoolExecutor dispatches concurrent requests for 40 tickers, all results collected
- [ ] Test 2: Mixed success/failure with per-ticker retry/fallback, no cross-contamination
- [ ] Both tests use unittest.mock to patch Schwab client (no real network calls)
- [ ] Tests verify ThreadPoolExecutor usage
- [ ] Tests assert no shared mutable state issues between threads

## Technical Notes
- PIPE-051: Concurrent Schwab quote fetches using ThreadPoolExecutor
- Test 1: all 40 quotes succeed concurrently
- Test 2: some fail (triggering retry + yfinance fallback), others succeed, no interference
- Use unittest.mock to patch Schwab client, verify correct result aggregation
- Consider using concurrent.futures.wait() assertions for completion

## Dependencies
- Depends on: task-006-013-01, task-006-013-02 (retry and fallback logic)
- Blocks: none
