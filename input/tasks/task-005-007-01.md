---
id: task-005-007-01
story: story-005-007
title: Implement cash guard check with insufficient-funds handling
complexity: 1
---

# Task: Implement cash guard check with insufficient-funds handling

## Description
Implement the pre-opening cash availability check: before any position is opened, verify that portfolio cash_available >= position_size. If insufficient, skip that portfolio's position with a warning log and continue to the next portfolio. Also handle edge cases where position_size exceeds the price of a single share (stocks) or single contract (options).

## Acceptance Criteria
- [ ] Checks cash_available >= position_size before each position open attempt
- [ ] If insufficient cash, logs: "Insufficient cash in {portfolio_name}: need ${position_size}, have ${cash_available}"
- [ ] Skips that portfolio and continues to next portfolio for the same signal
- [ ] For stocks: skips if floor(position_size / entry_price) results in 0 shares
- [ ] For options: skips if mark_price * 100 > position_size (cannot afford 1 contract)
- [ ] Returns boolean indicating whether position can proceed
- [ ] Unit tests: sufficient cash, insufficient cash, zero-share edge case, single-contract edge case

## Technical Notes
- PIPE-037 requirement
- Cash check must happen BEFORE any position INSERT to prevent overdraft
- This is a simple guard function called per portfolio in the position opening loop
- Cash_available is read from the portfolios table for the specific target portfolio
- The guard is independent per portfolio: failure in one does not affect others

## Dependencies
- Depends on: task-005-003-01 (position_size as input)
- Blocks: task-005-007-02
