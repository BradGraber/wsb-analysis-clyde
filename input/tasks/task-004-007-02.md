---
id: task-004-007-02
story: story-004-007
epic: epic-004
title: Write unit tests for confidence calculation, emergence detection, and daily rollup UPSERT
complexity: 2
---

# Task: Write unit tests for confidence calculation, emergence detection, and daily rollup UPSERT

## Description
Write unit tests covering the confidence calculation formula (known inputs with default weights), emergence detection (threshold crossing and warmup period), daily rollup UPSERT behavior (create then update), signal_comments junction population, and position_opened preservation. Use hand-written fixtures and in-memory SQLite. References FR-040, FR-019, FR-039.

## Acceptance Criteria
- [ ] Confidence calculation test: known inputs with default weights (0.25/0.25/0.30/0.20) produce expected confidence value within floating-point tolerance (abs diff < 1e-6)
- [ ] Emergence detection test: prior_mentions=2, current_mentions=13, current_users=8 fires emergence (True)
- [ ] Emergence detection test: prior_mentions=3 does NOT fire emergence (False)
- [ ] Emergence warmup test: system with fewer than 7 days of history returns None (not False)
- [ ] Daily rollup test: first UPSERT creates signal record with position_opened=false
- [ ] Daily rollup test: second UPSERT on same (ticker, signal_type, signal_date) updates without creating duplicate
- [ ] signal_comments junction test: contributing comments are linked to signal after persist
- [ ] signal_comments re-link test: on update, old associations replaced with new set
- [ ] position_opened preservation test: UPSERT after position_opened=true does NOT reset to false
- [ ] All tests use hand-written fixtures and in-memory SQLite with full schema

## Technical Notes
- Confidence test: e.g., volume_score=0.333, alignment_score=1.0, avg_ai_confidence=0.8, avg_author_trust=0.5 -> compute expected: 0.333*0.25 + 1.0*0.25 + 0.8*0.30 + 0.5*0.20 = 0.08325 + 0.25 + 0.24 + 0.10 = 0.67325
- For UPSERT tests: insert a signal, then insert again with same (ticker, signal_type, signal_date) but different values, verify only one row exists with updated values
- For position_opened test: manually UPDATE position_opened=true between two UPSERT calls
- Emergence tests need to set up analysis_runs and comment_tickers spanning multiple days
- Use pytest fixtures for shared database setup (schema creation, seed data)

## Dependencies
- Depends on: task-004-004-01, task-004-005-01, task-004-006-01, task-004-006-02 (all logic implemented)
- Blocks: none
