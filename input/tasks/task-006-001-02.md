---
id: task-006-001-02
story: story-006-001
title: Implement tiered price data fetching and candle merge
complexity: 5
---

# Task: Implement tiered price data fetching and candle merge

## Description
Build the tiered price data fetching function that selects the appropriate data sources based on the gap between last_check_time and now (PIPE-043). Same-day: fetch Schwab 5-min candles only. Multi-day gap: fetch yfinance daily OHLC for missed calendar days plus Schwab 5-min candles for today. Normalize all candle data into a unified format (open, high, low, close, timestamp) and merge into a single chronologically-sorted list. Populate a per-run in-memory cache keyed by ticker for downstream prediction monitoring reuse.

## Acceptance Criteria
- [ ] Same-day path fetches only Schwab 5-min candle data
- [ ] Multi-day gap path fetches yfinance daily OHLC for missed days plus Schwab for today
- [ ] All candles normalized to uniform structure: open, high, low, close, timestamp
- [ ] Merged list sorted chronologically (oldest first)
- [ ] Empty candle list returned (no error) when no price data available for a ticker
- [ ] Per-run ticker cache populated for prediction monitoring reuse
- [ ] If both Schwab AND yfinance fail for a ticker, skip with warning logged
- [ ] Unit tests cover same-day, multi-day, and no-data scenarios

## Technical Notes
- PIPE-043: Tiered strategy based on gap size
- FR-031: Schwab 5-min candles for intraday, yfinance daily OHLC for gaps
- INT-YFINANCE: No auth required, use yfinance library
- Schwab client consumed from epic-001
- Cache is dict[str, list[Candle]] populated during real position fetch, consumed by story-006-019
- Candle normalization must abstract away source differences (yfinance vs Schwab field names)

## Dependencies
- Depends on: task-006-001-01 (last_check_time), epic-001 (Schwab client)
- Blocks: task-006-008-01, task-006-012-01
