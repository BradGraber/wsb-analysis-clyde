---
id: task-001-004-01
story: story-001-004
epic: epic-001
title: Implement get_connection context manager with FK enforcement and WAL verification
complexity: 2
---

# Task: Implement get_connection context manager with FK enforcement and WAL verification

## Description
Create a `db.py` module providing a `get_connection()` context manager that returns an SQLite connection with PRAGMA foreign_keys = ON executed on every connection. The function accepts an optional db_path parameter (default from environment variable DB_PATH or `./data/wsb.db`). On first use, verify WAL mode is active. Implement as a context manager that automatically closes the connection on exit.

## Acceptance Criteria
- [ ] `get_connection(db_path=None)` returns a context manager yielding an sqlite3.Connection
- [ ] Every connection has `PRAGMA foreign_keys = ON` executed before yielding
- [ ] WAL mode is verified (set if not already active) via `PRAGMA journal_mode = WAL`
- [ ] Default db_path reads from `DB_PATH` environment variable, falling back to `./data/wsb.db`
- [ ] Connection is closed in the `__exit__` method (or finally block)
- [ ] Uses `check_same_thread=False` for cross-thread compatibility
- [ ] `with get_connection() as conn:` pattern works correctly

## Technical Notes
- Python sqlite3 requires PRAGMA foreign_keys = ON on every new connection (not persistent)
- WAL mode is persistent once set on the database file, but verify on first connection
- Use @contextmanager from contextlib for simple implementation
- The data/ directory should be created if it does not exist (os.makedirs)
- This module will be imported by virtually every other module in the project

## Files to Create/Modify
- `src/db.py` (new module)
