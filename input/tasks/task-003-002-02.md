---
id: task-003-002-02
story: story-003-002
title: Implement parent chain formatting for conversation context
complexity: 2
---

# Task: Implement parent chain formatting for conversation context

## Description
Implement a `format_parent_chain(parent_chain)` function that converts a list of ParentChainEntry objects (from Phase 2 ProcessedComment) into a readable threaded context string for the AI prompt. Each entry includes depth, author, and body. The formatted output shows the conversation hierarchy for the AI to understand reply context.

## Acceptance Criteria
- [ ] `format_parent_chain(parent_chain: list)` returns a formatted string showing threaded context
- [ ] Each entry displays depth, author username, and comment body (e.g., "Reply to user123 (depth 1): 'I think NVDA...'")
- [ ] Entries are ordered from deepest ancestor to immediate parent (chronological reading order)
- [ ] Empty parent_chain (top-level comment) returns empty string or None
- [ ] Long parent comment bodies are truncated to a reasonable length (e.g., 200 chars) to manage prompt token usage
- [ ] Unit test: formats multi-level parent chain correctly
- [ ] Unit test: returns empty string for top-level comment (no parents)
- [ ] Unit test: truncates long parent body text

## Technical Notes
- Parent chain comes from ProcessedComment.parent_chain defined in Appendix D.1/D.3
- Format example: "Reply to user123 (depth 1): 'I think NVDA...' -> Reply to trader456 (depth 0): 'Original comment...'"
- Token budget: parent chain context should not dominate the prompt; truncation prevents excessive token usage
- PRD reference: Appendix E.3 (parent_chain_formatted placeholder)

## Dependencies
- Depends on: none (pure formatting function)
- Blocks: task-003-004-01 (prompt building needs parent chain formatter)
