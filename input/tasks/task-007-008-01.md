---
id: task-007-008-01
story: story-007-008
title: Implement POST /positions/{id}/close with validation, partial/full close, and transactional updates
complexity: 2
---

# Task: Implement POST /positions/{id}/close with validation, partial/full close, and transactional updates

## Description
Implement the manual position close endpoint that validates the request (reason required, quantity_pct in (0,1]), creates a position_exits record, updates the position's remaining quantity, conditionally sets status to 'closed', and updates the portfolio cash balance. All database operations run in a single transaction. Handles both stock and option positions with different quantity and value calculations. Phase 7b task (Weeks 10-12).

## Acceptance Criteria
- [ ] POST /positions/{id}/close accepts `{reason: string, quantity_pct: float}` (quantity_pct optional, default 1.0)
- [ ] Returns VALIDATION_ERROR if reason is missing or empty string
- [ ] Returns VALIDATION_ERROR if quantity_pct is not in range (0.0, 1.0] (exclusive zero, inclusive one)
- [ ] Returns NOT_FOUND if position does not exist or is already fully closed (status='closed')
- [ ] Creates position_exits record: exit_reason='manual_close', notes=provided reason, exit_price=latest price_history, quantity based on quantity_pct
- [ ] Full close (quantity_pct=1.0): sets status='closed', closed_at=now, shares_remaining=0 (or contracts_remaining=0)
- [ ] Partial close (quantity_pct<1.0): reduces remaining by floor(remaining * quantity_pct), status stays 'open'
- [ ] If partial close floors to 0 remaining, treat as full close
- [ ] Portfolio cash updated: cash += exit_price * quantity_closed (for options: * 100 multiplier)
- [ ] All DB operations (INSERT position_exits, UPDATE positions, UPDATE portfolios) in single transaction
- [ ] Returns updated position object in response envelope

## Technical Notes
- exit_price: SELECT close FROM price_history WHERE ticker=? ORDER BY date DESC LIMIT 1
- Stock quantity: quantity_closed = floor(shares_remaining * quantity_pct)
- Option quantity: quantity_closed = floor(contracts_remaining * quantity_pct)
- Option cash: exit_price * contracts_closed * 100 (standard options multiplier)
- quantity_pct=1.0 means "close all remaining" (not all original); position may already be partially closed
- Use BEGIN IMMEDIATE for the transaction to prevent concurrent modification
- Add to positions router module created in task-007-003-02

## Dependencies
- Depends on: task-007-003-02 (positions router exists), task-007-002-01 (response envelope)
- Blocks: none
