---
id: task-006-008-01
story: story-006-008
title: Implement candle iteration engine with priority-ordered exit evaluation
complexity: 5
---

# Task: Implement candle iteration engine with priority-ordered exit evaluation

## Description
Build the core candle iteration engine that drives all exit condition evaluation. For each open position, iterate through fetched candles chronologically. For each candle, check all active exit triggers in priority order (stocks: stop-loss > take-profit > trailing > breakeven > time; options: expiration > stop-loss > take-profit > trailing > time). On first breach detection, stop iteration for that position and process the triggered exit. Derive period high/low by aggregating candle data (PIPE-046). Skip positions with zero candles.

## Acceptance Criteria
- [ ] Candles sorted chronologically (oldest first) before iteration
- [ ] For each candle, exit triggers checked in correct priority order per instrument type
- [ ] On first breach, iteration stops for that position and exit is processed
- [ ] When multiple triggers breach in same candle, higher-priority trigger wins
- [ ] Positions with no candles are skipped with debug log
- [ ] Period high/low derived from aggregating candle highs/lows (PIPE-046)
- [ ] Each candle checked exactly once per position
- [ ] Exit condition functions called via MonitoredInstrument protocol

## Technical Notes
- FR-031: Chronological candle iteration for exit detection
- PIPE-046: Period high/low from aggregated intraday candles
- This is the orchestration layer connecting price data (story-006-001) to exit conditions (stories 002-007)
- Position-centric: outer loop is positions, inner loop is candles per position
- Exit condition functions are private functions called in cascade order
- The engine must support both stock and options positions with different cascade orders

## Dependencies
- Depends on: task-006-001-02 (tiered price data provides candles)
- Blocks: task-006-002-01, task-006-002-02, task-006-005-01 (exit conditions plug into this engine)
