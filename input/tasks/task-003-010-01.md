---
id: task-003-010-01
story: story-003-010
title: Write 3 concurrency unit tests for batch-of-5 processing
complexity: 2
---

# Task: Write 3 concurrency unit tests for batch-of-5 processing

## Description
Write 3 targeted pytest tests for the batch-of-5 concurrent processing and commit logic: (1) all 5 workers succeed and results are correctly mapped, (2) 1 of 5 workers fails while the other 4 succeed with proper error logging, (3) database COMMIT occurs only after all 5 responses are collected (no mid-batch partial commits). All tests use mocked OpenAI and database, no real network calls.

## Acceptance Criteria
- [ ] Test 1 (all-succeed): 5 mock comments submitted, all 5 API calls complete, all 5 results correctly mapped to their source comments
- [ ] Test 2 (1-of-5-fails): 5 mock comments, 1 worker raises exception, 4 succeed with results, failed comment's reddit_id and error logged via structlog
- [ ] Test 3 (commit timing): mock database tracks COMMIT calls; verify COMMIT called once per batch (after all 5 responses), not after each individual response
- [ ] All tests use unittest.mock.patch or pytest-mock for OpenAI client and database
- [ ] Tests verify ThreadPoolExecutor is used with max_workers=5
- [ ] Tests complete in under 5 seconds (no real delays)
- [ ] Each test has a descriptive docstring

## Technical Notes
- For test 2: mock one specific comment's API call to raise an exception
- For test 3: instrument mock db connection to record timing of COMMIT relative to API response collection
- These tests validate orchestration logic, not AI response content
- PRD reference: PIPE-017

## Dependencies
- Depends on: task-003-004-01 (batch orchestrator), task-003-008-01 (batch commit)
- Blocks: none
