---
id: task-005-003-01
story: story-005-003
title: Implement confidence-weighted position sizing with min/max clamping
complexity: 3
---

# Task: Implement confidence-weighted position sizing with min/max clamping

## Description
Implement the position sizing function that calculates dollar amounts for stock and option positions. Stocks use a 3-tier confidence multiplier (0.5x/0.75x/1.0x) applied to base_allocation (portfolio_value / 20). Options use a fixed 2% of portfolio_value. All results are clamped to [2%, 15%] of portfolio_value. Thresholds and percentages are read from system_config. Also implements target portfolio determination based on signal_type (Quality -> stocks_quality + options_quality, Consensus -> stocks_consensus + options_consensus).

## Acceptance Criteria
- [ ] Stock base_allocation = portfolio_value / 20 (5%)
- [ ] Confidence tiers: [0.50, 0.70) -> 0.5x, [0.70, 0.90) -> 0.75x, [0.90, 1.00] -> 1.0x (boundary values fall into higher tier)
- [ ] Options position_size = portfolio_value * 0.02 (fixed, confidence-independent)
- [ ] Final position_size clamped: max(portfolio_value * 0.02, min(portfolio_value * 0.15, raw_size))
- [ ] All multipliers and percentages read from system_config at runtime
- [ ] Target portfolios determined by signal_type: Quality -> [stocks_quality, options_quality], Consensus -> [stocks_consensus, options_consensus]
- [ ] Returns list of (portfolio_id, instrument_type, position_size) tuples for each signal
- [ ] Unit tests cover: each confidence tier, boundary values (0.50, 0.70, 0.90), min/max clamping, both signal types

## Technical Notes
- FR-023 and PIPE-033 requirements
- Clamping applies after multiplier: raw_size = base_allocation * multiplier, then clamp
- For options, the 2% is already within the [2%, 15%] band, so clamping is a no-op in practice but must still be applied
- Each portfolio has independent value; use the specific target portfolio's current_value
- When both Quality and Consensus fire on same ticker (FR-024), this function is called for each signal independently -- positions open in all 4 portfolios

## Dependencies
- Depends on: task-005-002-01 (qualified signals as input)
- Blocks: task-005-004-01, task-005-005-01, task-005-007-01
