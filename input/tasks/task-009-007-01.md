---
id: task-009-007-01
story: story-009-007
title: Write 7 prediction-based accuracy tests covering EMA, HITL override, and cold start
complexity: 2
---

# Task: Write 7 prediction-based accuracy tests covering EMA, HITL override, and cold start

## Description
Write 7 unit/integration tests covering the full prediction-based accuracy lifecycle. Tests use mock author records, mock prediction records with prediction_exits, and mock system_config values. No Schwab API access required. Tests validate the logic from story-009-004 (prediction resolution and EMA accuracy update). PRD Appendix F.4.2-F.4.3 lines 3045-3077.

## Acceptance Criteria
- [ ] Test 1 (positive accuracy): Bullish prediction (option_type='call') with positive simulated_return_pct -> is_correct=TRUE, EMA updates accuracy upward
- [ ] Test 2 (negative accuracy): Bearish prediction (option_type='put') with negative simulated_return_pct -> is_correct=FALSE, EMA updates accuracy downward
- [ ] Test 3 (HITL override): Prediction auto-determined as is_correct=FALSE, hitl_override='correct' -> accuracy updated as if correct (1.0 in EMA)
- [ ] Test 4 (HITL excluded): Prediction with hitl_override='excluded' -> avg_sentiment_accuracy unchanged before and after
- [ ] Test 5 (cold start): Author with avg_sentiment_accuracy=NULL -> trust uses 0.5 default; after first resolution, accuracy set directly to 1.0 or 0.0 (not EMA)
- [ ] Test 6 (sequential EMA): 3+ predictions for same author, EMA applied sequentially, verified to 3 decimal places: step1 = (0.70 * old + 0.30 * new1), step2 = (0.70 * step1 + 0.30 * new2), etc.
- [ ] Test 7 (near-zero return): simulated_return_pct = 0.001 -> is_correct=TRUE; simulated_return_pct = 0.0 -> is_correct=FALSE
- [ ] All tests runnable independently without Schwab API access
- [ ] Test fixtures include mock author, prediction, prediction_exits, and system_config records

## Technical Notes
- Tests validate logic from task-009-004-01 (resolution) and task-009-004-02 (EMA update)
- EMA formula: new = (1 - 0.30) * old + 0.30 * (1.0 if correct else 0.0) with default alpha
- Cold start: NULL accuracy -> direct set, not EMA blend
- The > 0 boundary is the sole correctness criterion
- Use in-memory SQLite or mock objects for database interaction
- Test 6 should verify convergence behavior: e.g., start at 0.5, three correct predictions -> 0.5, 0.650, 0.755 (verify each step)

## Dependencies
- Depends on: task-009-004-01, task-009-004-02 (the logic being tested)
- Blocks: none
