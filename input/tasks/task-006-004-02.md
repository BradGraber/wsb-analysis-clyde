---
id: task-006-004-02
story: story-006-004
title: Implement stock three-tier time extension logic
complexity: 3
---

# Task: Implement stock three-tier time extension logic

## Description
Implement the stock time stop with three tiers: base (5 days, gain < +5%), extended (7 days, gain was +5% to +15% at Day 5), and trailing (10 days, after partial take-profit occurred). The tier is determined by position state at evaluation time, with monotonic tier progression (never reverts to a lower tier). When trailing_stop_active is TRUE, the trailing tier (10 days) always applies. Exit_reason='time_stop', exit_price=current_price.

## Acceptance Criteria
- [ ] Base time stop: triggers at Day 5 when gain < +5% (exit 100%, exit_reason='time_stop')
- [ ] Extended time stop: triggers at Day 7 when gain was +5% to +15% at Day 5 transition
- [ ] Trailing time stop: triggers at Day 10 after partial take-profit occurred
- [ ] When trailing_stop_active is TRUE, trailing tier (10 days) always applies regardless of gain
- [ ] Tier progression is monotonic: once extended, cannot revert to base; once trailing, cannot revert
- [ ] Exit price is current_price (not a trigger level)
- [ ] hold_days calculated as calendar days from open_date
- [ ] Time stop is lowest priority in stock exit cascade (PIPE-044)

## Technical Notes
- FR-029: Three time extension tiers based on position state
- PIPE-044: Time stop is lowest priority in stock cascade
- Tiers are mutually exclusive at each evaluation; state transitions are one-directional
- The time_extension field on the position tracks the current tier
- This is the most nuanced of the stock exit conditions due to the three-tier state machine

## Dependencies
- Depends on: task-006-002-01 (stop-loss/take-profit framework), task-006-003-01 (trailing_stop_active flag)
- Blocks: none
