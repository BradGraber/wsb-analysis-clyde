---
id: task-007-006-01
story: story-007-006
title: Implement POST /analyze endpoint with HTTP 202, single-run enforcement, and warnings accumulation
complexity: 2
---

# Task: Implement POST /analyze endpoint with HTTP 202, single-run enforcement, and warnings accumulation

## Description
Implement the POST /analyze endpoint that creates an analysis_runs record, enforces single-run execution (HTTP 409 if already running), spawns the background thread pipeline, and passes a thread-safe warnings list for in-memory accumulation during the run. On pipeline completion, warnings are serialized to JSON on the analysis_runs record. Phase 7b task (Weeks 10-12).

## Acceptance Criteria
- [ ] POST /analyze INSERT INTO analysis_runs with status='running', returns HTTP 202 with `{data: {run_id: <id>}, meta: {timestamp, version}}`
- [ ] Single-run check: SELECT WHERE status='running' before INSERT; if found, return HTTP 409 with error code ANALYSIS_ALREADY_RUNNING and active run_id in error details
- [ ] Single-run check + INSERT is atomic (within a single transaction to prevent race conditions)
- [ ] Background thread spawned via task-007-005-01 orchestrator with the new run_id
- [ ] Thread-safe warnings list (Python list, append is GIL-protected) passed to orchestrator
- [ ] On completion: `analysis_runs.warnings = json.dumps(warnings) if warnings else None`
- [ ] All 7 warning types supported: schwab_stock_unavailable, schwab_options_unavailable, image_analysis_failed, market_hours_skipped, insufficient_cash, schwab_prediction_unavailable, prediction_strike_unavailable
- [ ] GET /runs/{id}/status correctly reflects real-time progress while background thread runs

## Technical Notes
- Warning object structure: `{"type": "warning_type", "message": "details", "ticker": "optional_ticker", "phase": N}`
- The run_id is the SQLite auto-incremented rowid from the INSERT
- Race condition mitigation: BEGIN IMMEDIATE transaction for the check-then-insert pattern
- The endpoint handler runs on the FastAPI request thread; only the pipeline runs in the background thread
- Add the route to the runs router module created in task-007-003-04

## Dependencies
- Depends on: task-007-005-01, task-007-005-02 (complete background orchestrator)
- Blocks: task-007-007-01 (startup recovery handles stale records from this endpoint)
