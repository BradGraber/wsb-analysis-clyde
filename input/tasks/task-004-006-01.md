---
id: task-004-006-01
story: story-004-006
epic: epic-004
title: Implement daily signal UPSERT with signal_comments junction population
complexity: 2
---

# Task: Implement daily signal UPSERT with signal_comments junction population

## Description
Create a `persist_signal(conn, signal_metadata)` function that performs an INSERT ... ON CONFLICT (ticker, signal_type, signal_date) DO UPDATE for signal records. On insert, sets created_at and position_opened=false. On update, sets updated_at with recalculated values but preserves position_opened if already true. After UPSERT, clears and repopulates the signal_comments junction table for the signal's contributing comments. Wraps both operations in a transaction. References FR-039, PIPE-029, PIPE-030.

## Acceptance Criteria
- [ ] INSERT ... ON CONFLICT (ticker, signal_type, signal_date) DO UPDATE used for signal records
- [ ] First run of the day: creates signal with created_at timestamp, position_opened=false
- [ ] Subsequent runs same day: updates signal with recalculated values, sets updated_at
- [ ] Signal record stores: ticker, signal_type, signal_date, direction, confidence, comment_count, user_count, is_emergence, position_opened
- [ ] position_opened defaults to false on INSERT and is NOT overwritten on UPDATE (preserves true if set by epic-005)
- [ ] signal_comments junction populated with (signal_id, comment_id) for every contributing comment
- [ ] On update: existing signal_comments for the signal are DELETE'd then re-INSERT'd
- [ ] Both signal UPSERT and signal_comments operations wrapped in a single transaction

## Technical Notes
- SQLite UPSERT: `INSERT INTO signals (...) VALUES (...) ON CONFLICT (ticker, signal_type, signal_date) DO UPDATE SET direction=excluded.direction, confidence=excluded.confidence, ...`
- position_opened preservation: use `position_opened = CASE WHEN signals.position_opened = 1 THEN 1 ELSE excluded.position_opened END` in the DO UPDATE clause
- signal_comments repopulation: `DELETE FROM signal_comments WHERE signal_id = ?` then batch INSERT
- Use `cursor.lastrowid` for the INSERT case; for UPDATE case, query the signal_id after UPSERT
- signal_metadata dict should contain all fields plus a list of contributing_comment_ids

## Dependencies
- Depends on: task-004-002-01, task-004-003-01, task-004-005-01 (all signal detection produces metadata for persistence)
- Blocks: task-004-006-02
