---
id: task-008-013-01
story: story-008-013
title: Configure VCR.py and write 10 error injection tests across 4 tiers
complexity: 2
---

# Task: Configure VCR.py and write 10 error injection tests across 4 tiers

## Description
Set up VCR.py for recording and replaying API interactions (cassette directory at `tests/cassettes/`). Write 10 error injection tests covering the 4-tier error model: 2-3 Tier 1 (hard fail: Reddit outage, SQLite write failure with ROLLBACK), 2-3 Tier 2 (retry with exponential backoff 1s-30s, escalation after 3-5 retries), 2-3 Tier 3 (graceful degradation: single comment failure, NULL/default fallback), 2-3 Tier 4 (log and continue: dedup collision, missing yfinance data).

## Acceptance Criteria
- [ ] VCR.py configured with cassette directory at `tests/cassettes/`, record + playback modes
- [ ] 2-3 Tier 1 tests: simulate Reddit outage and SQLite write failure, verify ROLLBACK and HTTP 5xx
- [ ] 2-3 Tier 2 tests: simulate transient failure, verify exponential backoff, verify escalation after retries
- [ ] 2-3 Tier 3 tests: simulate comment analysis failure, verify pipeline continues with NULL/default
- [ ] 2-3 Tier 4 tests: simulate dedup collision and missing yfinance, verify info-level logging
- [ ] All tests pass in CI with mocked APIs (no real external calls)

## Technical Notes
- VCR.py: configure record_mode='once' for initial capture, 'none' for CI playback
- Error injection: use monkeypatch/mock to simulate failures in specific pipeline phases
- Tier 1: may need to mock database connection for write failures
- Tier 2: mock time.sleep to avoid slow tests; verify backoff intervals
- Verify both HTTP response and structured log output (capture log records)
- Consider grouping: `test_tier1_errors.py`, `test_tier2_errors.py`, etc.

## Dependencies
- Depends on: task-008-010-02 (error banner and recovery patterns exercised by these tests)
- Blocks: task-008-013-02, task-008-014-01
