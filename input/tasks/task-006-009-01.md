---
id: task-006-009-01
story: story-006-009
title: Implement partial exit record creation and position update
complexity: 3
---

# Task: Implement partial exit record creation and position update

## Description
Build the partial exit mechanics function that handles quantity calculation, exit record creation (INSERT position_exits), position update (UPDATE shares_remaining or contracts_remaining), and portfolio cash update (proceeds only, not realized_pnl). Options exits apply the x100 contract multiplier. When remaining quantity reaches 0, invoke full close finalization (story-006-011). Support multiple sequential partial exits on the same position.

## Acceptance Criteria
- [ ] quantity_pct correctly calculated as fraction of original position
- [ ] position_exits record INSERTed with: position_id, exit_date, exit_price, exit_reason, quantity_pct, shares/contracts_exited, realized_pnl
- [ ] shares_remaining or contracts_remaining decremented by exited amount
- [ ] Portfolio cash_available updated with proceeds: exit_price * shares_exited (stocks) or exit_price * contracts_exited * 100 (options)
- [ ] Options x100 multiplier correctly applied in all cash calculations
- [ ] realized_pnl per exit: (exit_price - entry_price) * shares_exited (stocks) or (exit_premium - entry_premium) * contracts_exited * 100 (options)
- [ ] Exited quantity uses floor rounding (7 shares at 50% = 3 exited)
- [ ] When remaining reaches 0, full close finalization invoked (story-006-011)
- [ ] Multiple partial exits on same position work correctly (sequential calls)

## Technical Notes
- PIPE-047: Exit record creation, position update, portfolio cash update (proceeds-only)
- Proceeds-only: cash_available += exit_price * quantity (not realized_pnl)
- This function is called by both stock exits (story-006-003) and options exits (story-006-006)
- Must handle the transition from partial exit to full close when remaining reaches 0

## Dependencies
- Depends on: task-006-011-01 (full close finalization called when remaining=0)
- Blocks: task-006-003-01, task-006-006-02 (exit conditions call this for partial exits)
