---
id: task-004-007-01
story: story-004-007
epic: epic-004
title: Write unit tests for Quality and Consensus signal detection algorithms
complexity: 2
---

# Task: Write unit tests for Quality and Consensus signal detection algorithms

## Description
Write unit tests covering Quality and Consensus signal detection logic using hand-written fixtures and an in-memory SQLite database. Cover positive firing cases, negative cases (threshold boundaries, direction disagreement), and edge cases (all-neutral comments, division-by-zero). Use parameterized tests for boundary conditions where appropriate. References FR-015, FR-016.

## Acceptance Criteria
- [ ] Quality signal test: exactly 2 users with has_reasoning=true, sarcasm_detected=false, ai_confidence >= 0.6, unanimous direction produces a fired signal
- [ ] Quality signal negative test: 2 qualifying users with conflicting per-ticker sentiment does NOT produce a signal
- [ ] Quality signal negative test: 1 qualifying user (below quality_min_users=2) does NOT produce a signal
- [ ] Consensus signal test: exactly 30 comments, 8 users, 70% alignment produces a fired signal
- [ ] Consensus signal boundary test: 29 comments OR 7 users OR 69% alignment does NOT produce a signal
- [ ] Consensus edge case test: all comments are neutral -- no signal fires, no division-by-zero error
- [ ] All tests use hand-written fixture data (no VCR.py)
- [ ] All tests run against in-memory SQLite with full schema

## Technical Notes
- Fixture pattern: create_test_comments(n, ticker, sentiment, has_reasoning, sarcasm, ai_confidence, author) helper
- Use parameterized tests (pytest.mark.parametrize) for boundary conditions (threshold - 1, threshold, threshold + 1)
- Quality tests should verify the confidence value is returned when signal fires
- Consensus alignment boundary: 0.699 should not fire, 0.70 should fire
- Test that config values are used (not hardcoded defaults) by passing custom config dicts

## Dependencies
- Depends on: task-004-002-01, task-004-003-01, task-004-006-02 (all detection logic implemented)
- Blocks: none
