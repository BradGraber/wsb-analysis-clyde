---
id: task-009-003-02
story: story-009-003
title: Implement batched Schwab strike selection and premium fetch for predictions
complexity: 2
---

# Task: Implement batched Schwab strike selection and premium fetch for predictions

## Description
For each unique ticker with pending predictions from task-009-003-01, call the shared strike selection function from epic-005 (story-005-006) to select an appropriate strike. Batch Schwab API calls by unique ticker (one options chain fetch per ticker, reused across all predictions for that ticker). Fetch entry_premium from the Schwab option quote. Calculate contracts = max(1, floor(2000 / (entry_premium * 100))) and set contracts_remaining = contracts. Update the prediction record with contract_symbol, strike_price, expiration_date, entry_premium, contracts, contracts_remaining. Use ThreadPoolExecutor with max_workers=5 and retry/backoff pattern. PRD Section 3.2.2 lines 196-212.

## Acceptance Criteria
- [ ] Strike selection reuses the shared function from story-005-006: expirations 14-21 DTE (prefer closest to 17), delta target +0.30 (calls) / -0.30 (puts) with tolerance [0.15, 0.50]
- [ ] Schwab API calls batched by unique ticker: one options chain fetch per ticker, results cached and reused for all predictions on that ticker
- [ ] entry_premium fetched from Schwab option quote for the selected contract
- [ ] contracts = max(1, floor(2000 / (entry_premium * 100))), contracts_remaining = contracts
- [ ] Prediction record updated with contract_symbol, strike_price, expiration_date, entry_premium, contracts, contracts_remaining
- [ ] ThreadPoolExecutor with max_workers=5 used for Schwab API concurrency
- [ ] Retry/backoff pattern applied to Schwab calls (reusing pattern from story-006-013)

## Technical Notes
- The shared strike selection function is imported from epic-005; this task does NOT reimplement it
- Ticker batching: collect all unique tickers, fetch options chain once per ticker, then assign strikes to all predictions for that ticker
- ThreadPoolExecutor pattern reused from story-006-013 (Schwab concurrent calls)
- If a ticker has multiple predictions (multiple comments mentioning same ticker), all share the same options chain data
- Premium is the mark price from the Schwab option quote

## Dependencies
- Depends on: task-009-003-01 (prediction records exist with ticker and option_type), story-005-006 (shared strike selection function), epic-001 (Schwab client)
- Blocks: task-009-003-03 (graceful degradation for failed selections)
