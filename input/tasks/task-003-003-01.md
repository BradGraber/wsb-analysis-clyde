---
id: task-003-003-01
story: story-003-003
title: Implement batch deduplication query for comments by reddit_id
complexity: 2
---

# Task: Implement batch deduplication query for comments by reddit_id

## Description
Implement a `check_dedup_batch(db_conn, reddit_ids: list[str])` function that queries the comments table for all reddit_ids in a single batch query. Returns a dict mapping reddit_id to existing annotation data (sentiment, sarcasm_detected, has_reasoning, confidence, reasoning_summary, author_trust_score) for comments that have non-null AI annotations, and None for comments that either do not exist or exist with null annotations.

## Acceptance Criteria
- [ ] Single SELECT query fetches all matching comments for a batch of reddit_ids (not N individual queries)
- [ ] Returns dict[str, Optional[CommentAnnotations]]: reddit_id -> annotations or None
- [ ] Comments with non-null AI annotations (sentiment IS NOT NULL) are returned with their stored data
- [ ] Comments that exist but have null annotations (failed previous AI call) return None (treated as new)
- [ ] Comments that do not exist in the database return None
- [ ] Handles empty input list gracefully (returns empty dict)
- [ ] Unit test: batch query returns mix of existing, null-annotation, and missing comments
- [ ] Unit test: empty input returns empty dict

## Technical Notes
- Use parameterized IN clause: `SELECT reddit_id, sentiment, sarcasm_detected, has_reasoning, confidence, reasoning_summary, author_trust_score FROM comments WHERE reddit_id IN (?,...)`
- SQLite IN clause has a limit of ~999 parameters; for batches of 5, this is not a concern
- The dedup check happens BEFORE comments enter the ThreadPoolExecutor batch (story-003-004)
- PRD reference: PIPE-015, Section 3.2.2 Phase 3 step 1

## Dependencies
- Depends on: epic-001 (comments table schema)
- Blocks: task-003-003-02
