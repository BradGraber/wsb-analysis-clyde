---
id: task-003-006-02
story: story-003-006
title: Implement rate limit (429) exponential backoff retry
complexity: 2
---

# Task: Implement rate limit (429) exponential backoff retry

## Description
Wrap the OpenAI API call with rate limit retry logic. On HTTP 429 response, apply exponential backoff starting at 1 second (1s, 2s, 4s, 8s) with a maximum delay of 30 seconds and up to 3 retry attempts. If all retries receive 429, log an error and skip the comment. Uses the `retry_with_backoff()` utility from epic-001 configured for rate-limit-specific parameters. Both retry mechanisms (malformed JSON + rate limit) are per-comment, not per-batch.

## Acceptance Criteria
- [ ] On HTTP 429 response: apply exponential backoff with delays [1s, 2s, 4s, 8s] capped at 30s
- [ ] Up to 3 retry attempts after initial 429; if all retries fail, skip the comment
- [ ] Skipped comments logged via structlog ERROR with: comment reddit_id, error type "rate_limit", total retry attempts
- [ ] Each retry event logged via structlog INFO with: retry attempt number, delay duration, comment reddit_id, error type "rate_limit"
- [ ] Rate limit retry is per-comment: one comment's backoff does not block other comments in concurrent batch workers
- [ ] Uses `retry_with_backoff(fn, max_retries=3, base_delay=1.0, max_delay=30.0, retryable_exceptions=(RateLimitError,))`
- [ ] Unit test: 429 on first call, succeeds on retry after backoff
- [ ] Unit test: 429 on all retries, comment skipped and error logged

## Technical Notes
- OpenAI SDK raises `openai.RateLimitError` (or similar) for 429 responses; identify the exact exception class
- Since retry happens inside each ThreadPoolExecutor worker, backoff delays are per-thread and do not block other workers
- PRD reference: ERR-OPENAI-RATE, Appendix E.9

## Dependencies
- Depends on: task-003-001-01 (OpenAI client), task-001-008-01 (retry_with_backoff utility)
- Blocks: none
