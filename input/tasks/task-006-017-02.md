---
id: task-006-017-02
story: story-006-017
title: Write exit mechanics and x100 multiplier unit tests (Tests 7-10)
complexity: 2
---

# Task: Write exit mechanics and x100 multiplier unit tests (Tests 7-10)

## Description
Write 4 unit tests covering shared exit mechanics and options-specific calculations: (7) partial exit cash uses proceeds only (exit_premium * contracts_exited * 100), not realized_pnl, (8) peak tracking updates peak_premium = MAX(existing, current), (9) multi-exit realized_return_pct = SUM(realized_pnl) / position_size after full close, (10) x100 contract multiplier regression test verifying correct cash impact.

## Acceptance Criteria
- [ ] Test 7: Cash calculation uses proceeds-only (PIPE-047), not realized_pnl
- [ ] Test 8: Peak tracking updates peak_premium to MAX(existing, current_premium)
- [ ] Test 9: Multi-exit realized_return_pct sums all exit records / position_size
- [ ] Test 10: x100 multiplier applied in cash calculations (proceeds = premium * contracts * 100)
- [ ] All tests use pytest with mock positions and in-memory database assertions

## Technical Notes
- Test 7 verifies PIPE-047: portfolio cash updated with proceeds
- Test 9 verifies PIPE-049: realized_return_pct aggregation
- Test 10 is a regression test for the x100 multiplier (common options bug)
- Tests 7 and 10 may overlap in coverage; Test 10 specifically isolates the multiplier

## Dependencies
- Depends on: task-006-009-01, task-006-010-01, task-006-011-01
- Blocks: none
