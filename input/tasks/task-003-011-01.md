---
id: task-003-011-01
story: story-003-011
title: Write 8 unit tests for AI response parsing and deduplication
complexity: 2
---

# Task: Write 8 unit tests for AI response parsing and deduplication

## Description
Write 8 pytest tests covering AI response parsing edge cases, ticker normalization, confidence clamping, and Phase 3 deduplication logic. These tests fill the coverage gap identified in QA review: epic-003's parsing and dedup paths handle the majority of AI pipeline edge cases. Use hand-crafted fixtures (not VCR.py) per project conventions.

## Acceptance Criteria
- [ ] Test 1 (malformed JSON): unparseable response flagged for retry, not silently dropped
- [ ] Test 2 (extra fields): 7 expected + 2 extra fields parsed successfully, extras ignored
- [ ] Test 3 (missing required fields): JSON missing `sentiment` raises validation error, comment logged as skipped
- [ ] Test 4 (confidence clamping): confidence=1.5 clamped to 1.0 with debug log; confidence=-0.2 clamped to 0.0
- [ ] Test 5 (ticker normalization): "nvda"->"NVDA", "the mouse"->"DIS", "Zuck"->"META"; excluded words filtered; duplicates removed
- [ ] Test 6 (dedup - existing with annotations): AI call skipped, analysis_run_id updated, existing annotations returned
- [ ] Test 7 (dedup - existing without annotations): null sentiment in DB, AI call proceeds as new
- [ ] Test 8 (dedup - new comment): comment not in DB, AI call proceeds normally
- [ ] All tests use mocked OpenAI and database; no network access
- [ ] Tests use pytest.mark.parametrize where appropriate (especially ticker normalization)
- [ ] Tests complete in under 5 seconds
- [ ] Confidence clamping test verifies debug log via caplog or structlog test utilities

## Technical Notes
- Hand-crafted fixtures per project conventions (not VCR.py for unit tests)
- Tests complement story-003-010 (concurrency tests) for comprehensive epic-003 coverage
- PRD reference: PIPE-018, PIPE-015, AI-RESPONSE-FORMAT, AI-TICKER-RULES

## Dependencies
- Depends on: task-003-005-01, task-003-005-02, task-003-003-01, task-003-003-02 (all parsing and dedup code must exist)
- Blocks: none
