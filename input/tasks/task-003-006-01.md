---
id: task-003-006-01
story: story-003-006
title: Implement malformed JSON retry with single retry attempt
complexity: 2
---

# Task: Implement malformed JSON retry with single retry attempt

## Description
Wrap the individual AI call + parse cycle with malformed JSON retry logic. When `parse_ai_response()` raises `MalformedResponseError`, retry the same API call once with the identical prompt. On second failure, skip the comment, log a warning with the comment's reddit_id and raw response content, and continue processing. Uses the `retry_with_backoff()` utility from epic-001 (story-001-008) configured for 1 retry, no backoff delay.

## Acceptance Criteria
- [ ] On `MalformedResponseError` from parsing: retry the OpenAI API call once with identical prompt
- [ ] If retry also returns malformed JSON: skip the comment entirely
- [ ] Skipped comments logged via structlog WARNING with: comment reddit_id, raw response content (first 500 chars), error type "malformed_json"
- [ ] Skipped comments do not cause batch or pipeline failure; processing continues
- [ ] Retry event logged via structlog INFO with: retry attempt=1, comment reddit_id, error type "malformed_json"
- [ ] Uses `retry_with_backoff(fn, max_retries=1, base_delay=0, retryable_exceptions=(MalformedResponseError,))`
- [ ] Unit test: first call fails, retry succeeds, result returned
- [ ] Unit test: both calls fail, comment skipped and warning logged

## Technical Notes
- The retry wraps the full cycle: API call + response parsing (not just re-parsing the same response)
- Distinction: story-003-005 strips markdown fences (structural cleanup); this task handles truly unparseable responses
- PRD reference: PIPE-022, ERR-MALFORMED-JSON, Appendix E.9

## Dependencies
- Depends on: task-003-005-01 (defines MalformedResponseError), task-001-008-01 (retry_with_backoff utility)
- Blocks: none
