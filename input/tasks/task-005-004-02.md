---
id: task-005-004-02
story: story-005-004
title: Implement close-then-open replacement flow with atomic transaction
complexity: 3
---

# Task: Implement close-then-open replacement flow with atomic transaction

## Description
Implement the replacement execution flow that closes the identified lowest-confidence position and opens the new position in an atomic transaction. The flow: (1) fetch current price via Schwab, (2) INSERT position_exits with exit_reason='replaced', (3) UPDATE position to status='closed', (4) UPDATE portfolio cash_available += exit_proceeds, (5) proceed to open new position. All database operations are wrapped in a single transaction to prevent partial state.

## Acceptance Criteria
- [ ] Fetches current price from Schwab API for the outgoing position (last trade for stocks, mark for options)
- [ ] INSERTs position_exits record with: position_id, exit_date, exit_price, exit_quantity, exit_reason='replaced', realized_pnl
- [ ] UPDATEs outgoing position: status='closed', exit_date, exit_price
- [ ] UPDATEs portfolio: cash_available += exit_proceeds (stocks: shares_remaining * current_price, options: contracts_remaining * current_premium * 100)
- [ ] Calculates realized_pnl: exit_proceeds - (entry_price * original_quantity) for stocks; (exit_premium - entry_premium) * contracts * 100 for options
- [ ] All DB operations wrapped in a transaction; if any step fails, all changes are rolled back
- [ ] If Schwab price fetch fails, entire replacement is aborted, existing position preserved, warning logged
- [ ] After successful close, proceeds to normal position opening flow (task-005-007-01)
- [ ] Unit tests: successful replacement, Schwab failure rollback, realized PnL calculation (both stock and options)

## Technical Notes
- PIPE-039 requirement
- exit_reason must be the canonical value 'replaced' (one of 8 valid exit_reason values)
- Transaction isolation: SQLite uses serialized transactions; ensure connection is not shared across threads during this operation
- After replacement close, portfolio count drops to 9, then new position brings it back to 10
- The exit_proceeds feed back into cash_available before the new position is opened (cash must be available for the new position)

## Dependencies
- Depends on: task-005-004-01 (replacement candidate must be identified first)
- Blocks: none (feeds into task-005-007-01 for the opening leg)
