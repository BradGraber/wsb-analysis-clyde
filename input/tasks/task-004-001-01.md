---
id: task-004-001-01
story: story-004-001
epic: epic-004
title: Implement comment aggregation query and return structure for signal detection
complexity: 2
---

# Task: Implement comment aggregation query and return structure for signal detection

## Description
Create a `signal_detection.py` module (or appropriate submodule within the pipeline) containing a function `aggregate_comments_by_ticker(conn, analysis_run_id) -> dict` that JOINs comment_tickers and comments for the given analysis_run_id, groups results by (ticker, signal_date), and returns a dict keyed by (ticker, signal_date) with lists of enriched comment records. The signal_date is the current UTC calendar day. Each record includes the full comment fields plus the per-ticker sentiment from comment_tickers.sentiment. Returns an empty dict when no comments exist. References PIPE-023, PIPE-024.

## Acceptance Criteria
- [ ] Function JOINs comment_tickers ct and comments c WHERE c.analysis_run_id = :run_id
- [ ] Results grouped by (ct.ticker, signal_date) where signal_date = current UTC date
- [ ] Each result record includes comment fields (id, author, content, ai_confidence, has_reasoning, sarcasm_detected, overall_sentiment, analysis_run_id) plus ct.sentiment as per_ticker_sentiment
- [ ] Comments mentioning multiple tickers appear in multiple groups (via comment_tickers rows)
- [ ] Returns empty dict (not error) when no matching comments exist
- [ ] Function signature accepts a database connection and analysis_run_id parameter

## Technical Notes
- Query pattern: `SELECT ct.ticker, ct.sentiment, c.* FROM comment_tickers ct JOIN comments c ON c.id = ct.comment_id WHERE c.analysis_run_id = ?`
- Return type: `dict[tuple[str, str], list[dict]]` keyed by (ticker, signal_date_str)
- Use sqlite3.Row or dict factory for clean field access
- This function is the single data source for stories 004-002 through 004-006; its return type is a contract
- Per-ticker sentiment comes from comment_tickers.sentiment, NOT comments.overall_sentiment

## Dependencies
- Depends on: epic-001 (schema: comments, comment_tickers tables), epic-003 (AI-annotated comment data)
- Blocks: task-004-002-01, task-004-003-01, task-004-004-01, task-004-005-01
