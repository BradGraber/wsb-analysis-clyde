---
id: task-006-012-01
story: story-006-012
title: Implement price history UPSERT logic
complexity: 2
---

# Task: Implement price history UPSERT logic

## Description
Implement the price history persistence layer. After fetching price data for monitored tickers, UPSERT daily OHLC records into the price_history table using INSERT OR REPLACE keyed on the UNIQUE(ticker, date) constraint. For multi-day gap fills, create one row per calendar day from yfinance data. For same-day Schwab data, aggregate 5-minute candles into a single daily OHLC row. Record fetched_at timestamp for each entry.

## Acceptance Criteria
- [ ] Daily OHLC (open, high, low, close) stored in price_history per monitored ticker
- [ ] Uses INSERT OR REPLACE on UNIQUE(ticker, date) for idempotent writes
- [ ] Multiple /analyze runs on same day update existing records, not create duplicates
- [ ] fetched_at timestamp recorded for each entry
- [ ] Multi-day gap fills create one row per calendar day
- [ ] Same-day Schwab 5-min candles aggregated into single daily OHLC row
- [ ] Both yfinance-sourced and Schwab-sourced data persisted

## Technical Notes
- PIPE-050: INSERT OR REPLACE on UNIQUE(ticker, date)
- DB-PRICE-HISTORY: Table schema: ticker, date, open, high, low, close, fetched_at
- Runs after price fetching (story-006-001) for each monitored ticker
- Aggregation for same-day: open=first candle open, high=max of highs, low=min of lows, close=last candle close

## Dependencies
- Depends on: task-006-001-02 (tiered price data provides OHLC data to persist)
- Blocks: none
