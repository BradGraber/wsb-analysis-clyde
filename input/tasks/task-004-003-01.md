---
id: task-004-003-01
story: story-004-003
epic: epic-004
title: Implement Consensus signal detection algorithm with alignment calculation
complexity: 2
---

# Task: Implement Consensus signal detection algorithm with alignment calculation

## Description
Create a `detect_consensus_signal(ticker, signal_date, comments, config, author_trust_scores)` function that counts total non-neutral comments, distinct users, and calculates directional alignment percentage. Signal fires when comment_count >= consensus_min_comments (default 30), distinct_users >= consensus_min_users (default 8), and alignment >= consensus_min_alignment (default 0.7). Handles division-by-zero when all comments are neutral. Calls calculate_signal_confidence for the confidence score. References FR-001, FR-016, FR-017, PIPE-026.

## Acceptance Criteria
- [ ] Non-neutral comments counted per ticker (excluding comment_tickers.sentiment = 'neutral')
- [ ] Distinct users counted among non-neutral comments
- [ ] Alignment = max(bullish_count, bearish_count) / (bullish_count + bearish_count)
- [ ] Signal fires when comment_count >= consensus_min_comments (default 30), distinct_users >= consensus_min_users (default 8), AND alignment >= consensus_min_alignment (default 0.7)
- [ ] Direction set to majority sentiment (bullish if bullish_count > bearish_count, bearish otherwise)
- [ ] Division-by-zero handled: when all comments are neutral (0 bullish + 0 bearish), no signal fires and no error raised
- [ ] When bullish_count equals bearish_count (50% alignment), signal does not fire (below 0.7 threshold)
- [ ] All thresholds read from config dict, not hardcoded
- [ ] When signal fires, calls calculate_signal_confidence with signal_type="consensus" and returns confidence in result
- [ ] Returns None or empty result when signal criteria not met

## Technical Notes
- Volume score for Consensus uses total non-neutral comment count (not distinct users)
- Alignment score normalization: (actual_alignment - min_alignment) / (1.0 - min_alignment), clamped to [0.0, 1.0]
- Edge case: 0 bullish and 0 bearish (all neutral) should gracefully return None
- The function returns a signal metadata dict: direction, confidence, comment_count, user_count, alignment, contributing_comment_ids
- Config dict should contain consensus_min_comments, consensus_min_users, consensus_min_alignment keys

## Dependencies
- Depends on: task-004-001-01 (comment aggregation), task-004-004-01 (confidence calculation)
- Blocks: task-004-006-01
