---
id: task-007-009-01
story: story-007-009
title: Implement GET /predictions, GET /predictions/{id}, and PATCH /predictions/{id}/override endpoints
complexity: 2
---

# Task: Implement GET /predictions, GET /predictions/{id}, and PATCH /predictions/{id}/override endpoints

## Description
Implement the three prediction-related endpoints. The list endpoint supports filters (author, ticker, status, analysis_run_id) with pagination. The detail endpoint includes full prediction_outcomes history and prediction_exits records. The override endpoint accepts HITL corrections (correct/incorrect/excluded) and is idempotent. Phase 7b task, but depends only on response envelope (not full pipeline). PRD references: API-PREDICTIONS, API-PREDICTION-OVERRIDE.

## Acceptance Criteria
- [ ] GET /predictions returns paginated predictions with filters: author, ticker, status, analysis_run_id (all optional, combinable)
- [ ] Each prediction includes core fields: id, comment_id, ticker, option_type, strike, entry_premium, status, is_correct, created_at
- [ ] GET /predictions/{id} returns single prediction with nested prediction_outcomes array (ordered by day_offset ASC) and prediction_exits array
- [ ] Returns NOT_FOUND for invalid prediction ID
- [ ] PATCH /predictions/{id}/override accepts `{override_result: string}` body
- [ ] PATCH validates override_result is exactly "correct", "incorrect", or "excluded"; returns VALIDATION_ERROR otherwise
- [ ] PATCH maps: correct -> is_correct=true, incorrect -> is_correct=false, excluded -> is_correct=null
- [ ] PATCH is idempotent: same value twice produces same result without error
- [ ] PATCH succeeds regardless of prediction status (tracking/resolved/expired)
- [ ] PATCH returns NOT_FOUND for invalid prediction ID
- [ ] Consider adding override_at timestamp and override_source='hitl' for audit trail

## Technical Notes
- Filter combinations should handle: single filter, multiple combined, no filters (return all)
- prediction_outcomes JOIN: SELECT * FROM prediction_outcomes WHERE prediction_id=? ORDER BY day_offset ASC
- prediction_exits JOIN: SELECT * FROM prediction_exits WHERE prediction_id=?
- PATCH idempotency: UPDATE predictions SET is_correct=?, override_at=?, override_source='hitl' WHERE id=?
- Create `src/api/routes/predictions.py` router module

## Dependencies
- Depends on: task-007-002-01, task-007-002-02 (response envelope, error handlers)
- Blocks: none (but epic-008 story-008-015 consumes these endpoints)
