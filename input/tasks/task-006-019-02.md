---
id: task-006-019-02
story: story-006-019
title: Implement prediction exit evaluation and outcome recording
complexity: 5
---

# Task: Implement prediction exit evaluation and outcome recording

## Description
Run the shared exit evaluation cascade on each tracking prediction via MonitoredInstrument protocol (expiration > stop-loss > take-profit > trailing > time). Handle expired-past-expiration (DTE < 0) with immediate forced resolution. Insert prediction_outcomes for each monitoring check. Insert prediction_exits for each triggered exit. Decrement contracts_remaining and calculate blended simulated_return_pct on full resolution. Update peak_premium for predictions. Set status='resolved' and resolved_at=NOW() when contracts_remaining reaches 0.

## Acceptance Criteria
- [ ] Exit cascade evaluated for each tracking prediction via MonitoredInstrument protocol
- [ ] Expired-past-expiration (DTE < 0): immediately resolved, exit_reason='expiration', quantity_pct=1.0
- [ ] prediction_outcomes INSERTed for each monitoring check (day_offset, premium, underlying_price)
- [ ] prediction_exits INSERTed for each triggered exit
- [ ] contracts_remaining decremented on partial exits
- [ ] Full resolution: simulated_return_pct = SUM(prediction_exits.simulated_pnl) / (entry_premium * contracts * 100)
- [ ] status='resolved', resolved_at=NOW() when contracts_remaining reaches 0
- [ ] peak_premium updated for predictions (monotonically increasing)
- [ ] Predictions do NOT update portfolio cash_available (is_real_position=False check)

## Technical Notes
- PIPE-058: Prediction monitoring via MonitoredInstrument
- DB-PREDICTION-EXITS: prediction_exits table for simulated exit events
- Exit cascade identical to options exits but writes to prediction_exits, not position_exits
- Key differences from real positions: no cash impact, simulated_pnl instead of realized_pnl
- DTE < 0 means option expired between runs: immediate forced resolution
- This is the most complex prediction-related task due to the full exit cascade integration

## Dependencies
- Depends on: task-006-019-01 (prediction loading/cache), task-006-005-01 (expiration logic), task-006-006-01, task-006-006-02 (premium exits), task-006-007-01 (time stop)
- Blocks: task-006-020-01, task-006-021-01
