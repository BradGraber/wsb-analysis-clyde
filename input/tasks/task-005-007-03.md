---
id: task-005-007-03
story: story-005-007
title: Implement portfolio cash update, value recalculation, and position_opened flag
complexity: 2
---

# Task: Implement portfolio cash update, value recalculation, and position_opened flag

## Description
After successful position creation, update the portfolio and signal records: (1) decrement portfolio cash_available by actual cost, (2) recalculate portfolio current_value as cash_available + SUM(open stock MTM) + SUM(open option MTM), and (3) set signal.position_opened = true when at least one position is successfully opened across any portfolio. Wrap position INSERT + cash update in a per-portfolio transaction.

## Acceptance Criteria
- [ ] Portfolio cash_available decremented by actual cost (not position_size -- actual = shares * entry_price or contracts * mark * 100)
- [ ] Portfolio current_value recalculated: cash_available + SUM(shares_remaining * current_price for open stocks) + SUM(contracts_remaining * current_premium * 100 for open options)
- [ ] Signal position_opened set to true when at least one position opens successfully across any portfolio
- [ ] Position INSERT + cash UPDATE wrapped in a transaction per portfolio
- [ ] Multiple portfolios processed independently: failure in one does not prevent others
- [ ] Unit tests: cash decrement, value recalculation, position_opened flag with partial success, transaction rollback on failure

## Technical Notes
- PIPE-040 and PIPE-041 requirements
- SD-014 known limitation: position_opened is signal-level, not per-portfolio; partial failures are accepted in Phase 1
- current_value recalculation uses MTM prices; for new positions, entry_price IS the current price at creation time
- Transaction scope: one transaction per portfolio (not one spanning all portfolios)
- After processing all signals, the pipeline should commit all state changes

## Dependencies
- Depends on: task-005-007-02 (position must be INSERTed before cash update)
- Blocks: task-005-008-01
