---
id: task-009-006-01
story: story-009-006
title: Implement evaluation period completion with portfolio metrics and S&P 500 benchmark
complexity: 2
---

# Task: Implement evaluation period completion with portfolio metrics and S&P 500 benchmark

## Description
When active periods have period_end < today, calculate final metrics for each of the 4 portfolio periods. Metrics: portfolio_return_pct = ((current_value - value_at_period_start) / value_at_period_start) * 100. Fetch S&P 500 (^GSPC) close prices for period_start and period_end via yfinance, compute sp500_return_pct. Calculate relative_performance and beat_benchmark. Count total_positions_closed, winning_positions, losing_positions for the period. Calculate avg_return_pct and signal_accuracy_pct. Set status='completed'. Handle yfinance failure gracefully (NULL benchmark fields). Handle zero closed positions (all metrics = 0). PRD Section 3.2.2 lines 387-389.

## Acceptance Criteria
- [ ] Active periods with period_end < today identified and processed
- [ ] portfolio_return_pct = ((current_value - value_at_period_start) / value_at_period_start) * 100
- [ ] sp500_return_pct from yfinance ^GSPC: ((end_price - start_price) / start_price) * 100
- [ ] relative_performance = portfolio_return_pct - sp500_return_pct
- [ ] beat_benchmark = TRUE when relative_performance > 0
- [ ] total_positions_closed counts positions with status='closed' within period date range for specific portfolio
- [ ] winning_positions (realized_total_pnl > 0), losing_positions (realized_total_pnl <= 0), avg_return_pct (mean return)
- [ ] signal_accuracy_pct = winning_positions / max(total_positions_closed, 1) * 100
- [ ] All 4 periods updated to status='completed' in single transaction
- [ ] If yfinance fails: sp500_return_pct, relative_performance, beat_benchmark set to NULL
- [ ] If zero positions closed: all position-count metrics = 0, avg_return_pct = 0.0, signal_accuracy_pct = 0.0
- [ ] Unit tests cover: normal completion, yfinance failure, zero positions, mixed win/loss

## Technical Notes
- yfinance call: `yf.download('^GSPC', start=period_start, end=period_end)` to get close prices
- realized_total_pnl per position = SUM(position_exits.realized_pnl)
- Only fully closed positions (status='closed', shares_remaining=0 or contracts_remaining=0) are counted
- Partially exited positions excluded from period metrics per PRD line 388
- yfinance retry: attempt up to 3 times with backoff, then log warning and set NULLs
- NFR-001 target: beat S&P 500 by 10% per period is a success metric, not enforced here

## Dependencies
- Depends on: task-009-005-01 (active periods must exist), epic-005/epic-006 (closed positions with realized_pnl data)
- Blocks: task-009-006-02 (rollover runs after completion)
