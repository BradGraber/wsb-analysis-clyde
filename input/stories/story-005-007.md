---
id: story-005-007
epic: epic-005
title: Implement Cash Guard and Position Opening
priority: high
story_points: [TBD]
source_requirements: [PIPE-037, PIPE-035, PIPE-040, PIPE-041]
dependencies: [story-005-006, story-005-003]
blocks: [story-005-008]
---

# Story: Implement Cash Guard and Position Opening

## Description
Implement the cash availability check and position creation flow. Before opening any position, verify cash_available >= position_size. If insufficient, skip that portfolio and log a warning. On sufficient cash: fetch real-time Schwab quote (last trade price for stocks, mark price for options), INSERT position record, UPDATE portfolio cash_available and current_value, and set position_opened=true on the signal when at least one position is successfully opened.

## Acceptance Criteria
- [ ] Cash guard checks cash_available >= position_size before opening each position; if insufficient, skip and log warning: "Insufficient cash in {portfolio_name}: need ${position_size}, have ${cash_available}"
- [ ] Real-time quote is fetched from Schwab API: last trade price for stock positions, mark price for option positions
- [ ] Position record is INSERTed with: entry_date, entry_price, position_size, status='open', signal_id, portfolio_id, ticker, direction, instrument_type, and option-specific fields (contract_symbol, strike_price, expiration_date, contracts) when applicable
- [ ] Portfolio cash_available is decremented by position_size after successful position open
- [ ] Portfolio current_value is recalculated: cash_available + SUM(open stock MTM) + SUM(open option MTM)
- [ ] Signal position_opened flag is set to true when at least one position is successfully opened across any portfolio
- [ ] If floor(position_size / entry_price) results in 0 shares (stock price exceeds position_size), the position open is skipped for that portfolio with a warning
- [ ] For options, if 1 contract costs more than position_size, the position is skipped for that portfolio with a warning (minimum viable cost = mark_price * 100)
- [ ] Multiple portfolios can be processed for the same signal: failure in one portfolio does not prevent opening in another

## Technical Notes
- PIPE-037: Cash guard -- skip if insufficient, log, continue to next portfolio
- PIPE-035: Fetch real-time quote from Schwab API for entry pricing
- PIPE-040: Set position_opened=true on signal when at least one position opens
- PIPE-041: Portfolio value update after position open
- Stock positions: shares = floor(position_size / entry_price), actual cost = shares * entry_price
- Option positions: contracts = max(1, floor(position_size / (mark_price * 100))), actual cost = contracts * mark_price * 100
- Known limitation (SD-014): position_opened is signal-level, not per-portfolio; partial failures are accepted in Phase 1
- Schwab quote fetch should use ThreadPoolExecutor for concurrent fetches across portfolios (per project concurrency decision)
- Wrap position INSERT + cash UPDATE in a transaction per portfolio

## Dependencies
- Depends on: story-005-006 (options strike selection for option positions), story-005-003 (position sizing for dollar amounts)
- Blocks: story-005-008 (stop-loss/take-profit calculated after position is created)
