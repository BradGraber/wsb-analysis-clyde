---
id: story-006-013
epic: epic-006
title: Implement Schwab Retry and Fallback Logic
priority: high
story_points: [TBD]
source_requirements: [PIPE-051, ERR-SCHWAB-STOCK, ERR-SCHWAB-OPTIONS, ERR-SCHWAB-AUTH, ERR-YFINANCE]
dependencies: [story-006-001]
blocks: []
---

# Story: Implement Schwab Retry and Fallback Logic

## Description
Implement exponential backoff retry logic for Schwab API calls (1s, 2s, 4s delays, max 15s total, 3 attempts) and the fallback strategy: yfinance fallback for stock price data on Schwab failure, skip options monitoring entirely on Schwab failure. Handle Schwab auth token expiration with proactive refresh and re-auth instructions.

## Acceptance Criteria
- [ ] Schwab API calls retry with exponential backoff: 1s, 2s, 4s delays between attempts (3 attempts max)
- [ ] Total retry time does not exceed 15 seconds per ticker
- [ ] On Schwab stock quote failure after all retries: fall back to yfinance for that ticker's price data
- [ ] On Schwab options quote failure after all retries: skip options monitoring for that ticker (log warning, retry next run)
- [ ] On Schwab auth token expiration: attempt proactive token refresh; if refresh token expired, log error with re-auth instructions
- [ ] yfinance data unavailability: log Tier 4 warning, skip monitoring for affected ticker, retry next run
- [ ] All retry attempts and fallback activations are logged with structlog (including ticker, attempt number, error details)

## Technical Notes
- PIPE-051: Schwab retry with backoff (1s, 2s, 4s max 15s, up to 3 attempts, log and skip on failure).
- ERR-SCHWAB-STOCK: Quote failure -> retry 3x, skip ticker on failure (Tier 2).
- ERR-SCHWAB-OPTIONS: Premium failure -> same retry as stocks, skip options monitoring (Tier 2).
- ERR-SCHWAB-AUTH: Token expired -> proactive refresh, fallback to yfinance for stocks, skip options.
- ERR-YFINANCE: Data unavailable -> log warning, skip monitoring, retry next run (Tier 4).
- ThreadPoolExecutor is used for concurrent Schwab quote fetches across 40 open positions (concurrency decision from Phase 1 questions).
- Retry logic wraps individual API calls, not the entire monitoring loop.

## Dependencies
- Depends on: story-006-001 (tiered price data fetching, which this story adds resilience to)
- Blocks: none
