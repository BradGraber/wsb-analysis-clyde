---
id: story-006-017
epic: epic-006
title: Write Options Exit and Mechanics Tests
priority: medium
story_points: [TBD]
source_requirements: [FR-041, FR-042, FR-043, FR-044, FR-045]
dependencies: [story-006-005, story-006-006, story-006-007, story-006-009]
blocks: []
---

# Story: Write Options Exit and Mechanics Tests

## Description
Write 10 unit tests covering all options exit conditions and shared exit mechanics: expiration protection at DTE=2, premium stop-loss at -50%, premium take-profit at +100%, partial exit of 50% contracts, trailing stop at -30% from peak, time stop at 10 days, partial exit cash calculation (proceeds only), peak tracking update, multi-exit realized_return_pct calculation, and the options x100 contract multiplier.

## Acceptance Criteria
- [ ] Test 1: Expiration protection triggers at DTE=2, exits 100% of contracts_remaining
- [ ] Test 2: Premium stop-loss triggers when current_premium <= entry_premium * 0.50, exits 100%
- [ ] Test 3: Premium take-profit triggers when current_premium >= entry_premium * 2.0, exits 50% of contracts
- [ ] Test 4: Partial exit of 50% contracts correctly decrements contracts_remaining and sets trailing_stop_active
- [ ] Test 5: Trailing stop triggers when current_premium <= peak_premium * 0.70, exits remaining contracts
- [ ] Test 6: Time stop triggers at hold_days >= 10, exits 100% of contracts_remaining
- [ ] Test 7: Partial exit cash calculation uses proceeds only (exit_premium * contracts_exited * 100), not realized_pnl
- [ ] Test 8: Peak tracking correctly updates peak_premium = MAX(existing peak_premium, current_premium)
- [ ] Test 9: Multi-exit realized_return_pct = SUM(all position_exits.realized_pnl) / position_size after full close
- [ ] Test 10: Options x100 multiplier is correctly applied in cash calculations (proceeds = exit_premium * contracts * 100)

## Technical Notes
- Tests use hand-written fixtures with mock premium data and mock options position objects.
- Test 7 verifies PIPE-047: portfolio cash updated with proceeds, not realized_pnl.
- Test 9 verifies PIPE-049: realized_return_pct aggregation from multiple exits.
- Test 10 is a specific regression test for the x100 multiplier (common source of bugs in options code).
- Use pytest with mock positions containing entry_premium, contracts_remaining, expiration_date, peak_premium.

## Dependencies
- Depends on: story-006-005 (expiration), story-006-006 (premium exits), story-006-007 (time stop), story-006-009 (partial exit mechanics)
- Blocks: none
