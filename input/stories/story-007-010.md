---
id: story-007-010
epic: epic-007
title: Write API Endpoint Unit Tests
priority: medium
story_points: [TBD]
source_requirements: [API-ENVELOPE, API-PAGINATION, API-ERROR-CODES, API-ASYNC]
dependencies: [story-007-009]
blocks: []
---

# Story: Write API Endpoint Unit Tests

## Description
Write unit tests for the REST API layer covering endpoint behavior, error handling, pagination edge cases, and async analysis lifecycle. Epic-007 previously had zero dedicated test stories; these tests validate the API contract that the Vue dashboard (epic-008) depends on.

## Acceptance Criteria
- [ ] Test 1 (pagination boundary - offset > total): GET /signals with offset=100 when only 5 signals exist; verify 200 response with empty data array and correct total count
- [ ] Test 2 (pagination boundary - limit=0): verify either a VALIDATION_ERROR response or an empty data array (document expected behavior)
- [ ] Test 3 (invalid filter values): GET /positions with status='invalid_status'; verify VALIDATION_ERROR response with descriptive error message
- [ ] Test 4 (invalid ID - NOT_FOUND): GET /signals/99999 for non-existent ID; verify NOT_FOUND error response
- [ ] Test 5 (concurrent POST /analyze rejection): start an analysis run, then POST /analyze again; verify HTTP 409 response with active run_id in error details
- [ ] Test 6 (POST /analyze success): POST /analyze when no run is active; verify HTTP 202 response with run_id returned
- [ ] Test 7 (startup recovery): simulate a run with status='running' in DB, trigger FastAPI startup; verify the run status is set to 'failed' with an error message
- [ ] Test 8 (manual close validation): POST /positions/{id}/close with missing reason field; verify VALIDATION_ERROR response
- [ ] Test 9 (manual close success): POST /positions/{id}/close with valid payload; verify position_exits record created with exit_reason='manual_close' and portfolio cash updated
- [ ] Test 10 (response envelope structure): verify all endpoint responses include the standard envelope: data/error at top level, meta with timestamp and version
- [ ] All tests use FastAPI TestClient (httpx) with a test database; no external API calls
- [ ] Tests run with pytest and complete in under 10 seconds

## Technical Notes
- Use FastAPI's TestClient for synchronous test execution against the app instance
- Create a test database fixture (in-memory SQLite or temp file) with seed data from story-007-004 pattern
- The 409 test requires inserting a 'running' analysis_runs record before the second POST
- Startup recovery test should invoke the FastAPI lifespan/startup event handler directly
- Manual close tests should verify both the position_exits INSERT and the portfolio cash_available UPDATE
- Consider using pytest fixtures for database setup/teardown to ensure clean state between tests
- PRD reference: API-ENVELOPE, API-PAGINATION, API-ERROR-CODES, API-ASYNC, API-STALE-RECOVERY

## Dependencies
- Depends on: story-007-009 (all API endpoints including prediction endpoints must be implemented)
- Blocks: none
