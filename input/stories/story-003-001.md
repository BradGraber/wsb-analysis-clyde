---
id: story-003-001
epic: epic-003
title: Set Up OpenAI Client with Cost Tracking
priority: high
story_points: [TBD]
source_requirements: [INT-OPENAI, NFR-009]
dependencies: [epic-001]
blocks: [story-003-002]
---

# Story: Set Up OpenAI Client with Cost Tracking

## Description
Configure the OpenAI client with bearer token authentication from the OPENAI_API_KEY environment variable. Implement request/response handling for the GPT-4o-mini chat completions endpoint, base error handling for API failures, and cost tracking that logs warnings when monthly costs exceed $60.

## Acceptance Criteria
- [ ] OpenAI client authenticates using bearer token from OPENAI_API_KEY environment variable
- [ ] Missing or empty OPENAI_API_KEY raises a clear error message at client initialization (not deferred to first API call)
- [ ] Client sends requests to the POST /v1/chat/completions endpoint using the gpt-4o-mini model
- [ ] API responses are received and raw JSON content is returned to callers (parsing is handled by story-003-005)
- [ ] API errors (connection timeout, 5xx server errors) are caught and logged via structlog with request context (model, token count)
- [ ] Cost tracking: token usage (prompt_tokens, completion_tokens) from each API response is logged, and a running monthly total is maintained; a warning is logged when monthly costs exceed $60 per NFR-009
- [ ] Cost estimation uses GPT-4o-mini pricing rates to convert token counts to dollar amounts
- [ ] Monthly cost counter resets when the calendar month changes between runs (e.g., January costs reset to $0.00 on the first February run)

## Technical Notes
- Use the official openai Python SDK (openai.ChatCompletion.create or openai.chat.completions.create depending on SDK version)
- Expected cost: ~$0.10 per 500 comments ($45/month at 3 runs/day per NFR-009)
- Cost tracking can use a simple in-memory counter reset monthly, or query a running total from analysis_runs table
- The $60 threshold is a log warning only -- no hard limit enforcement for Phase 1
- This client wrapper will be consumed by story-003-004 (concurrent batching) and story-002-002 (image analysis)
- Base error handling here covers connection-level errors; rate limiting (429) is handled in story-003-006
- PRD reference: INT-OPENAI, NFR-009, Section 3.2.2 Phase 3 step 2

## Dependencies
- Depends on: epic-001 (database schema for analysis_runs table to track costs)
- Blocks: story-003-002 (prompt engineering needs the client available for testing prompts)
