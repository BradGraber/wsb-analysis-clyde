---
id: story-005-008
epic: epic-005
title: Implement Stop-Loss and Take-Profit Calculation at Entry
priority: high
story_points: [TBD]
source_requirements: [PIPE-038]
dependencies: [story-005-007]
blocks: [story-005-009]
---

# Story: Implement Stop-Loss and Take-Profit Calculation at Entry

## Description
Calculate and store stop-loss and take-profit price levels at position creation time. For stock positions, compute price-based thresholds: stop_loss_price = entry_price * (1 + stop_loss_pct) and take_profit_price = entry_price * (1 + take_profit_pct). For options positions, record the premium-based monitoring parameters (thresholds stored on the position record, evaluated by epic-006 exit monitoring). All percentages are read from system_config.

## Acceptance Criteria
- [ ] Stock stop_loss_price is calculated as entry_price * (1 + stock_stop_loss_pct) where stock_stop_loss_pct is from system_config (negative value, e.g., -0.10 for 10% loss)
- [ ] Stock take_profit_price is calculated as entry_price * (1 + stock_take_profit_pct) where stock_take_profit_pct is from system_config (positive value, e.g., +0.15 for 15% gain)
- [ ] Options positions store entry_price as the premium baseline for percentage-based monitoring by epic-006
- [ ] stop_loss_price and take_profit_price are written to the positions table at position creation time
- [ ] All percentage thresholds (stock_stop_loss_pct, stock_take_profit_pct, options premium thresholds) are read from system_config, not hardcoded
- [ ] Calculation handles both bullish (long stock/call) and bearish (put) positions correctly with appropriate directional math

## Technical Notes
- PIPE-038: Calculate stop/take-profit at entry for stocks (price-based) and options (premium-percentage monitoring)
- For stock long positions: stop_loss_pct is negative (e.g., -0.10), so stop_loss_price < entry_price; take_profit_pct is positive, so take_profit_price > entry_price
- For options: there are no separate stop_loss_price / take_profit_price fields; monitoring is done via premium_change_pct thresholds in epic-006
- Options entry_price IS the premium baseline; epic-006 compares current_premium / entry_premium to threshold percentages
- This story runs immediately after position INSERT (story-005-007) and updates the position record
- Consider integrating this calculation into the position creation flow rather than as a separate UPDATE

## Dependencies
- Depends on: story-005-007 (position must exist with entry_price before thresholds can be calculated)
- Blocks: story-005-009 (unit tests)
