---
id: story-006-001
epic: epic-006
title: Implement Tiered Price Data Fetching
priority: high
story_points: [TBD]
source_requirements: [FR-014, FR-049, PIPE-042, PIPE-043, FR-031, INT-YFINANCE]
dependencies: [epic-001]
blocks: [story-006-008]
---

# Story: Implement Tiered Price Data Fetching

## Description
Build the tiered price data fetching system that retrieves intraday candle data from Schwab (5-minute candles for same-day) and daily OHLC from yfinance for multi-day gaps. Derive last_check_time from analysis_runs table (first run uses started_at, subsequent runs use prior completed run's started_at). Merge all candles into a single chronologically-sorted sequence for downstream processing.

## Acceptance Criteria
- [ ] last_check_time is derived from analysis_runs: first run uses started_at, subsequent runs use prior completed run's started_at
- [ ] Same-day monitoring fetches Schwab 5-minute candle data for the current trading day
- [ ] Multi-day gaps fetch yfinance daily OHLC for missed calendar days plus Schwab 5-minute candles for today
- [ ] All fetched candles are merged into a single list sorted chronologically (oldest first)
- [ ] Each candle in the merged sequence contains at minimum: open, high, low, close, timestamp
- [ ] Function returns empty candle list (no error) when no price data is available for a ticker
- [ ] On the very first run (no prior analysis_runs exist), last_check_time defaults to the current run's started_at (current day only, no historical lookback)
- [ ] If all price data sources fail for a ticker (both Schwab AND yfinance), that ticker's monitoring is skipped with a warning logged

## Technical Notes
- PIPE-042: Derive last_check_time from analysis_runs table. Query the most recent completed run's started_at timestamp.
- PIPE-043: Tiered strategy -- determine gap size by comparing last_check_time to current time. If same trading day, only Schwab. If multi-day, yfinance daily OHLC for gap days + Schwab for today.
- FR-031: Intraday monitoring uses Schwab real-time + 5-min candles. Multi-day gaps use yfinance daily OHLC.
- INT-YFINANCE: No authentication required. Use yfinance library for historical daily OHLC data.
- Schwab client is provided by epic-001; this story consumes it.
- Candle data structure should be normalized so downstream consumers (candle iteration, peak tracking) do not need to know the data source.
- Price data fetched during Phase 6 should be stored in a per-run in-memory cache keyed by ticker. This cache is populated during real position monitoring and consumed by prediction monitoring (story-006-019) to avoid duplicate Schwab API calls for tickers shared between positions and predictions.

## Dependencies
- Depends on: epic-001 (Schwab client, database schema, analysis_runs table)
- Blocks: story-006-008 (candle iteration logic), story-006-012 (price history UPSERT), story-006-013 (retry/fallback)
