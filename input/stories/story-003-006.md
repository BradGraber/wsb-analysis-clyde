---
id: story-003-006
epic: epic-003
title: Implement Malformed JSON Retry Logic
priority: high
story_points: [TBD]
source_requirements: [PIPE-022, ERR-MALFORMED-JSON, ERR-OPENAI-RATE]
dependencies: [story-003-005]
blocks: []
---

# Story: Implement Malformed JSON Retry Logic

## Description
Handle two error scenarios from OpenAI API responses: malformed JSON (unparseable response) and rate limiting (HTTP 429). On malformed JSON, retry once; on second failure, skip the comment, log a warning, and continue. On 429 rate limit, apply exponential backoff (1s, 2s, 4s, 8s, max 30s) with up to 3 retries.

## Acceptance Criteria
- [ ] Malformed JSON handling: if the AI response cannot be parsed as valid JSON, retry the same API call once with the identical prompt
- [ ] If the retry also returns malformed JSON: skip the comment entirely, log a warning via structlog with comment reddit_id and the raw response content, and continue to the next comment
- [ ] Skipped comments do not cause the batch or pipeline to fail; processing continues normally
- [ ] Rate limit (429) handling: on HTTP 429 response, apply exponential backoff starting at 1 second and doubling (1s, 2s, 4s, 8s) with a maximum delay of 30 seconds
- [ ] Rate limit retries: up to 3 retry attempts after the initial 429 response; if all retries receive 429, log error and skip the comment
- [ ] Both retry mechanisms are applied per-comment (not per-batch): one comment's retry does not block or delay the retry logic of another comment in the same concurrent batch
- [ ] All retry events are logged via structlog with: retry attempt number, delay duration, comment reddit_id, error type (malformed_json or rate_limit)

## Technical Notes
- Malformed JSON retry uses the shared retry_with_backoff() utility from epic-001 story-001-008 configured for 1 retry, no backoff
- Rate limit backoff uses the same utility configured for exponential backoff with delays [1, 2, 4, 8] capped at 30s
- The retry logic wraps the individual API call + parse cycle: if the response is structurally invalid JSON, it retries the API call itself (not just re-parsing)
- GPT-4o-mini occasionally returns responses with extra text around the JSON (handled by stripping in story-003-005) vs truly malformed JSON (handled here)
- PRD reference: Appendix E.9 error handling table, ERR-MALFORMED-JSON, ERR-OPENAI-RATE

## Dependencies
- Depends on: story-003-005 (parsing logic defines what constitutes "malformed")
- Blocks: none
