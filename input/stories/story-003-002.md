---
id: story-003-002
epic: epic-003
title: Engineer AI Prompts for Sentiment Analysis
priority: high
story_points: [TBD]
source_requirements: [FR-002, AI-SYSTEM-PROMPT, AI-USER-PROMPT, AI-CONFIDENCE-SCORING, PIPE-016]
dependencies: [story-003-001]
blocks: [story-003-004]
---

# Story: Engineer AI Prompts for Sentiment Analysis

## Description
Implement the system prompt and user prompt template for GPT-4o-mini sentiment analysis. The system prompt establishes WSB communication style context (sarcasm, memes, inverse statements). The user prompt template injects post title, image analysis, parent chain, author trust score, and comment body. Include confidence scoring guidelines (base 0.5 with modifiers) in the prompt instructions.

## Acceptance Criteria
- [ ] System prompt matches PRD Appendix E.2: includes WSB communication style context covering sarcasm, self-deprecating humor, inverse statements, meme language definitions (diamond hands, paper hands, tendies, to the moon, GUH, apes, regarded), and the four analysis tasks (see through sarcasm, extract tickers, identify reasoning, assess confidence)
- [ ] User prompt template matches PRD Appendix E.3 structure with placeholders for: post_title, image_description (if available), parent_chain_formatted, author username, author_trust score, and comment_body
- [ ] User prompt includes the exact JSON response structure from Appendix E.3 with all 7 fields: tickers, ticker_sentiments, sentiment, sarcasm_detected, has_reasoning, confidence, reasoning_summary
- [ ] User prompt includes the three response rules: ticker_sentiments must have one entry per ticker, sentiment matches single-ticker sentiment, reasoning_summary is null when has_reasoning is false
- [ ] Confidence scoring guidelines from Appendix E.6 are embedded in the prompt: base 0.5 with modifiers (+0.2 clear statement, +0.2 reasoning, +0.1 high trust, -0.2 ambiguous sarcasm, -0.2 meme-heavy, -0.1 contradicts parent)
- [ ] Parent chain formatting converts ParentChainEntry array into readable threaded context (showing depth, author, and body for each ancestor)
- [ ] When image_analysis is null or empty, the image context section is omitted from the prompt (not sent as empty string)

## Technical Notes
- Prompts are defined as string templates (f-strings, Jinja2, or string.format) with clear variable injection points
- The system prompt is static (same for every API call); the user prompt varies per comment
- Prompt templates should be stored as module-level constants or in a dedicated prompts module for easy iteration
- Parent chain formatting example: "Reply to user123 (depth 1): 'I think NVDA...' -> Reply to trader456 (depth 0): 'Original comment...'"
- Image context is supplementary; comments without post images should still produce valid prompts
- PRD reference: Appendix E.2 (system prompt), E.3 (user prompt), E.6 (confidence scoring)

## Dependencies
- Depends on: story-003-001 (client available for prompt testing)
- Blocks: story-003-004 (concurrent batching needs complete prompts to send)
