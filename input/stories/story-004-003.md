---
id: story-004-003
epic: epic-004
title: Implement Consensus Signal Detection
priority: high
story_points: [TBD]
source_requirements: [FR-001, FR-016, FR-017, PIPE-026]
dependencies: [story-004-001, story-004-004]
blocks: [story-004-006]
---

# Story: Implement Consensus Signal Detection

## Description
Implement the Consensus signal detection algorithm that counts total comments (excluding neutral per-ticker sentiment), distinct users, and calculates directional alignment percentage. Signal fires when comment count >= 30, distinct users >= 8, and alignment >= 70%. All thresholds are read from system_config at runtime.

## Acceptance Criteria
- [ ] Total comment count is calculated per ticker, excluding comments with neutral per-ticker sentiment (comment_tickers.sentiment = 'neutral')
- [ ] Distinct user count is calculated among non-neutral comments for each ticker
- [ ] Alignment percentage is calculated as max(bullish_count, bearish_count) / (bullish_count + bearish_count) using comment_tickers.sentiment
- [ ] Signal fires when comment_count >= consensus_min_comments (default 30), distinct_users >= consensus_min_users (default 8), AND alignment >= consensus_min_alignment (default 0.7)
- [ ] Signal direction is set to the majority sentiment direction (bullish if bullish_count > bearish_count, bearish otherwise)
- [ ] Division-by-zero is handled when all comments for a ticker are neutral (no signal fires, no error)
- [ ] All threshold values (consensus_min_comments, consensus_min_users, consensus_min_alignment) are read from system_config table at runtime
- [ ] When bullish_count equals bearish_count (50% alignment), the signal does not fire because alignment is below consensus_min_alignment (0.7)

## Technical Notes
- PIPE-026: Consensus signal calculation excludes neutral comments from alignment denominator
- Volume score for Consensus signals uses total comment count (not distinct users), per confidence calculation formula
- Alignment score for Consensus signals uses the formula: (actual_alignment - min_alignment) / (1.0 - min_alignment)
- Edge case: exactly 0 bullish and 0 bearish (all neutral) should gracefully produce no signal
- This story produces signal metadata that feeds into story-004-004 (confidence calculation) and story-004-006 (rollup)

## Dependencies
- Depends on: story-004-001 (comment aggregation), story-004-004 (confidence calculation)
- Blocks: story-004-006 (daily rollup)
