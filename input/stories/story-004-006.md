---
id: story-004-006
epic: epic-004
title: Implement Daily Signal Rollup
priority: high
story_points: [TBD]
source_requirements: [FR-039, PIPE-029, PIPE-030]
dependencies: [story-004-002, story-004-003]
blocks: [story-004-007]
---

# Story: Implement Daily Signal Rollup

## Description
Implement the daily signal UPSERT pattern that creates or updates signal records using the UNIQUE constraint on (ticker, signal_type, signal_date). First run in a day creates the signal with created_at; subsequent runs update with new data and updated_at. Populate the signal_comments junction table linking each contributing comment to its signal. Set position_opened=false on new signals.

## Acceptance Criteria
- [ ] UPSERT uses ON CONFLICT (ticker, signal_type, signal_date) DO UPDATE to handle multiple runs per day
- [ ] First run of the day creates a new signal record with created_at timestamp and position_opened=false
- [ ] Subsequent runs on the same day update the existing signal record with recalculated values and updated_at timestamp
- [ ] Signal record stores: ticker, signal_type (quality/consensus), signal_date, direction, confidence, comment_count, user_count, is_emergence, position_opened
- [ ] signal_comments junction table is populated with (signal_id, comment_id) for every contributing comment
- [ ] Existing signal_comments rows for the signal are cleared and repopulated on update (to reflect recalculated contributing comments)
- [ ] position_opened defaults to false on INSERT and is NOT overwritten on UPDATE (preserves true if already set by position management)

## Technical Notes
- PIPE-029: UPSERT pattern with UNIQUE on (ticker, signal_type, signal_date). Use INSERT ... ON CONFLICT ... DO UPDATE SET.
- PIPE-030: INSERT INTO signal_comments for each contributing comment meeting signal criteria
- The UPSERT must NOT reset position_opened to false if it was already set to true by epic-005 (position management)
- Use excluded.* syntax in SQLite for the UPDATE SET clause
- Consider using a transaction wrapping the signal UPSERT + signal_comments repopulation
- signal_comments should be DELETE WHERE signal_id = ? then re-INSERT to handle comment set changes between runs

## Dependencies
- Depends on: story-004-002 (quality signals), story-004-003 (consensus signals)
- Blocks: story-004-007 (unit tests)
