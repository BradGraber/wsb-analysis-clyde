---
id: story-009-005
epic: epic-009
title: Implement Evaluation Period Creation
priority: high
story_points: [TBD]
source_requirements: [PIPE-054, NFR-003]
dependencies: [epic-001]
blocks: [story-009-006]
---

# Story: Implement Evaluation Period Creation

## Description
Implement the creation of evaluation periods for all 4 portfolios in lockstep. When the system detects no active evaluation period exists (first-ever run or after a period completes), create 4 evaluation_periods rows -- one for each portfolio (stocks_quality, stocks_consensus, options_quality, options_consensus). All 4 rows share the same period_start (today) and period_end (today + 30 days), with status='active'. Each row records the portfolio's instrument_type, signal_type, and value_at_period_start (current portfolio value). The 4 inserts are wrapped in a single database transaction for atomicity.

## Acceptance Criteria
- [ ] When no active evaluation period exists, exactly 4 evaluation_periods rows are created (one per portfolio: stocks_quality, stocks_consensus, options_quality, options_consensus)
- [ ] All 4 rows share identical period_start (current date) and period_end (period_start + 30 days) values for lockstep synchronization
- [ ] Each row correctly records instrument_type ('stock' or 'option') and signal_type ('quality' or 'consensus') matching its portfolio
- [ ] value_at_period_start is populated from the portfolio's current_value at time of creation
- [ ] All 4 rows are INSERTed within a single database transaction -- if any insert fails, all are rolled back
- [ ] status is set to 'active' for all 4 rows
- [ ] If an active period already exists and has not expired, no new periods are created (idempotent check)
- [ ] If multiple active evaluation periods exist for a portfolio (data integrity issue), log a warning and do not create additional periods

## Technical Notes
- Pipeline step: Phase 7b "Evaluation Period Management" (PRD Section 3.2.2 lines 383-389)
- PRD specifies: "If no active period exists (first ever run): CREATE 4 evaluation_periods rows" (line 386)
- The 4 portfolios are defined in the portfolios table by epic-001: (stocks, quality), (stocks, consensus), (options, quality), (options, consensus)
- The check is: "Query evaluation_periods for any active period (status = 'active')" (line 385)
- If active period exists and period_end >= today: no action needed (line 389)
- This story handles creation only; completion/rollover is story-009-006

## Dependencies
- Depends on: epic-001 (database schema for evaluation_periods and portfolios tables)
- Blocks: story-009-006 (evaluation period completion depends on active periods existing)
