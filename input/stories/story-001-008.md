---
id: story-001-008
epic: epic-001
title: Build Shared Error Handling Module with Retry, Warnings, and Structured Logging
priority: high
story_points: [TBD]
source_requirements: [ERR-TIER2, ERR-LOGGING, PIPE-055, PIPE-056]
dependencies: []
blocks: []
---

# Story: Build Shared Error Handling Module with Retry, Warnings, and Structured Logging

## Description
Create the shared error handling infrastructure module containing three components: (1) a `retry_with_backoff()` utility for Tier 2 retry logic with configurable exponential backoff, (2) a `WarningsCollector` class for accumulating non-fatal degradation events during analysis runs (7 warning types), and (3) structlog configuration for JSON-formatted structured logging to `logs/backend.log`. These utilities are consumed by virtually every pipeline phase across epics 002-009.

## Acceptance Criteria
- [ ] `retry_with_backoff(fn, max_retries, base_delay, max_delay)` executes the callable `fn`, retrying on specified exception types with exponential backoff delays (e.g., 1s, 2s, 4s, 8s up to max_delay=30s), returning the result on success or raising the final exception after max_retries exhausted
- [ ] retry_with_backoff supports configurable parameters: max_retries (default 3-5), base_delay (default 1s), max_delay (default 30s), and a list of retryable exception types
- [ ] `WarningsCollector` class provides `append(warning_type: str, message: str, context: dict)` to add a warning, and `to_json() -> Optional[str]` to serialize the collected warnings as a JSON array string (returns None if no warnings collected)
- [ ] WarningsCollector supports all 7 warning types: schwab_stock_unavailable, schwab_options_unavailable, image_analysis_failed, market_hours_skipped, insufficient_cash, schwab_prediction_unavailable, prediction_strike_unavailable
- [ ] Each warning object in the JSON array contains: type, message, timestamp (ISO format), and context (dict)
- [ ] structlog is configured to output JSON-formatted log entries to `logs/backend.log` with standard log levels (DEBUG, INFO, WARNING, ERROR, CRITICAL), including full stack traces on ERROR and CRITICAL
- [ ] When calculated backoff exceeds max_delay, the delay is capped at max_delay (e.g., 64s -> 30s)
- [ ] WarningsCollector.append() is safe to call from multiple threads concurrently (thread-safe via internal lock)
- [ ] Unit tests verify: retry_with_backoff retries the correct number of times, WarningsCollector serializes correctly and returns None when empty, structlog produces valid JSON output

## Technical Notes
- The retry utility implements the Tier 2 error boundary pattern (PRD Section 3.6.4): exponential backoff with configurable delays
- The WarningsCollector implements PIPE-055 (warning type catalog) and PIPE-056 (in-memory append, JSON serialization on completion, NULL if empty)
- Warning write mechanism per PRD: append warning objects in-memory during the run, serialize the list as JSON and UPDATE analysis_runs.warnings on completion. If list is empty, leave warnings as NULL (not empty array)
- structlog JSON format supports the logging strategy defined in PRD Section 3.6.4: structured JSON for easy parsing, log levels from DEBUG through CRITICAL
- The logs/ directory should be created if it does not exist
- This module has no database dependencies and can be developed in parallel with other story-001 work
- While ERR-TIER2, ERR-LOGGING, PIPE-055, and PIPE-056 are formally traced to epic-007 for API integration, the shared utilities are built here in epic-001 as foundational infrastructure

## Dependencies
- Depends on: none (this is standalone infrastructure with no DB dependency)
- Blocks: none directly in epic-001 (but consumed by epics 002, 003, 005, 006, 007, 009)
