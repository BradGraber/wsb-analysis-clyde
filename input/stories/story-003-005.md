---
id: story-003-005
epic: epic-003
title: Implement AI Response Parsing
priority: high
story_points: [TBD]
source_requirements: [FR-034, PIPE-018, AI-RESPONSE-FORMAT, AI-TICKER-RULES]
dependencies: [story-003-004]
blocks: [story-003-006, story-003-009]
---

# Story: Implement AI Response Parsing

## Description
Parse the AI JSON response from GPT-4o-mini, validating the 7-field structure (tickers, ticker_sentiments, sentiment, sarcasm_detected, has_reasoning, confidence, reasoning_summary). Normalize tickers to uppercase, resolve common company names to ticker symbols, and exclude non-ticker words. Validate field types and value constraints.

## Acceptance Criteria
- [ ] Parse JSON response and extract all 7 fields: tickers (array), ticker_sentiments (array of {ticker, sentiment} objects), sentiment (string), sarcasm_detected (boolean), has_reasoning (boolean), confidence (float 0.0-1.0), reasoning_summary (string or null)
- [ ] Validate sentiment field accepts only "bullish", "bearish", or "neutral" (case-insensitive, normalized to lowercase)
- [ ] Validate confidence is a float between 0.0 and 1.0 (clamp values outside range rather than rejecting); when confidence is clamped, a debug-level log is emitted with the original value
- [ ] Validate reasoning_summary is null when has_reasoning is false; log warning if AI returns non-null reasoning_summary with has_reasoning=false
- [ ] Validate ticker_sentiments array has exactly one entry per ticker in the tickers array; log warning if counts mismatch
- [ ] Ticker normalization: all ticker symbols converted to uppercase (e.g., "nvda" -> "NVDA")
- [ ] Extra fields in the AI response JSON beyond the 7 expected are ignored (no validation error for unknown fields)
- [ ] Ticker resolution: resolve common company names to symbols per AI-TICKER-RULES (e.g., "the mouse" -> "DIS", "Zuck" -> "META"); include crypto tickers (BTC, ETH); exclude non-tickers ("I", "A", "CEO", "DD", "YOLO" unless in clear ticker context); deduplicate tickers within a single response

## Technical Notes
- The AI is instructed to return JSON, but GPT-4o-mini may wrap it in markdown code fences or include extra text; strip these before parsing
- Common company name resolution can use a static lookup dictionary (this is a convenience, not an exhaustive NLP task)
- Non-ticker exclusion list should be configurable for easy tuning
- If the AI returns an empty tickers array, this is valid (comment mentions no tickers) per Appendix E.9
- Malformed JSON (unparseable) is handled in story-003-006, not here; this story handles structurally valid but semantically invalid responses
- PRD reference: Appendix E.4 (expected format), E.5 (field definitions), E.7 (ticker rules)

## Dependencies
- Depends on: story-003-004 (raw API responses from concurrent batching)
- Blocks: story-003-006 (retry logic needs to know what constitutes a parse failure), story-003-009 (ticker junction population needs parsed tickers)
