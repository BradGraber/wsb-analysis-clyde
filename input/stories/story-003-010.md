---
id: story-003-010
epic: epic-003
title: Write Concurrency Unit Tests for Batch-of-5
priority: medium
story_points: [TBD]
source_requirements: [PIPE-017]
dependencies: [story-003-008]
blocks: []
---

# Story: Write Concurrency Unit Tests for Batch-of-5

## Description
Write 3 targeted unit tests for the batch-of-5 concurrent processing logic: verify all 5 workers succeed, verify graceful handling when 1 of 5 fails (remaining 4 succeed and failed one is logged), and verify commit timing (batch commits after all 5 complete, not after each individual worker).

## Acceptance Criteria
- [ ] Test 1 (all-succeed): submit a batch of 5 mock comments, verify all 5 concurrent API calls complete successfully, and all 5 results are returned with correct comment-to-result mapping
- [ ] Test 2 (1-of-5-fails): submit a batch of 5 mock comments where 1 API call raises an exception, verify the remaining 4 succeed and return results, and the failed comment's reddit_id and error are logged via structlog
- [ ] Test 3 (commit timing): verify that the database transaction COMMIT occurs only after ALL 5 API responses in the batch are collected, not after each individual response (no partial commits mid-batch)
- [ ] All tests use mocked OpenAI API responses (no real API calls) and mocked database connections
- [ ] Tests verify ThreadPoolExecutor is used with max_workers=5
- [ ] Tests run with pytest and complete in under 5 seconds (no real network delays)
- [ ] Each test has a clear docstring explaining the scenario being verified

## Technical Notes
- Use unittest.mock.patch or pytest-mock to mock the OpenAI client and database connection
- For test 2, the mock should raise an exception for one specific comment and return valid responses for the other 4
- For test 3, instrument the mock database to track when COMMIT is called relative to API responses; assert COMMIT is called once per batch, not per comment
- Consider using threading events or barriers to simulate realistic concurrent timing in tests
- These tests validate the orchestration logic, not the AI response content (that is tested elsewhere)
- PRD reference: PIPE-017 (concurrent processing specification)

## Dependencies
- Depends on: story-003-008 (batch commit logic must be implemented to test timing)
- Blocks: none
