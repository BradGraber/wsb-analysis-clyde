---
id: story-008-013
epic: epic-008
title: Write Error Injection and Regression Tests
priority: medium
story_points: [TBD]
source_requirements: [ERR-TIER1, ERR-TIER2, ERR-TIER3, ERR-TIER4]
dependencies: [story-008-010]
blocks: [story-008-014]
---

# Story: Write Error Injection and Regression Tests

## Description
Write 10 error injection tests covering the 4-tier error model and set up VCR.py for API mocking. Also write regression test #11: HITL override round-trip verifying that PATCH /predictions/{id}/override followed by GET reflects the change correctly.

## Acceptance Criteria
- [ ] VCR.py is configured for recording and replaying API interactions (Schwab, Reddit, OpenAI mock cassettes)
- [ ] 2-3 Tier 1 (hard fail) tests: simulate Reddit outage and SQLite write failure during Phase 3 batch commit (story-003-008); verify ROLLBACK occurs and pipeline continues to next batch, verify HTTP 5xx response and error logging
- [ ] 2-3 Tier 2 (retry with backoff) tests: simulate transient API failure, verify exponential backoff (1s-30s), verify escalation to Tier 1 after 3-5 retries exhausted
- [ ] 2-3 Tier 3 (graceful degradation) tests: simulate single comment analysis failure, verify pipeline continues with NULL/default, verify retry 3x before degrading
- [ ] 2-3 Tier 4 (log and continue) tests: simulate comment dedup collision and missing yfinance data, verify info-level logging, verify pipeline continues without error
- [ ] Regression test #11: PATCH /predictions/{id}/override with "correct" -> GET /predictions/{id} shows is_correct=true; repeat with "incorrect" -> is_correct=false; repeat with "excluded" -> is_correct=null
- [ ] All tests pass in CI with mocked APIs (no real external API calls)

## Technical Notes
- VCR.py setup: configure cassette directory at `tests/cassettes/`, record mode for initial capture, playback for CI
- Error injection: use monkeypatch/mock to simulate failures in specific pipeline phases
- Tier 1 tests may need to mock the database connection to simulate write failures
- Tier 2 tests should verify timing of backoff intervals (mock time.sleep to avoid slow tests)
- The HITL override regression test exercises the full round-trip: write -> read -> verify consistency
- Consider grouping tests by tier in separate test files: `test_tier1_errors.py`, `test_tier2_errors.py`, etc.
- Error tests should verify both the HTTP response and the structured log output (capture log records)

## Dependencies
- Depends on: story-008-010 (error banner and recovery patterns are exercised by error injection tests)
- Blocks: story-008-014 (E2E suite builds on error test infrastructure)
