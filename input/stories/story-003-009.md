---
id: story-003-009
epic: epic-003
title: Populate Comment Tickers Junction Table
priority: high
story_points: [TBD]
source_requirements: [PIPE-021, FR-021]
dependencies: [story-003-005, story-003-008]
blocks: []
---

# Story: Populate Comment Tickers Junction Table

## Description
For each AI-extracted ticker-sentiment pair from the parsed response, insert a record into the comment_tickers junction table linking the comment to the ticker with its per-ticker sentiment direction. These records are the foundation for Phase 4 signal detection, which groups comments by ticker.

## Acceptance Criteria
- [ ] For each entry in the AI response's ticker_sentiments array, INSERT INTO comment_tickers (comment_id, ticker, sentiment) using the per-ticker sentiment direction ("bullish", "bearish", or "neutral")
- [ ] The comment_id foreign key references the comments table id (not reddit_id)
- [ ] Ticker values are stored as uppercase strings (normalized in story-003-005)
- [ ] The UNIQUE constraint on (comment_id, ticker) prevents duplicate entries; use INSERT OR IGNORE to handle gracefully
- [ ] Comments with empty tickers arrays result in zero comment_tickers inserts (valid scenario per Appendix E.9)
- [ ] Junction table inserts are included within the batch-of-5 transaction boundary from story-003-008 (committed together with the parent comment record)

## Technical Notes
- The comment_tickers table is critical for Phase 4 signal detection: signals are grouped by ticker using this junction table
- Per-ticker sentiment (from ticker_sentiments array) may differ from overall comment sentiment when a comment discusses multiple tickers with different directions (e.g., bullish NVDA but bearish AMD)
- The junction table also feeds Phase 3.5 prediction creation (epic-006): each comment_ticker generates a simulated options prediction
- Schema: comment_tickers(id, comment_id FK, ticker VARCHAR, sentiment VARCHAR) with UNIQUE(comment_id, ticker)
- PRD reference: Section 3.2.2 Phase 3 step 2 bullet 6, PIPE-021, FR-021

## Dependencies
- Depends on: story-003-005 (parsed and normalized tickers from AI response), story-003-008 (transaction boundary for atomic commit)
- Blocks: none (consumed by epic-004 signal detection and epic-006 prediction creation)
