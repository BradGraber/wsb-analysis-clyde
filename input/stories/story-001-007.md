---
id: story-001-007
epic: epic-001
title: Validate SQLite Concurrency with WAL Mode Isolation Test
priority: medium
story_points: [TBD]
source_requirements: [DB-WAL]
dependencies: [story-001-004]
blocks: []
---

# Story: Validate SQLite Concurrency with WAL Mode Isolation Test

## Description
Time-boxed spike (~0.5 days) to validate that SQLite WAL mode enables concurrent read access while a background thread is writing. This spike confirms that the FastAPI request-handling thread can read from the database (e.g., polling analysis run status) while the background pipeline thread is actively writing results. A simple test script demonstrates this concurrency pattern and documents any limitations.

## Acceptance Criteria
- [ ] A test script launches a background thread that performs sustained writes to a test table (e.g., inserting 100+ rows with small delays between batches)
- [ ] While the background thread is writing, the main thread successfully reads from the same database without blocking or receiving lock errors
- [ ] The test confirms that WAL mode is active by checking `PRAGMA journal_mode` returns 'wal'
- [ ] The test documents the observed behavior: whether reads are truly non-blocking, any lock timeout scenarios encountered, and the effective concurrency level
- [ ] The test runs successfully and produces a clear pass/fail result with timing data (e.g., "100 reads completed in Xms while background thread wrote 500 rows")

## Technical Notes
- SQLite in WAL mode allows one writer and multiple concurrent readers
- Without WAL mode, SQLite uses a rollback journal that blocks readers during writes
- The test should use two separate connections (one per thread) via the connection manager from story-001-004
- Python threading with sqlite3 requires either `check_same_thread=False` or separate connections per thread
- The background pipeline (epic-007) uses a background thread for the analysis pipeline while FastAPI handles GET requests on the main thread -- this is the exact concurrency pattern being validated
- Expected outcome: WAL mode should work fine for this use case (single writer, few readers). The spike confirms this assumption and documents any edge cases
- If the spike reveals issues, document mitigation strategies (e.g., retry on SQLITE_BUSY, connection timeout settings)

## Dependencies
- Depends on: story-001-004 (needs connection manager to create properly configured connections)
- Blocks: none (this is a validation spike; if it fails, we need to revisit architecture)
