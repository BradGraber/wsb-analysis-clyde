---
id: story-006-012
epic: epic-006
title: Implement Price History UPSERT
priority: high
story_points: [TBD]
source_requirements: [PIPE-050, DB-PRICE-HISTORY]
dependencies: [story-006-001]
blocks: []
---

# Story: Implement Price History UPSERT

## Description
Implement the price history persistence layer that stores daily OHLC data fetched during monitoring. After fetching prices for each monitored ticker, UPSERT into price_history using INSERT OR REPLACE keyed on the UNIQUE(ticker, date) constraint to avoid duplicates across multiple /analyze runs per day.

## Acceptance Criteria
- [ ] Daily OHLC data (open, high, low, close) is stored in the price_history table for each monitored ticker
- [ ] Uses INSERT OR REPLACE keyed on UNIQUE(ticker, date) constraint to handle duplicate entries
- [ ] Multiple /analyze runs on the same day update existing price_history records rather than creating duplicates
- [ ] fetched_at timestamp is recorded for each price_history entry
- [ ] Both yfinance-sourced and Schwab-sourced daily data are persisted
- [ ] Price history entries are created for each calendar day in multi-day gap fills (one row per day)

## Technical Notes
- PIPE-050: Price history UPSERT using INSERT OR REPLACE on UNIQUE(ticker, date).
- DB-PRICE-HISTORY: Table schema includes ticker, date, open, high, low, close, fetched_at.
- This runs after the price fetching step (story-006-001) for each ticker being monitored.
- For multi-day gaps, yfinance provides daily OHLC for each missed day -- each day gets its own row.
- For same-day Schwab data, aggregate the 5-minute candles into a single daily OHLC row.
- The UNIQUE constraint on (ticker, date) ensures idempotent writes.

## Dependencies
- Depends on: story-006-001 (tiered price data fetching provides the OHLC data to persist)
- Blocks: none
