---
id: story-006-016
epic: epic-006
title: Write Stock Exit Unit Tests
priority: medium
story_points: [TBD]
source_requirements: [FR-026, FR-027, FR-028, FR-029, FR-030]
dependencies: [story-006-002, story-006-003, story-006-004]
blocks: []
---

# Story: Write Stock Exit Unit Tests

## Description
Write 9 unit tests covering all stock exit conditions: stop-loss trigger, take-profit trigger, partial take-profit 50% exit, trailing stop after partial, breakeven promotion at +5%/Day 5, and the three time extension tiers (base 5 days, extended 7 days, trailing 10 days), plus candle iteration with multiple trigger points in a single candle.

## Acceptance Criteria
- [ ] Test 1: Stop-loss triggers correctly when candle low breaches entry_price * 0.90
- [ ] Test 2: Take-profit triggers correctly when candle high breaches entry_price * 1.15
- [ ] Test 3: Partial take-profit exits exactly 50% of shares_remaining and sets trailing_stop_active = TRUE
- [ ] Test 4: Trailing stop triggers at peak_price * 0.93 after partial take-profit, closes remaining shares
- [ ] Test 5: Breakeven promotion updates stop_loss_price to entry_price at +5% gain AND Day 5, and exit fires as 'breakeven_stop'
- [ ] Test 6: Base time stop triggers at Day 5 when gain < +5%
- [ ] Test 7: Extended time stop triggers at Day 7 when gain was +5% to +15% at Day 5
- [ ] Test 8: Trailing time stop triggers at Day 10 after partial take-profit occurred
- [ ] Test 9: Candle iteration with both stop-loss and take-profit breached in same candle resolves to stop-loss (higher priority)

## Technical Notes
- Tests use hand-written fixtures with mock candle data and mock position objects.
- Each test isolates a single exit condition function using the hybrid architecture (private functions).
- Test 9 validates PIPE-044 priority ordering within candle iteration logic.
- Use pytest with mock positions, mock candle sequences, and assertions on exit reason, exit price, and quantity.
- Mock data should include edge cases: exact trigger price matches, prices that barely miss triggers.

## Dependencies
- Depends on: story-006-002 (stop-loss/take-profit), story-006-003 (partial/trailing), story-006-004 (breakeven/time)
- Blocks: none
