---
id: story-004-007
epic: epic-004
title: Write Signal Detection Unit Tests
priority: medium
story_points: [TBD]
source_requirements: [FR-015, FR-016, FR-040, FR-019]
dependencies: [story-004-006]
blocks: []
---

# Story: Write Signal Detection Unit Tests

## Description
Write comprehensive unit tests covering the signal detection pipeline: Quality signal with exactly 2 qualifying users, Consensus signal at threshold boundaries, confidence calculation with known weights, emergence detection crossing threshold, daily rollup UPSERT behavior (create then update), and signal_comments junction population. Tests use hand-written fixtures per project conventions.

## Acceptance Criteria
- [ ] Quality signal test: exactly 2 users with has_reasoning=true, sarcasm_detected=false, ai_confidence >= 0.6, unanimous direction produces a fired signal
- [ ] Quality signal negative test: 2 qualifying users with conflicting directions does NOT produce a signal
- [ ] Consensus signal test: exactly 30 comments, 8 users, 70% alignment produces a fired signal
- [ ] Consensus signal boundary test: 29 comments OR 7 users OR 69% alignment does NOT produce a signal
- [ ] Confidence calculation test: known inputs with default weights (0.25/0.25/0.30/0.20) produce expected confidence value within floating-point tolerance
- [ ] Emergence detection test: prior_mentions=2, current_mentions=13, current_users=8 fires emergence; prior_mentions=3 does not
- [ ] Daily rollup test: first UPSERT creates signal, second UPSERT on same (ticker, signal_type, signal_date) updates without creating duplicate
- [ ] signal_comments junction test: contributing comments are linked to signal, and re-linking on update replaces old associations
- [ ] Quality signal negative test: 1 qualifying user (below quality_min_users=2) does NOT produce a signal
- [ ] Consensus edge case test: all comments are neutral sentiment -- no signal fires, no division-by-zero error

## Technical Notes
- Use hand-written fixtures (no VCR.py needed -- this is pure database/logic testing with no external API calls)
- Test confidence calculation with exact expected values: e.g., volume_score=0.333, alignment_score=1.0, avg_ai_confidence=0.8, avg_author_trust=0.5 -> expected confidence
- Test the position_opened preservation: UPSERT after position_opened=true must not reset it to false
- Consider parameterized tests for boundary conditions (threshold - 1, threshold, threshold + 1)
- All tests should use an in-memory SQLite database with the full schema

## Dependencies
- Depends on: story-004-006 (all signal detection stories must be complete)
- Blocks: none
