---
id: story-002-002
epic: epic-002
title: Implement Image Detection and Vision Analysis
priority: high
story_points: [TBD]
source_requirements: [PIPE-003, PIPE-004, FR-046, ERR-IMAGE-FAIL]
dependencies: [story-002-001]
blocks: []
---

# Story: Implement Image Detection and Vision Analysis

## Description
Detect post images by matching against three URL patterns (i.redd.it, imgur, preview.redd.it) and analyze detected images synchronously via GPT-4o-mini vision API. Implement retry logic with graduated backoff (2s, 5s, 10s) on failure, with graceful degradation to NULL image_analysis if all retries fail.

## Acceptance Criteria
- [ ] Image URL detection correctly identifies all three patterns: URLs containing "i.redd.it", "imgur", and "preview.redd.it" (including subdomains and path variations)
- [ ] Posts without image URLs have image_url set to null and image_analysis set to null (no API call made)
- [ ] Detected images are analyzed synchronously via OpenAI GPT-4o-mini vision API, extracting visual context (charts, earnings data, tickers from screenshots)
- [ ] On image analysis failure (network error, invalid image, API error, timeout): retry up to 3 times with graduated backoff delays of 2 seconds, 5 seconds, and 10 seconds
- [ ] After 3 failed retries: log a warning "Image analysis failed for post {post_id}: {error}" via structlog, set image_analysis to NULL in the ProcessedPost, and continue processing (no exception raised)
- [ ] Successfully analyzed images populate both image_url and image_analysis fields on the ProcessedPost object
- [ ] Image analysis results are stored in the reddit_posts table alongside the post record

## Technical Notes
- Image analysis is synchronous and occurs during Phase 1 (Acquisition), before comment fetching
- Only 10 posts maximum, so synchronous analysis is acceptable for the 30-minute total runtime budget
- The vision API call sends the image URL directly (not downloaded image bytes) to GPT-4o-mini
- Uses the shared retry_with_backoff() utility from epic-001 story-001-008 with custom delays [2, 5, 10]
- Image analysis text becomes part of the AI prompt context in epic-003 (Appendix E.1: image_context field)
- PRD reference: Section 3.2.2 Phase 1 step 3, Appendix E.9 "Image Analysis Failure Handling"

## Dependencies
- Depends on: story-002-001 (posts must be fetched before image detection)
- Blocks: none directly (image_analysis is supplementary context; comment analysis proceeds regardless)
