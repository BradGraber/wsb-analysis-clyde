---
id: story-004-001
epic: epic-004
title: Implement Comment Aggregation by Ticker
priority: high
story_points: [TBD]
source_requirements: [PIPE-023, PIPE-024]
dependencies: [epic-003]
blocks: [story-004-002, story-004-003, story-004-004, story-004-005]
---

# Story: Implement Comment Aggregation by Ticker

## Description
Build the comment aggregation layer that JOINs comment_tickers and comments tables for the current analysis run, grouping results by ticker and by signal date (current UTC calendar day). This is the foundational data access layer that all downstream signal detection logic consumes.

## Acceptance Criteria
- [ ] Query JOINs comment_tickers and comments WHERE comments.analysis_run_id equals the current run ID
- [ ] Results are grouped by ticker symbol (from comment_tickers.ticker)
- [ ] Results are further grouped by signal_date derived as the current UTC calendar day
- [ ] Each grouped result includes the full comment record plus per-ticker sentiment from comment_tickers.sentiment
- [ ] Function returns an empty collection (not an error) when no comments exist for the current run
- [ ] Aggregation handles comments that mention multiple tickers (appearing in multiple groups via comment_tickers)

## Technical Notes
- PIPE-023: SELECT ct.ticker, c.* FROM comment_tickers ct JOIN comments c ON c.id = ct.comment_id WHERE c.analysis_run_id = :current_run_id
- PIPE-024: Signal date is the current UTC calendar day, used as grouping key for daily rollup
- This function is the single data source for stories 004-002 through 004-006; design its return type carefully
- Consider returning a dict keyed by (ticker, signal_date) with lists of enriched comment records
- Per-ticker sentiment comes from comment_tickers.sentiment, not comments.overall_sentiment

## Dependencies
- Depends on: epic-003 (AI-annotated comments with tickers in comment_tickers table)
- Blocks: story-004-002, story-004-003, story-004-004, story-004-005
