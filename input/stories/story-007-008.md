---
id: story-007-008
epic: epic-007
title: Implement POST /positions/{id}/close Manual Exit
priority: high
story_points: [TBD]
source_requirements: [API-POSITION-CLOSE]
dependencies: [story-007-005]
blocks: []
---

# Story: Implement POST /positions/{id}/close Manual Exit

## Description
Implement the manual position close endpoint that allows users to close (fully or partially) an open position. Validates the request (reason is required, quantity_pct is optional defaulting to 1.0), creates a position_exits record, updates the position's shares/contracts_remaining, sets status to 'closed' if fully exited, and updates the portfolio's cash balance to reflect the proceeds.

## Acceptance Criteria
- [ ] POST /positions/{id}/close accepts JSON body with `reason` (required string) and `quantity_pct` (optional float, default 1.0)
- [ ] Returns VALIDATION_ERROR if reason is missing or empty
- [ ] Returns VALIDATION_ERROR if quantity_pct is not between 0.0 (exclusive) and 1.0 (inclusive)
- [ ] Returns NOT_FOUND if position ID does not exist or position is already fully closed (status='closed')
- [ ] Creates a position_exits record with exit_reason='manual_close', the provided reason in notes, exit_price (current price), and quantity based on quantity_pct
- [ ] For full close (quantity_pct=1.0): sets positions.status='closed', positions.closed_at=now, shares_remaining or contracts_remaining to 0
- [ ] For partial close (quantity_pct<1.0): reduces shares_remaining or contracts_remaining by the proportional amount, status remains 'open'
- [ ] Portfolio cash balance is updated: cash += exit_price * quantity_closed
- [ ] quantity_pct=1.0 closes 100% of shares_remaining (not original shares). For a position with 50% already closed, quantity_pct=1.0 closes the remaining shares/contracts.

## Technical Notes
- All database operations (INSERT position_exits, UPDATE positions, UPDATE portfolios) should be in a single transaction
- exit_price should be the most recent price from price_history for the position's ticker
- For options: quantity is in contracts (not shares), and exit value = exit_price * contracts_closed * 100 (options multiplier)
- Partial close math: quantity_closed = floor(shares_remaining * quantity_pct) for stocks, floor(contracts_remaining * quantity_pct) for options
- If partial close results in 0 remaining (due to floor rounding), treat as full close
- Return the updated position object in the response envelope

## Dependencies
- Depends on: story-007-005 (shares database access patterns, though this endpoint runs synchronously on the request thread)
- Blocks: none
