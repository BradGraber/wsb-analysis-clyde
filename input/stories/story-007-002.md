---
id: story-007-002
epic: epic-007
title: Implement Standard Response Envelope
priority: high
story_points: [TBD]
source_requirements: [API-ENVELOPE, API-ERROR-CODES, API-PAGINATION]
dependencies: [story-007-001]
blocks: [story-007-003]
---

# Story: Implement Standard Response Envelope

## Description
Create the standard response envelope wrapper, error response format, Pydantic models for all request/response schemas, and pagination support. Every API response will use `{data, meta: {timestamp, version}}` for success and `{error: {code, message}}` for errors. List endpoints support `limit` (default 50, max 100), `offset`, and return `total` count.

## Acceptance Criteria
- [ ] Success responses are wrapped in `{data: ..., meta: {timestamp: ISO-8601, version: "1.0"}}` format
- [ ] Error responses use `{error: {code: "ERROR_CODE", message: "Human-readable message"}}` format
- [ ] All 7 error codes are defined as constants: VALIDATION_ERROR, NOT_FOUND, ANALYSIS_ALREADY_RUNNING, REDDIT_API_ERROR, OPENAI_API_ERROR, SCHWAB_AUTH_ERROR, DATABASE_ERROR
- [ ] Pydantic models exist for the response envelope, error envelope, and pagination parameters
- [ ] Pagination query parameters accept `limit` (default 50, max 100) and `offset` (default 0)
- [ ] Paginated responses include `meta.total` with the full count of matching records
- [ ] FastAPI exception handlers return error envelope format for 404, 422, and 500 errors
- [ ] All API responses include Content-Type: application/json header

## Technical Notes
- Create a `wrap_response(data, total=None)` utility that all endpoints call to produce the envelope
- Pydantic models serve dual purpose: request validation and OpenAPI schema generation
- Pagination helper should accept SQLAlchemy-style query or raw SQL and apply LIMIT/OFFSET
- Error codes map to HTTP status codes: VALIDATION_ERROR->422, NOT_FOUND->404, ANALYSIS_ALREADY_RUNNING->409, DATABASE_ERROR->500, etc.
- Override FastAPI default exception handlers (RequestValidationError, HTTPException) to use error envelope
- Version string can be hardcoded "1.0" for Phase 1

## Dependencies
- Depends on: story-007-001 (FastAPI app initialized)
- Blocks: story-007-003 (GET endpoints need envelope and pagination)
