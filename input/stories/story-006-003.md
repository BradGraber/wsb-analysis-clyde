---
id: story-006-003
epic: epic-006
title: Implement Stock Partial Take-Profit and Trailing Stop
priority: high
story_points: [TBD]
source_requirements: [FR-027, FR-028, PIPE-044]
dependencies: [story-006-002, story-006-009, story-006-010]
blocks: []
---

# Story: Implement Stock Partial Take-Profit and Trailing Stop

## Description
Implement the partial take-profit exit at +15% gain (exit 50% of shares_remaining) and the trailing stop that activates after partial take-profit (exit remainder when price drops to peak_price * (1 - 0.07)). The trailing stop continuously tracks peak_price and triggers when the current price falls 7% below the peak.

## Acceptance Criteria
- [ ] At +15% gain, exactly 50% of shares_remaining are exited (rounded down for odd share counts)
- [ ] After partial take-profit, trailing_stop_active is set to TRUE on the position
- [ ] Trailing stop triggers when any candle's low breaches peak_price * 0.93
- [ ] Trailing stop exit closes all remaining shares (100% of shares_remaining after partial)
- [ ] Trailing stop exit price is set to peak_price * 0.93 (trigger level)
- [ ] Trailing stop only activates AFTER a partial take-profit has occurred (trailing_stop_active must be TRUE)
- [ ] Exit reasons are correctly set: 'take_profit' for partial exit, 'trailing_stop' for trailing exit

## Technical Notes
- FR-027: At +15% gain, exit 50% position and apply trailing stop to remainder.
- FR-028: Trailing stop at peak_price * (1 - 0.07) = peak_price * 0.93.
- PIPE-044: In priority cascade, trailing stop is checked after take-profit.
- Partial exit mechanics (quantity calculation, position_exits INSERT, cash update) handled by story-006-009.
- Peak tracking (peak_price updates) handled by story-006-010.
- This story implements the exit condition logic that calls into partial exit mechanics.

## Dependencies
- Depends on: story-006-002 (take-profit detection), story-006-009 (partial exit mechanics), story-006-010 (peak price tracking)
- Blocks: none
