---
id: story-003-008
epic: epic-003
title: Implement Batch-of-5 Commit Transaction
priority: high
story_points: [TBD]
source_requirements: [PIPE-020]
dependencies: [story-003-004]
blocks: [story-003-009]
---

# Story: Implement Batch-of-5 Commit Transaction

## Description
Commit each batch of 5 analyzed comments in a single database transaction for cost protection on retry scenarios. On transaction failure, roll back the entire batch and log the error. Maximum data loss on a crash is 5 comments' worth of AI API cost (approximately $0.03).

## Acceptance Criteria
- [ ] Each batch of 5 comments is committed in a single SQLite transaction: BEGIN, INSERT/UPDATE all 5 comments, COMMIT
- [ ] The transaction includes all comment fields: AI annotations (sentiment, sarcasm_detected, has_reasoning, confidence, reasoning_summary), author_trust_score snapshot, and analysis_run_id
- [ ] On transaction failure (SQLite error during any INSERT/UPDATE in the batch): ROLLBACK the entire batch, log error via structlog with batch details (comment reddit_ids), and continue to the next batch
- [ ] Rolled-back comments are logged but NOT retried (the AI cost is already spent; the comments can be re-analyzed on the next pipeline run via deduplication miss)
- [ ] The commit boundary aligns exactly with the ThreadPoolExecutor batch boundary from story-003-004: all 5 API responses are collected before any are committed
- [ ] The final partial batch (fewer than 5 comments) is also committed in a single transaction

## Technical Notes
- The batch-of-5 commit is a deliberate cost-protection tradeoff: per-comment commits would be safer but slower; larger batches risk more data loss on crash
- Maximum loss scenario: crash at comment 448 out of 500 loses the last 3 uncommitted comments' AI cost (~$0.03) -- this is acceptable per PRD
- SQLite transactions use `with conn:` context manager or explicit BEGIN/COMMIT/ROLLBACK
- The commit includes both the comments table updates AND the comment_tickers junction inserts (story-003-009), so both must be in the same transaction
- PRD reference: Section 3.2.2 Phase 3 step 2 bullet 5, PIPE-020

## Dependencies
- Depends on: story-003-004 (concurrent batching produces the batch boundaries)
- Blocks: story-003-009 (junction table inserts must be within the same transaction)
