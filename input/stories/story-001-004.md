---
id: story-001-004
epic: epic-001
title: Implement Database Connection Manager with FK Enforcement and WAL Mode
priority: high
story_points: [TBD]
source_requirements: [DB-FK-ENFORCE, DB-WAL, CFG-RUNTIME-READ, ERR-SQLITE]
dependencies: [story-001-001]
blocks: [story-001-006, story-001-007]
---

# Story: Implement Database Connection Manager with FK Enforcement and WAL Mode

## Description
Create a thread-safe database connection factory module that provides SQLite connections with foreign key enforcement and WAL journal mode enabled on every connection. This module serves as the single point of database access for the entire application, ensuring consistent PRAGMA settings and proper connection lifecycle management. It must also provide a helper function for reading system_config values at runtime.

## Acceptance Criteria
- [ ] A `get_connection()` function (or context manager) returns SQLite connections with `PRAGMA foreign_keys = ON` executed on every new connection
- [ ] WAL mode is enabled via `PRAGMA journal_mode = WAL` (needs to be set once per database file, but the connection manager should verify it)
- [ ] Connections obtained from separate threads do not produce sqlite3.ProgrammingError or database locked errors during concurrent read operations
- [ ] A `get_config(key: str) -> str` helper reads a single value from system_config by key, raising an error if the key does not exist (enforcing CFG-RUNTIME-READ -- no hardcoded config values)
- [ ] Connections are properly closed after use (context manager pattern with `__enter__` / `__exit__`, or explicit close in a finally block)
- [ ] The database file path is configurable (default: `./data/wsb.db`), read from environment variable or function parameter
- [ ] Unit test confirms that a foreign key violation raises an IntegrityError (proving FK enforcement is active)

## Technical Notes
- Python's sqlite3 module requires `PRAGMA foreign_keys = ON` to be executed on every new connection (it is not persistent across connections)
- WAL mode is persistent once set on a database file, but the connection manager should set it during initial database creation
- Use `sqlite3.connect(db_path, check_same_thread=False)` for cross-thread usage, or use a connection-per-thread pattern
- The `get_config()` helper avoids the anti-pattern of hardcoding config values that should be tunable at runtime
- This module is imported by virtually every other epic's pipeline code, so its interface must be stable and simple
- Consider a context manager pattern: `with get_connection() as conn:` for automatic cleanup

## Dependencies
- Depends on: story-001-001 (schema must exist to verify FK enforcement)
- Blocks: story-001-006 (Schwab spike needs DB access), story-001-007 (concurrency spike needs connection manager)
