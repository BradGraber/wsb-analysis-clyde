---
id: story-009-002
epic: epic-009
title: Implement Author Metrics Update (Phase 7a)
priority: high
story_points: [TBD]
source_requirements: [FR-047, PIPE-052, TRUST-CONVICTION, TRUST-FLAGGED]
dependencies: [story-009-001, epic-003]
blocks: [story-009-003]
---

# Story: Implement Author Metrics Update (Phase 7a)

## Description
Implement the Phase 7a author metrics update pipeline step. For each unique author in the current analysis run: increment total_comments, high_quality_comments (where has_reasoning=true), and total_upvotes. Recalculate avg_conviction_score using the per-comment formula: (length_factor * 0.20) + (reasoning_bonus * 0.20) + (ai_confidence * 0.60). Update last_active timestamp. The flagged_comments column is populated (incremented when flagged) but not used in trust calculation for Phase 1. Uses INSERT OR UPDATE (upsert) for new authors (sets first_seen on first encounter).

## Acceptance Criteria
- [ ] For each unique author in the current run's comments, total_comments is incremented by the number of new comments from that author
- [ ] high_quality_comments is incremented only for comments where has_reasoning=true (from AI analysis)
- [ ] total_upvotes is incremented by the sum of upvotes across new comments for each author
- [ ] avg_conviction_score is recalculated using the running average formula: old_sum = old_avg * old_count, new_sum = sum of per-comment convictions, new_avg = (old_sum + new_sum) / new_total (PRD Appendix F.3.3)
- [ ] Per-comment conviction formula is applied correctly: length_factor = min(1.0, char_count/500), reasoning_bonus = 1.0 if has_reasoning else 0.0, ai_confidence from comment record; conviction = (length_factor*0.20) + (reasoning_bonus*0.20) + (ai_confidence*0.60)
- [ ] last_active is updated to current timestamp for every author with new comments
- [ ] New authors (not previously in authors table) are inserted with first_seen = current timestamp, and all counters initialized from current run data
- [ ] flagged_comments column is incremented for flagged comments but has no effect on trust score in Phase 1
- [ ] flagged_comments column is initialized to 0 for all authors; in Phase 1, no comments are flagged (flagged_comments is not incremented). Flagging logic (e.g., sarcasm_detected=true) is deferred to Phase 2.

## Technical Notes
- Pipeline step: Phase 7a "Post-Analysis Updates" (PRD Section 3.2.2, lines 370-381)
- Conviction score formula specified in PRD Appendix F.3 (lines 2970-3019)
- Running average update for conviction: must handle the old_count=0 (new author) case where avg_conviction_score is NULL
- Author identification: join comments -> comment authors, grouped by unique author
- Depends on epic-003 having already annotated comments with has_reasoning, ai_confidence, and sarcasm_detected
- This step runs after Phase 6 (exit monitoring) and before evaluation period management

## Dependencies
- Depends on: story-009-001 (trust score calculation function, used after metrics update), epic-003 (AI analysis annotations on comments)
- Blocks: story-009-003 (prediction creation runs after author metrics are updated)
