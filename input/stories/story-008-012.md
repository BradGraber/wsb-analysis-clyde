---
id: story-008-012
epic: epic-008
title: Write Exit and Portfolio Isolation Tests
priority: medium
story_points: [TBD]
source_requirements: [FR-026, FR-041, FR-035]
dependencies: [story-008-007]
blocks: []
---

# Story: Write Exit and Portfolio Isolation Tests

## Description
Write 8 exit edge case tests covering the various exit scenarios (including a prediction-based accuracy flow test) and 6 portfolio isolation tests verifying that the 4 portfolios operate independently with no cross-contamination in cash balances, positions, or performance metrics.

## Acceptance Criteria
- [ ] 8 exit edge case tests are implemented covering: stop_loss trigger, take_profit trigger (partial 50% exit), trailing_stop trigger, breakeven_stop trigger, time_stop exit, expiration exit, manual_close flow, and prediction-based accuracy flow (verifying prediction outcome is recorded correctly when a simulated prediction exits)
- [ ] Each exit test verifies: correct exit_reason is recorded, position status is updated correctly, portfolio cash balance is adjusted, and position_exits record is created
- [ ] 6 portfolio isolation tests verify: creating a position in portfolio 1 does not affect portfolio 2/3/4 cash, closing a position in portfolio 3 does not affect portfolio 1/2/4 metrics, signals can exist in multiple portfolios independently, evaluation period metrics are scoped to a single portfolio, portfolio summary stats (total_pnl, open_position_count) are portfolio-specific, and partial close in one portfolio does not affect the same ticker's position in another portfolio
- [ ] All tests use the seed data or test fixtures (not production data)
- [ ] Tests are runnable via the project's standard test runner (e.g., `pytest tests/`)

## Technical Notes
- Tests call the REST API endpoints (integration tests, not unit tests)
- Use the seed data script from story-007-004 as a baseline, or create dedicated test fixtures
- Prediction accuracy flow test: create a prediction -> simulate exit -> verify prediction_outcomes record and is_correct field
- Portfolio isolation is critical because all 4 portfolios share the same database; these tests catch JOIN/WHERE clause bugs
- Exit edge cases should cover both stock and options positions where applicable
- Consider using pytest fixtures for database setup/teardown to ensure clean state between tests

## Dependencies
- Depends on: story-008-007 (position list rendering and exit display logic must exist to validate against)
- Blocks: none
