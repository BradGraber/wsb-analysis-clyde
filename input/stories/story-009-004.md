---
id: story-009-004
epic: epic-009
title: Implement Prediction Resolution and Accuracy Update (Phase 7a)
priority: high
story_points: [TBD]
source_requirements: [PIPE-059, TRUST-SENTIMENT-ACCURACY]
dependencies: [story-009-001, story-006-019]
blocks: [story-009-007]
---

# Story: Implement Prediction Resolution and Accuracy Update (Phase 7a)

## Description
Implement the Phase 7a prediction resolution and author accuracy update step. Read predictions that have been resolved by Phase 6 monitoring (those with prediction_exits where contracts_remaining=0). For each resolved prediction: calculate blended simulated_return_pct = SUM(prediction_exits.simulated_pnl) / (entry_premium * contracts * 100). Determine is_correct = (simulated_return_pct > 0). Check for HITL override on the prediction record (hitl_override field: 'correct', 'incorrect', or 'excluded') -- override takes precedence over auto-determination. Update the author's avg_sentiment_accuracy via EMA: new_value = (1 - accuracy_ema_weight) * old_value + accuracy_ema_weight * new_accuracy, where accuracy_ema_weight is read from system_config. Excluded predictions (HITL override = 'excluded') do not update accuracy. For first-ever resolution (author.avg_sentiment_accuracy is NULL), set directly to the new accuracy value (1.0 or 0.0).

## Acceptance Criteria
- [ ] Resolved predictions (status='resolved', contracts_remaining=0) are identified and processed during Phase 7a
- [ ] simulated_return_pct is calculated correctly: SUM(prediction_exits.simulated_pnl) / (entry_premium * contracts * 100) for each prediction
- [ ] is_correct is set to TRUE when simulated_return_pct > 0, FALSE when simulated_return_pct <= 0
- [ ] HITL override (hitl_override field) takes absolute precedence: 'correct' forces is_correct=TRUE, 'incorrect' forces is_correct=FALSE, 'excluded' skips accuracy update entirely
- [ ] Author avg_sentiment_accuracy is updated via EMA: (1 - accuracy_ema_weight) * old + accuracy_ema_weight * (1.0 if correct else 0.0), with accuracy_ema_weight read from system_config (default 0.30)
- [ ] When author.avg_sentiment_accuracy is NULL (first prediction resolution), the value is set directly to 1.0 (if correct) or 0.0 (if incorrect), not via EMA
- [ ] Excluded predictions do not affect the author's avg_sentiment_accuracy in any way

## Technical Notes
- Pipeline step: Phase 7a, runs after Phase 6 exit monitoring has resolved predictions (PRD Section 3.2.2 lines 375-381)
- EMA formula specified in PRD Appendix F.4.2 (lines 3045-3068); accuracy_ema_weight MUST be read from system_config
- The HITL override is set via a PATCH /predictions/{id} endpoint (implemented in epic-007); this story only reads the field
- Predictions are resolved by story-006-019 (Phase 6 prediction monitoring) which sets status='resolved' and populates prediction_exits
- Must handle batch of resolved predictions per run -- multiple predictions may resolve for the same author in a single cycle
- When multiple predictions resolve for the same author in one cycle, apply EMA updates sequentially (each update uses the result of the previous one)

## Dependencies
- Depends on: story-009-001 (trust score calculation, called after accuracy update), story-006-019 (Phase 6 prediction monitoring produces resolved predictions with prediction_exits)
- Blocks: story-009-007 (prediction-based accuracy tests)
