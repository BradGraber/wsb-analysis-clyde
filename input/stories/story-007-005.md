---
id: story-007-005
epic: epic-007
title: Implement Background Thread Pipeline Orchestration
priority: high
story_points: [TBD]
source_requirements: [API-ASYNC, ERR-TIER1, ERR-TIER2, ERR-TIER3, ERR-TIER4, ERR-RUN-TIMEOUT, NFR-004]
dependencies: [epic-001, epic-002, epic-003, epic-004, epic-005, epic-006]
blocks: [story-007-006]
---

# Story: Implement Background Thread Pipeline Orchestration

## Description
Build the background thread orchestration system that runs the full analysis pipeline (Phases 1-6) in a separate thread with its own SQLite connection. Wraps the entire pipeline in try/except, tracks progress by updating current_phase, phase_label, and progress at phase boundaries, and enforces a 60-minute hard timeout (sets status='failed') with a 30-minute soft warning. Uses the phase registry pattern to invoke each pipeline phase sequentially.

## Acceptance Criteria
- [ ] Background thread creates and uses its own SQLite connection (separate from the FastAPI request thread) with WAL mode and foreign key enforcement
- [ ] Pipeline phases are invoked via the phase registry pattern: each phase is a discrete callable registered in a list, orchestrator iterates sequentially
- [ ] Try/except wraps the entire pipeline: any unhandled exception sets analysis_runs.status='failed' with the error message and full stack trace logged
- [ ] At each phase boundary, analysis_runs is updated with current_phase (integer), phase_label (string), progress_current, and progress_total
- [ ] A 60-minute hard timeout sets status='failed' with error "Pipeline exceeded 60-minute timeout"
- [ ] A 30-minute soft warning is logged (WARNING level) but does not stop execution
- [ ] On successful completion, analysis_runs.status is set to 'completed' with completed_at timestamp
- [ ] If timeout fires during a database transaction, the current transaction is rolled back before status is set to 'failed'
- [ ] Background thread is allowed to complete the current pipeline phase before timeout terminates execution

## Technical Notes
- Phase 7b story -- requires all pipeline epics (001-006) to be functional
- Use `threading.Thread` (not asyncio) for background execution since SQLite does not support async
- The separate SQLite connection is required because SQLite connections are not thread-safe by default
- Phase registry: `PHASES = [(1, "Fetching Reddit", reddit_phase), (2, "Analyzing comments", analysis_phase), ...]`
- Timeout enforcement: use `threading.Timer` or check elapsed time at phase boundaries
- The 4-tier error model (ERR-TIER1 through ERR-TIER4) is implemented within individual pipeline phases; this story provides the outer try/except wrapper
- NFR-004: Target 30 minutes typical, warn if exceeded, hard fail at 60

## Dependencies
- Depends on: epic-001 through epic-006 (full pipeline must be functional)
- Blocks: story-007-006 (POST /analyze needs orchestration), story-007-008 (manual close uses similar DB pattern)
