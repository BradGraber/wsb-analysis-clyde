---
id: story-007-009
epic: epic-007
title: Implement Prediction API Endpoints
priority: high
story_points: [TBD]
source_requirements: [API-PREDICTIONS, API-PREDICTION-OVERRIDE]
dependencies: [story-007-002]
blocks: [story-008-015]
---

# Story: Implement Prediction API Endpoints

## Description
Implement the prediction-related REST endpoints: GET /predictions with filters, GET /predictions/{id} with full history, and PATCH /predictions/{id}/override for HITL (human-in-the-loop) correction. The override endpoint accepts only three valid values (correct, incorrect, excluded) and is idempotent.

## Acceptance Criteria
- [ ] GET /predictions returns paginated predictions with filters: author (string), ticker (string), status (string), analysis_run_id (integer)
- [ ] GET /predictions returns each prediction with core fields: id, comment_id, ticker, option_type, strike, entry_premium, status, is_correct, created_at
- [ ] GET /predictions/{id} returns a single prediction with full prediction_outcomes history (day_offset, current_premium, pnl_pct) and prediction_exits records
- [ ] PATCH /predictions/{id}/override accepts JSON body with `override_result` field
- [ ] PATCH /predictions/{id}/override validates that override_result is exactly one of: "correct", "incorrect", "excluded" -- returns VALIDATION_ERROR otherwise
- [ ] PATCH /predictions/{id}/override is idempotent: calling twice with the same value produces the same result without error
- [ ] PATCH /predictions/{id}/override returns NOT_FOUND if prediction ID does not exist
- [ ] PATCH /predictions/{id}/override succeeds regardless of prediction status (tracking, resolved, expired) -- override is always allowed

## Technical Notes
- Phase 7b story, but depends only on story-007-002 (response envelope) since it reads/writes prediction tables from epic-001 schema
- GET /predictions filter combinations should be tested: author-only, ticker-only, status-only, combined filters, no filters
- The override sets predictions.is_correct to true/false/null based on correct/incorrect/excluded respectively
- Consider adding an `override_at` timestamp and `override_source` = 'hitl' field for audit trail
- Prediction outcomes are ordered by day_offset ascending
- Prediction exits include exit_reason and exit_date for completed predictions

## Dependencies
- Depends on: story-007-002 (response envelope and Pydantic models)
- Blocks: story-008-015 (prediction tracking UI calls these endpoints)
