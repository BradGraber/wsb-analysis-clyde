---
id: story-006-009
epic: epic-006
title: Implement Partial Exit Mechanics
priority: high
story_points: [TBD]
source_requirements: [PIPE-047]
dependencies: [story-006-011]
blocks: [story-006-003, story-006-006]
---

# Story: Implement Partial Exit Mechanics

## Description
Build the partial exit mechanics that handle quantity calculation, exit record creation, and position/portfolio updates when a position is partially exited. Calculate quantity_pct, INSERT into position_exits, UPDATE shares_remaining or contracts_remaining on the position, and UPDATE portfolio cash_available with proceeds (not realized_pnl). Options exits include the x100 contract multiplier in cash calculations.

## Acceptance Criteria
- [ ] quantity_pct is correctly calculated as the fraction of the original position being exited (e.g., 0.50 for 50%)
- [ ] A position_exits record is INSERTed with: position_id, exit_date, exit_price, exit_reason, quantity_pct, shares_exited or contracts_exited, realized_pnl
- [ ] shares_remaining (stocks) or contracts_remaining (options) is decremented by the exited amount on the position
- [ ] Portfolio cash_available is updated with proceeds only (exit_price * shares_exited for stocks, exit_price * contracts_exited * 100 for options)
- [ ] Options exits correctly apply the x100 contract multiplier in all cash calculations
- [ ] Multiple partial exits can occur on the same position (e.g., 50% take-profit followed by trailing stop on remainder)
- [ ] realized_pnl per exit is calculated as (exit_price - entry_price) * shares_exited for stocks, or (exit_premium - entry_premium) * contracts_exited * 100 for options
- [ ] Exited quantity is rounded down (floor) for fractional shares or contracts (e.g., 7 shares at 50% = floor(3.5) = 3 shares exited)

## Technical Notes
- PIPE-047: Exit record creation includes INSERT position_exits, UPDATE positions shares/contracts_remaining, UPDATE portfolio cash with proceeds-only.
- Proceeds-only means cash_available += exit_price * quantity (not += realized_pnl). This reflects cash returning to the portfolio.
- The x100 multiplier for options is critical: 1 contract = 100 shares of the underlying.
- This function is called by both stock exit conditions (story-006-003) and options exit conditions (story-006-006).
- Must handle the case where shares_remaining reaches 0 after exit, triggering full close finalization (story-006-011).

## Dependencies
- Depends on: story-006-011 (full close finalization, called when remaining reaches 0)
- Blocks: story-006-003 (stock partial take-profit), story-006-006 (options premium take-profit)
