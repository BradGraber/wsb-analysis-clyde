---
id: story-009-003
epic: epic-009
title: Implement Prediction Creation and Strike Selection (Phase 3.5)
priority: high
story_points: [TBD]
source_requirements: [PIPE-057, NFR-002]
dependencies: [story-005-006, epic-001, epic-003]
blocks: []
---

# Story: Implement Prediction Creation and Strike Selection (Phase 3.5)

## Description
Implement Phase 3.5 of the pipeline: after AI analysis (Phase 3), for each comment_ticker from the current run, create a simulated prediction record. Determine option_type from per-ticker sentiment (bullish -> call, bearish -> put; skip neutral). Select strike using the shared function from epic-005 (filter expirations 14-21 DTE prefer closest to 17, target delta +/-0.30 with tolerance [0.15, 0.50]). Fetch entry_premium from Schwab option quote. Calculate contracts = max(1, floor(2000 / (premium * 100))). Insert prediction with status='tracking'. Use INSERT OR IGNORE keyed on UNIQUE(comment_id, ticker) for dedup. Batch Schwab calls by unique ticker for API efficiency. If Schwab is unavailable or no valid strike exists, set status='expired' and append the appropriate warning.

## Acceptance Criteria
- [ ] For each comment_ticker in the current analysis run, a prediction record is created with option_type='call' (bullish) or option_type='put' (bearish); neutral sentiment tickers are skipped
- [ ] Strike selection reuses the shared function from epic-005: expirations filtered to 14-21 DTE (prefer closest to 17), delta target +0.30 (calls) or -0.30 (puts) with tolerance [0.15, 0.50]
- [ ] entry_premium is fetched from the Schwab option quote for the selected contract
- [ ] contracts is calculated as max(1, floor(2000 / (entry_premium * 100))) and contracts_remaining is set equal to contracts
- [ ] INSERT OR IGNORE ensures deduplication on the UNIQUE(comment_id, ticker) constraint -- re-runs for the same comment/ticker pair do not create duplicate predictions
- [ ] Schwab API calls are batched by unique ticker: one options chain fetch per ticker, reused across all comment_tickers for that ticker
- [ ] When Schwab API is unavailable for a ticker: prediction is created with status='expired' and a `schwab_prediction_unavailable` warning is appended to the run warnings
- [ ] When no valid strike is found (no expiration in DTE range or no delta match): prediction is created with status='expired' and a `prediction_strike_unavailable` warning is appended
- [ ] Schwab API calls use ThreadPoolExecutor with max_workers=5 and retry/backoff (reusing the pattern from story-006-013) to respect rate limits across 50-100 unique tickers

## Technical Notes
- Pipeline placement: Phase 3.5, runs after Phase 3 (AI analysis) and before Phase 4 (signal detection) -- see PRD Section 3.2.2 lines 196-212
- Strike selection function is defined in epic-005 (story-005-006) and shared via import; this story does NOT reimplement it
- Warning types: `schwab_prediction_unavailable` and `prediction_strike_unavailable` (PRD warning table, lines 363-364)
- Commit strategy: COMMIT per ticker batch (PRD line 212)
- The predictions table has: comment_id, ticker, option_type, contract_symbol, strike_price, expiration_date, entry_premium, contracts, contracts_remaining, status, entry_date, plus monitoring fields (current_premium, peak_premium, trailing_stop_active, simulated_return_pct, is_correct, hitl_override, resolved_at)
- ~50-100 unique tickers per cycle expected; Schwab rate limiting is a known risk (mitigated by batching and real position priority)

## Dependencies
- Depends on: story-005-006 (shared strike selection function from epic-005), epic-001 (Schwab client, predictions table schema), epic-003 (Phase 3 must produce comment_tickers before Phase 3.5 can create predictions)
- Blocks: none directly (predictions are consumed by story-006-019 in Phase 6 monitoring, and story-009-004 in Phase 7a resolution)
- Note: story-009-002 (Phase 7a author metrics) is NOT a dependency. Phase 3.5 runs after Phase 3 and before Phase 4; Phase 7a runs after Phase 6. These are independent pipeline phases with no data dependency.
