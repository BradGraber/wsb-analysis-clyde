---
id: story-006-010
epic: epic-006
title: Implement Peak Price Tracking
priority: high
story_points: [TBD]
source_requirements: [FR-028, FR-043]
dependencies: [story-006-008]
blocks: [story-006-003, story-006-006]
---

# Story: Implement Peak Price Tracking

## Description
Implement peak price and peak premium tracking for open positions. After every monitoring check, update peak_price (for stocks) and peak_premium (for options) in the positions table to the highest observed value. These peaks are used by trailing stop calculations.

## Acceptance Criteria
- [ ] peak_price is updated to MAX(current peak_price, highest candle high) for stock positions after each monitoring pass
- [ ] peak_premium is updated to MAX(current peak_premium, current_premium) for options positions after each monitoring pass
- [ ] Peak values are persisted to the positions table via UPDATE query
- [ ] Peak tracking occurs AFTER exit condition evaluation (so the peak used for trailing stop is from prior checks, not the current candle)
- [ ] Initial peak_price is set to entry_price when position is opened (handled by epic-005); this story only handles updates
- [ ] Peak values never decrease (monotonically increasing)

## Technical Notes
- FR-028: Trailing stop for stocks uses peak_price (peak_price * 0.93).
- FR-043: Trailing stop for options uses peak_premium (peak_premium * 0.70).
- Peak tracking must update after processing all candles for a position in a given monitoring cycle.
- The peak value used for trailing stop evaluation should be the peak from PRIOR monitoring cycles, not updated mid-iteration.
- For stocks, peak_price tracks the highest candle high observed across all monitoring cycles.
- For options, peak_premium tracks the highest current_premium observed.

## Dependencies
- Depends on: story-006-008 (candle iteration provides price data to track peaks from)
- Blocks: story-006-003 (stock trailing stop needs peak_price), story-006-006 (options trailing stop needs peak_premium)
