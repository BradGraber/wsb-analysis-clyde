---
id: story-006-005
epic: epic-006
title: Implement Options Expiration Protection
priority: high
story_points: [TBD]
source_requirements: [FR-044, PIPE-045]
dependencies: [story-006-008]
blocks: [story-006-006, story-006-007]
---

# Story: Implement Options Expiration Protection

## Description
Implement the highest-priority options exit condition: expiration protection. When an options position reaches DTE (days to expiration) <= 2, exit 100% of contracts_remaining immediately. This check must run before all other options exit conditions.

## Acceptance Criteria
- [ ] DTE is calculated as calendar days between current date and the option's expiration_date
- [ ] Expiration protection triggers when DTE <= 2 (exit 100% of contracts_remaining)
- [ ] This check is evaluated FIRST in the options exit priority cascade (highest priority per PIPE-045)
- [ ] Exit reason is set to 'expiration'
- [ ] Exit price is set to the current premium at time of exit
- [ ] When expiration fires, no further exit conditions are evaluated for this position
- [ ] Handles edge case where DTE crosses threshold between runs (e.g., DTE=3 yesterday, DTE=1 today)

## Technical Notes
- FR-044: Exit 100% when DTE <= 2. Highest priority check for options.
- PIPE-045: Options exit priority order is expiration > stop-loss > take-profit > trailing > time.
- DTE calculation uses calendar days, not trading days.
- The worst-case scenario (DTE=1) is still safe from assignment risk.
- This is a full close (all contracts), which will invoke full close finalization (story-006-011).

## Dependencies
- Depends on: story-006-008 (candle iteration logic for price data)
- Blocks: story-006-006 (premium monitoring exits), story-006-007 (time stop)
