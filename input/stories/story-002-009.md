---
id: story-002-009
epic: epic-002
title: Write Reddit Pipeline Unit Tests
priority: medium
story_points: [TBD]
source_requirements: [INT-REDDIT, PIPE-008]
dependencies: [story-002-008]
blocks: []
---

# Story: Write Reddit Pipeline Unit Tests

## Description
Write unit tests covering the core Reddit pipeline logic: priority scoring formula verification, parent chain building with nested threads, financial keyword detection accuracy, image URL pattern matching, comment deduplication logic, and engagement score calculation. Tests use hand-crafted fixtures (not live API calls) and validate algorithmic correctness.

## Acceptance Criteria
- [ ] Priority scoring formula test: verify (financial*0.4) + (trust*0.3) + (engagement*0.3) - depth_penalty produces correct composite scores for at least 3 edge cases (all-zero inputs, max-value inputs, typical mixed values)
- [ ] Parent chain building test: given a 3-level nested thread (root -> reply -> sub-reply), verify parent_chain arrays contain correct ancestors in order from immediate parent to root, and top-level comments have empty parent_chain
- [ ] Financial keyword detection tests: verify correct scoring for comments with zero keywords (score=0), single keyword, multiple keywords, and case-insensitive matching (e.g., "CALLS" vs "calls")
- [ ] Image URL pattern matching tests: verify detection of all three patterns (i.redd.it, imgur, preview.redd.it) and rejection of non-matching URLs (e.g., youtube.com, reddit.com/r/...)
- [ ] Comment deduplication test: verify that a comment with an existing reddit_id is flagged as duplicate and its analysis_run_id is updated without re-processing
- [ ] Engagement score calculation test: verify log(upvotes + 1) x reply_count formula for edge cases including zero upvotes, zero replies, and typical values
- [ ] All tests pass with pytest and do not require network access or live Reddit/OpenAI API credentials

## Technical Notes
- Use hand-crafted fixtures per planning decision qc-qa-003 (VCR.py is for integration tests; unit tests use direct fixtures)
- Test data should include WSB-realistic comment bodies with financial terminology
- Priority scoring tests should verify the formula weights are applied correctly, not just that ranking works
- Parent chain tests should cover edge cases: orphaned comments, self-referential chains (should not occur but should not crash)
- Consider using pytest parametrize for keyword detection and URL pattern matching to cover many cases concisely
- PRD reference: PIPE-008 formula, INT-REDDIT integration requirements

## Dependencies
- Depends on: story-002-008 (all pipeline components must be implemented before comprehensive testing)
- Blocks: none
