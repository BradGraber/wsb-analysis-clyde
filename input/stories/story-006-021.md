---
id: story-006-021
epic: epic-006
title: Write Prediction Edge Case Tests
priority: medium
story_points: [TBD]
source_requirements: [PIPE-058]
dependencies: [story-006-019]
blocks: []
---

# Story: Write Prediction Edge Case Tests

## Description
Write 5 unit tests covering prediction monitoring edge cases: missed expiration where DTE goes below 0 between monitoring runs, Schwab outage causing stale current_premium, zero-premium options handling, stale peak_premium scenarios, and skipping already-resolved predictions.

## Acceptance Criteria
- [ ] Test 1: Missed expiration (DTE < 0 between runs) -- prediction is immediately resolved with exit_reason='expiration', quantity_pct=1.0 for all contracts_remaining
- [ ] Test 2: Schwab outage during monitoring -- prediction retains stale current_premium from prior check, logged as warning, no exit triggered on stale data alone
- [ ] Test 3: Zero-premium options -- prediction with current_premium=0.0 is handled without division-by-zero errors, resolves as stop-loss
- [ ] Test 4: Stale peak_premium handling -- peak_premium is never overwritten with a lower value; trailing stop uses the historical peak
- [ ] Test 5: Already-resolved predictions (status='resolved') are skipped entirely in the monitoring loop, no duplicate processing

## Technical Notes
- Test 1 covers the expired-past-expiration path in PIPE-058 where expiration_date < today.
- Test 2 validates graceful degradation when Schwab API is unavailable for a prediction's ticker.
- Test 3 addresses a potential edge case where an option becomes worthless (premium drops to 0).
- Test 4 is a regression test ensuring peak_premium monotonically increases.
- Test 5 ensures idempotent monitoring -- re-running on resolved predictions has no effect.
- Use pytest with carefully constructed edge-case fixtures.

## Dependencies
- Depends on: story-006-019 (prediction monitoring implementation)
- Blocks: none
