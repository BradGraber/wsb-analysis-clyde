---
id: story-001-005
epic: epic-001
title: Create Schema Validation Script for Integrity Verification
priority: medium
story_points: [TBD]
source_requirements: [DB-INIT, DB-SCHEMA-EVOLVE, NFR-008]
dependencies: [story-001-001, story-001-002]
blocks: []
---

# Story: Create Schema Validation Script for Integrity Verification

## Description
Create a standalone validation script that verifies the database schema is correctly initialized and complete. The script checks for all 16 tables with their expected columns, verifies all 34 system_config entries are present with valid values, confirms the 4 portfolio rows exist, and validates that foreign key enforcement and WAL mode are active. This script is used after initial setup and after any future schema migrations to confirm integrity.

## Acceptance Criteria
- [ ] Script verifies all 16 tables exist by querying `sqlite_master` and reports any missing tables by name
- [ ] Script verifies each table has the expected column names and types (at minimum, checks column count and key column names for each table)
- [ ] Script verifies all 34 system_config entries are present by checking for each expected key, reporting any missing keys
- [ ] Script verifies 4 portfolio rows exist with correct name/instrument_type/signal_type combinations
- [ ] Script verifies `PRAGMA foreign_keys` returns 1 (FK enforcement active on the current connection)
- [ ] Script verifies `PRAGMA journal_mode` returns 'wal'
- [ ] Script outputs a clear pass/fail summary with specific failure details (e.g., "FAIL: Missing table 'prediction_exits'" or "FAIL: Missing config key 'stock_stop_loss_pct'")
- [ ] Script exits with code 0 when all checks pass, exit code 1 when any check fails

## Technical Notes
- Use `SELECT name FROM sqlite_master WHERE type='table'` to list tables
- Use `PRAGMA table_info(table_name)` to inspect column definitions
- Use `SELECT key FROM system_config` and compare against the expected 34-key list
- The script should be runnable as `python scripts/validate_schema.py` or similar
- Exit code 0 for all checks passing, exit code 1 for any failures
- This supports the DB-SCHEMA-EVOLVE requirement by providing a way to verify schema after additive migrations
- The script should use the connection manager from story-001-004 to ensure FK enforcement is tested through the same path the application uses

## Dependencies
- Depends on: story-001-001 (schema must exist), story-001-002 (config must be seeded)
- Blocks: none (this is a verification tool, not on the critical path)
