---
id: story-005-004
epic: epic-005
title: Implement Position Count and Replacement Logic
priority: high
story_points: [TBD]
source_requirements: [FR-025, PIPE-036, PIPE-039]
dependencies: [story-005-003]
blocks: []
---

# Story: Implement Position Count and Replacement Logic

## Description
Implement the 10-position limit check per portfolio and the replacement flow when at capacity. When a portfolio has 10 open positions, find the lowest-confidence position, verify the new signal exceeds it by more than 0.1 confidence, and check the safeguard that prevents replacing positions with unrealized gain greater than +5%. Execute the close-then-open replacement flow: fetch current price, INSERT position_exits, UPDATE position to closed, UPDATE portfolio cash, then open the new position.

## Acceptance Criteria
- [ ] Position count is checked per portfolio: query positions WHERE portfolio_id = X AND status = 'open'
- [ ] When count < 10, new position proceeds to opening flow without replacement
- [ ] When count = 10, the lowest-confidence open position in that portfolio is identified
- [ ] New signal must exceed lowest position's confidence by more than 0.1 (new_confidence > lowest_confidence + 0.1) for replacement
- [ ] Safeguard: replacement is skipped (with warning log) if lowest position has unrealized_gain > +5%
- [ ] Replacement flow executes in order: (1) fetch current price via Schwab, (2) INSERT position_exits with exit_reason='replaced', (3) UPDATE position to status='closed', (4) UPDATE portfolio cash_available += exit_proceeds, (5) open new position
- [ ] If new signal does not exceed lowest by >0.1, the signal is rejected for this portfolio (logged, not an error)
- [ ] If Schwab price fetch fails during replacement flow, the replacement is aborted and logged as a warning; the existing position is preserved
- [ ] Replacement is valid even if the new signal is for the same ticker as the lowest-confidence position (duplicate ticker positions are allowed)

## Technical Notes
- FR-025: 10-position maximum per portfolio with confidence-based replacement
- PIPE-036: Position count check query
- PIPE-039: Close-then-open replacement flow with position_exits record
- The unrealized_gain safeguard protects profitable positions from being replaced by newer, higher-confidence but unproven signals
- Replacement is per-portfolio: a signal may be replaced in stocks_quality but not in options_quality
- The close-then-open flow must be atomic (wrapped in a transaction) to prevent partial state
- exit_proceeds for stocks: current_price * shares_remaining; for options: current_premium * contracts_remaining * 100
- realized_pnl: exit_proceeds - (entry_price * original_quantity)
- After replacement, the portfolio's position count remains at 10 (one closed, one opened)

## Dependencies
- Depends on: story-005-003 (position sizing determines what we are trying to open)
- Blocks: none (other stories can proceed in parallel)
