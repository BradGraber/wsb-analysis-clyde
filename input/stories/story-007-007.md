---
id: story-007-007
epic: epic-007
title: Implement Startup Recovery Logic
priority: high
story_points: [TBD]
source_requirements: [API-STALE-RECOVERY]
dependencies: [story-007-006]
blocks: []
---

# Story: Implement Startup Recovery Logic

## Description
Implement recovery logic that runs on FastAPI startup to detect and clean up stale analysis runs. If the server crashed or was restarted while an analysis was running, any analysis_runs records with status='running' are set to status='failed' with an error message indicating unexpected shutdown. This prevents HTTP 409 lockout where a stale 'running' record blocks all future analyses.

## Acceptance Criteria
- [ ] On FastAPI startup (lifespan context), query analysis_runs WHERE status='running'
- [ ] All matching records have their status set to 'failed'
- [ ] Error message is set to "Recovered from unexpected shutdown" for each recovered record
- [ ] completed_at timestamp is set to the recovery time (current UTC timestamp)
- [ ] Recovery is logged at WARNING level with the count of recovered runs and their run_ids
- [ ] If no stale runs exist, startup proceeds silently (INFO log "No stale runs found")
- [ ] Recovery runs before any request handlers are available (part of startup lifecycle)

## Technical Notes
- This should execute as part of the FastAPI lifespan context manager, after database connection is established but before the app starts accepting requests
- Simple SQL: `UPDATE analysis_runs SET status='failed', error_message='Recovered from unexpected shutdown', completed_at=? WHERE status='running'`
- Edge case: multiple stale runs (unlikely but possible if recovery itself failed previously) -- handle all of them
- This is a safety net; normal shutdown should set running analyses to failed via the orchestration layer
- Log recovered run_ids for debugging: `logger.warning("Recovered stale runs", run_ids=[...], count=N)`

## Dependencies
- Depends on: story-007-006 (POST /analyze creates the 'running' records this story recovers)
- Blocks: none
