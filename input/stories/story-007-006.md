---
id: story-007-006
epic: epic-007
title: Implement POST /analyze Async Pattern
priority: high
story_points: [TBD]
source_requirements: [FR-011, API-ANALYZE, PIPE-055, PIPE-056]
dependencies: [story-007-005]
blocks: [story-007-007]
---

# Story: Implement POST /analyze Async Pattern

## Description
Implement the POST /analyze endpoint that immediately returns HTTP 202 with a run_id, spawns the background thread pipeline (from story-007-005), and enforces single-run execution by returning HTTP 409 if an analysis is already running. Warnings are accumulated in-memory during the run and serialized to JSON on the analysis_runs record upon completion.

## Acceptance Criteria
- [ ] POST /analyze creates a new analysis_runs record with status='running' and returns HTTP 202 with `{data: {run_id: <id>}, meta: {timestamp, version}}`
- [ ] If an analysis_run with status='running' already exists, POST /analyze returns HTTP 409 with error code ANALYSIS_ALREADY_RUNNING
- [ ] Background thread is spawned using the orchestration system from story-007-005
- [ ] Warnings are accumulated in an in-memory list during the pipeline run (not written to DB incrementally)
- [ ] On pipeline completion, warnings list is serialized to JSON and stored in analysis_runs.warnings (NULL if empty list)
- [ ] All 7 warning types are supported: schwab_stock_unavailable, schwab_options_unavailable, image_analysis_failed, market_hours_skipped, insufficient_cash, schwab_prediction_unavailable, prediction_strike_unavailable
- [ ] GET /runs/{id}/status correctly reflects pipeline progress while the background thread is running

## Technical Notes
- The single-run check should be atomic: query + insert within a transaction to prevent race conditions
- Warnings accumulation: pass a shared list (thread-safe via GIL for append operations) to the pipeline orchestrator
- Warning object structure: `{type: "warning_type", message: "details", ticker: "optional", phase: N}`
- On completion (success or failure), serialize warnings: `json.dumps(warnings) if warnings else None`
- The run_id is the auto-incremented primary key from analysis_runs INSERT
- Frontend polls GET /runs/{id}/status every 10 seconds (implemented in epic-008)

## Dependencies
- Depends on: story-007-005 (background thread orchestration)
- Blocks: story-007-007 (startup recovery handles stale 'running' records from this endpoint)
