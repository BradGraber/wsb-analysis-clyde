---
id: story-001-006
epic: epic-001
title: Execute Schwab OAuth Spike with Token Storage and API Verification
priority: high
story_points: [TBD]
source_requirements: [INT-SCHWAB, INT-SCHWAB-SETUP, INT-SCHWAB-REFRESH, INT-TOKEN-STORAGE, INT-ENV-VARS]
dependencies: [story-001-004]
blocks: []
---

# Story: Execute Schwab OAuth Spike with Token Storage and API Verification

## Description
Time-boxed spike (2-3 days) to prove out the Schwab API OAuth 2.0 Authorization Code Grant flow end-to-end. Build a CLI setup script that opens the browser for user consent, exchanges the authorization code for tokens, stores them securely in `./data/schwab_token.json` with chmod 600 permissions, and verifies basic API functionality by fetching a stock quote and an options chain. This spike de-risks the Schwab integration that epic-005 and epic-006 depend on.

## Acceptance Criteria
- [ ] CLI script (e.g., `python scripts/schwab_setup.py`) opens the default browser to the Schwab OAuth authorization URL, prompts the user to paste the callback URL after consent, and exchanges the authorization code for access and refresh tokens
- [ ] Tokens are stored in `./data/schwab_token.json` containing access_token, refresh_token, expires_at (access token ~30-min TTL), and refresh_expires_at (refresh token ~7-day TTL)
- [ ] Token file is created with chmod 600 permissions (owner read/write only) and the path is listed in .gitignore
- [ ] Token refresh logic works: proactively refreshes access token before expiration; on 401 response, performs immediate refresh and retries the request; if refresh token is expired, logs an error with re-authentication instructions
- [ ] A basic stock quote can be fetched successfully (e.g., GET quote for AAPL) using the stored tokens
- [ ] A basic options chain can be fetched successfully (e.g., options chain for AAPL with 14-21 DTE filter) using the stored tokens
- [ ] Spike findings are documented: any Schwab API quirks, rate limits observed, response format notes, and token lifecycle behavior
- [ ] If Schwab developer app is not yet approved, spike documents the blocker with specific next steps and estimated approval timeline
- [ ] Verify .gitignore contains an entry matching the token file path (./data/schwab_token.json or equivalent)

## Technical Notes
- Schwab uses OAuth 2.0 Authorization Code Grant (not client credentials)
- The CLI flow: start local redirect handler or instruct user to copy callback URL, exchange code for tokens via POST to Schwab token endpoint
- Access token TTL is ~30 minutes; refresh token TTL is ~7 days
- Proactive refresh means refreshing the access token before it expires (e.g., when remaining TTL < 5 minutes)
- On 401 during an API call: immediately attempt token refresh, then retry the original request once
- If refresh token is expired (inactive > 7 days): the user must re-run the setup script
- The ./data/ directory should be created if it does not exist
- This spike informs epic-005 (position entry pricing) and epic-006 (price monitoring), both of which consume the Schwab client
- Reference: `resources/schwab-streamer-api.md` for additional Schwab API context
- Time-box: 2-3 days. If OAuth flow cannot be completed (e.g., Schwab developer app not yet approved), document the blocker and what was learned

## Dependencies
- Depends on: story-001-004 (connection manager for any DB interactions during verification)
- Blocks: none directly in epic-001 (but epic-005 and epic-006 depend on the Schwab client produced here)
