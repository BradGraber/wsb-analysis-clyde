---
id: story-006-008
epic: epic-006
title: Implement Candle Iteration Logic
priority: high
story_points: [TBD]
source_requirements: [FR-031, PIPE-046]
dependencies: [story-006-001]
blocks: [story-006-002, story-006-005]
---

# Story: Implement Candle Iteration Logic

## Description
Build the candle iteration engine that processes fetched candles chronologically against all active exit triggers for a position. For each candle, check high/low against all active trigger prices in priority order. Process the first breach found and stop iteration for that position. This is the core loop that drives all exit condition evaluation.

## Acceptance Criteria
- [ ] Candles are fetched via story-006-001's tiered fetching and sorted chronologically (oldest first)
- [ ] For each candle, all active exit triggers are checked in priority order (stop-loss > take-profit > trailing > breakeven > time for stocks; expiration > stop-loss > take-profit > trailing > time for options)
- [ ] On first breach detection, iteration stops for that position and the triggered exit is processed
- [ ] When multiple triggers breach in the same candle (e.g., high hits take-profit AND low hits stop-loss), the higher-priority trigger wins
- [ ] Positions with no breach across all candles continue to the next monitoring cycle
- [ ] Period high/low are correctly derived by aggregating intraday candle data (per PIPE-046)
- [ ] Each candle is checked exactly once in chronological order
- [ ] Positions with zero candles (no price data returned by story-006-001) are skipped with no exit evaluation and a debug log emitted

## Technical Notes
- FR-031: Intraday price monitoring with chronological candle iteration.
- PIPE-046: Period high/low derivation by aggregating intraday candles, iterate chronologically on breach.
- The candle iteration loop is position-centric: for each open position, iterate through its candles.
- Exit condition functions (stories 002-007) are called within this loop in priority order.
- "First breach" means the earliest candle (chronologically) that triggers any exit condition.
- This is the orchestration layer that connects price data (story-006-001) to exit conditions (stories 002-007).

## Dependencies
- Depends on: story-006-001 (tiered price data fetching provides the candle data)
- Blocks: story-006-002 (stock stop-loss/take-profit), story-006-005 (options expiration)
