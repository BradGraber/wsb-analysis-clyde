---
id: story-002-003
epic: epic-002
title: Implement Comment Fetching and Parent Chain Building
priority: high
story_points: [TBD]
source_requirements: [PIPE-005, PIPE-006, FR-010]
dependencies: [story-002-001]
blocks: [story-002-004, story-002-005, story-002-006, story-002-007]
---

# Story: Implement Comment Fetching and Parent Chain Building

## Description
Fetch up to 1000 comments per post sorted by engagement (score x replies) and build parent chain arrays that provide threaded conversation context. Parent chains enable downstream AI analysis to understand comment context within discussion threads.

## Acceptance Criteria
- [ ] Fetches up to 1000 comments per post using PRAW, sorted by engagement metric (score x replies)
- [ ] Each comment is represented as a ProcessedComment object with all 11 fields from PRD Appendix D.1: reddit_id, post_id, author, body, score, depth, created_utc, priority_score (0.0 initially), financial_score (0.0 initially), author_trust_score (0.0 initially), parent_chain (populated)
- [ ] Parent chain arrays are built correctly for threaded comments: each comment's parent_chain contains an ordered array of ParentChainEntry objects (id, body, depth, author) from the immediate parent up to the root
- [ ] Top-level comments (depth=0) have an empty parent_chain array
- [ ] Nested comments include all ancestors in parent_chain, ordered from immediate parent to root
- [ ] Comment depth is correctly tracked (0 for top-level, incrementing for each nesting level)
- [ ] Comments from deleted or removed authors are still fetched (author set to "[deleted]" as returned by PRAW)
- [ ] replace_more() is called with a configurable limit (default limit=0 to skip deeply nested expansion); timeout or failure logs a warning and proceeds with comments already loaded
- [ ] Posts with zero comments produce an empty comments list and do not cause errors

## Technical Notes
- PRAW's comment forest provides threaded structure; use replace_more() to expand collapsed comment threads before iteration
- Engagement sorting (score x replies) determines which comments are fetched from Reddit; this is distinct from the priority scoring in story-002-007
- Parent chain building is recursive: for each comment, walk up the thread tree collecting ancestors
- ParentChainEntry structure defined in PRD Appendix D.3: id (string), body (string), depth (int), author (string)
- The 1000-comment limit per post means ~10,000 total comments across 10 posts before prioritization
- PRD reference: Section 3.2.2 Phase 1 steps 4-5, Appendix D.1, D.3

## Dependencies
- Depends on: story-002-001 (posts must be fetched first)
- Blocks: story-002-004 (financial scoring), story-002-005 (author trust lookup), story-002-006 (engagement scoring), story-002-007 (priority scoring needs all components)
