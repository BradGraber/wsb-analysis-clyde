---
id: story-006-018
epic: epic-006
title: Write Concurrency Unit Tests
priority: medium
story_points: [TBD]
source_requirements: [PIPE-051]
dependencies: [story-006-013]
blocks: []
---

# Story: Write Concurrency Unit Tests

## Description
Write 2 unit tests validating concurrent Schwab quote fetching across up to 40 open positions using ThreadPoolExecutor. Verify that concurrent requests complete without data races and that retry/fallback logic functions correctly under concurrent execution.

## Acceptance Criteria
- [ ] Test 1: ThreadPoolExecutor correctly dispatches concurrent Schwab quote requests for multiple tickers (simulating 40 open positions) and collects all results
- [ ] Test 2: Concurrent execution with mixed success/failure responses correctly applies per-ticker retry and fallback logic without cross-contamination between tickers
- [ ] Both tests use mocked Schwab API responses (no real network calls)

## Technical Notes
- PIPE-051: Concurrent Schwab quote fetches using ThreadPoolExecutor (concurrency decision from Phase 1 planning: qc-qa-004).
- Test 1 validates happy path: all 40 quotes return successfully with concurrent execution.
- Test 2 validates mixed path: some tickers fail (triggering retry + fallback), others succeed, with no interference.
- Use unittest.mock to patch the Schwab client, verify ThreadPoolExecutor is used, and assert correct result aggregation.
- Verify no shared mutable state issues between concurrent threads.

## Dependencies
- Depends on: story-006-013 (Schwab retry and fallback logic)
- Blocks: none
