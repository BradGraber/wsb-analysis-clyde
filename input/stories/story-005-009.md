---
id: story-005-009
epic: epic-005
title: Write Position Management Unit Tests
priority: medium
story_points: [TBD]
source_requirements: [PIPE-035]
dependencies: [story-005-008]
blocks: []
---

# Story: Write Position Management Unit Tests

## Description
Write unit tests covering critical position management flows: concurrent Schwab quote fetches during position opening using ThreadPoolExecutor, position replacement close-then-open end-to-end flow, and cash guard preventing overdraft. Tests use VCR.py cassettes for Schwab API interactions and hand-written fixtures for database state.

## Acceptance Criteria
- [ ] Concurrent quote fetch test: multiple portfolios fetch Schwab quotes simultaneously via ThreadPoolExecutor, all return valid prices without race conditions
- [ ] Position replacement test: full close-then-open flow with position_exits INSERT, position status='closed' UPDATE, portfolio cash UPDATE, and new position INSERT in correct order
- [ ] Cash guard test: position opening is skipped with appropriate warning log when cash_available < position_size, and pipeline continues to next portfolio
- [ ] Cash guard overdraft test: after opening positions that consume most cash, subsequent positions are correctly skipped when remaining cash is insufficient
- [ ] Replacement safeguard test: position with unrealized_gain > +5% is NOT replaced even when new signal confidence exceeds by > 0.1
- [ ] Portfolio value recalculation test: current_value correctly reflects cash_available + open position mark-to-market after opens and closes

## Technical Notes
- Use VCR.py cassettes for Schwab API quote and options chain responses per project mocking conventions
- Hand-written fixtures for portfolio state (cash_available, positions) and signal data
- ThreadPoolExecutor concurrency test should verify no SQLite locking issues with concurrent writes
- The replacement flow test should verify the atomic transaction: if any step fails, no partial state remains
- Consider testing the edge case where all 10 positions have > +5% unrealized gain (no replacement possible)
- Use an in-memory SQLite database with full schema for integration-style unit tests

## Dependencies
- Depends on: story-005-008 (all position management stories must be complete)
- Blocks: none
