---
id: story-009-006
epic: epic-009
title: Implement Evaluation Period Completion
priority: high
story_points: [TBD]
source_requirements: [FR-018, PIPE-054, NFR-001, NFR-003]
dependencies: [story-009-005]
blocks: []
---

# Story: Implement Evaluation Period Completion

## Description
Implement evaluation period completion logic. When an active period's period_end date has passed (period_end < today), calculate final metrics for each of the 4 portfolio periods and set status='completed'. Metrics include: portfolio_return_pct (calculated from value_at_period_start and current portfolio value), sp500_return_pct (fetched via yfinance for ^GSPC over the same date range), relative_performance (portfolio_return_pct - sp500_return_pct), beat_benchmark (boolean), total_positions_closed, winning_positions, losing_positions, avg_return_pct, and signal_accuracy_pct. After completing the 4 rows, immediately create the next 4 active periods with period_start = previous period_end (no gaps).

## Acceptance Criteria
- [ ] When active periods exist with period_end < today, all 4 are transitioned to status='completed' in a single transaction
- [ ] portfolio_return_pct is calculated as ((current_value - value_at_period_start) / value_at_period_start) * 100 for each portfolio
- [ ] sp500_return_pct is calculated by fetching ^GSPC close prices for period_start and period_end via yfinance, computing ((end_price - start_price) / start_price) * 100
- [ ] relative_performance = portfolio_return_pct - sp500_return_pct for each portfolio
- [ ] beat_benchmark is TRUE when relative_performance > 0, FALSE otherwise
- [ ] total_positions_closed counts positions with status='closed' that were closed within the period date range for the specific portfolio
- [ ] winning_positions and losing_positions are counted from closed positions based on realized_total_pnl > 0 (win) or <= 0 (loss); avg_return_pct is the mean return across closed positions
- [ ] signal_accuracy_pct is calculated as winning_positions / max(total_positions_closed, 1) * 100
- [ ] After completing all 4 periods, 4 new active periods are created with period_start = previous period_end, period_end = new period_start + 30 days, value_at_period_start = current portfolio value
- [ ] If yfinance fails to return S&P 500 data after retries, sp500_return_pct, relative_performance, and beat_benchmark are all set to NULL
- [ ] If zero positions were closed during the evaluation period, total_positions_closed=0, winning_positions=0, losing_positions=0, avg_return_pct=0.0, signal_accuracy_pct=0.0

## Technical Notes
- Pipeline step: Phase 7b continuation (PRD Section 3.2.2 lines 387-389)
- PRD specifies: "closed position = status='closed' (fully exited, shares_remaining=0 or contracts_remaining=0). Partially exited positions excluded from period metrics until fully closed" (line 388)
- realized_total_pnl per position = SUM(position_exits.realized_pnl) for that position
- yfinance integration: fetch ^GSPC historical data for the period date range; handle API failures gracefully (retry, then log warning if unavailable)
- NFR-001 target: beat S&P 500 by 10% per 30-day period (this is the success metric, not a hard requirement)
- The completion + new period creation should be atomic (single transaction)
- New periods have period_start = previous period_end to ensure no gaps in evaluation coverage

## Dependencies
- Depends on: story-009-005 (evaluation period creation must exist before completion can run)
- Blocks: none (evaluation data is consumed by dashboard in epic-008)
