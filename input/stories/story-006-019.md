---
id: story-006-019
epic: epic-006
title: Implement Prediction Monitoring in Exit Loop
priority: medium
story_points: [TBD]
source_requirements: [PIPE-058, DB-PREDICTION-EXITS]
dependencies: [story-006-015, story-006-005, story-006-006]
blocks: [story-006-020, story-006-021]
---

# Story: Implement Prediction Monitoring in Exit Loop

## Description
Extend the Phase 6 monitoring loop to process 'tracking' predictions alongside real positions. Real positions have priority in the loop. Predictions reuse cached Schwab data (batched by ticker). The shared exit evaluation runs via MonitoredInstrument protocol, applying the same options exit cascade. Handle expired-past-expiration (DTE < 0). Insert prediction_outcomes and prediction_exits records. Calculate blended simulated_return_pct. Predictions do NOT update portfolio cash.

## Acceptance Criteria
- [ ] Predictions with status='tracking' are loaded and processed after all real positions in each monitoring cycle
- [ ] Real positions have priority access to Schwab API; predictions reuse cached ticker data (one Schwab call per unique ticker)
- [ ] For each tracking prediction: current_premium is fetched, peak_premium is updated to MAX(peak_premium, current_premium)
- [ ] prediction_outcomes record is INSERTed for each monitoring check (day_offset, premium, underlying_price)
- [ ] Expired-past-expiration predictions (expiration_date < today) are immediately resolved: INSERT prediction_exits with exit_reason='expiration', quantity_pct=1.0, set status='resolved'
- [ ] Active predictions run through the shared exit cascade via MonitoredInstrument: expiration > stop-loss > take-profit > trailing > time
- [ ] prediction_exits records are INSERTed for each triggered exit; contracts_remaining is decremented
- [ ] When contracts_remaining reaches 0: simulated_return_pct = SUM(prediction_exits.simulated_pnl) / (entry_premium * contracts * 100), status='resolved', resolved_at=NOW()
- [ ] If no cached Schwab data exists for a prediction's ticker (ticker not in any real position), a new Schwab call is made for that ticker, batched with other uncached prediction tickers
- [ ] Predictions do NOT update portfolio cash_available (no financial impact on portfolios)

## Technical Notes
- PIPE-058: Phase 6 processes predictions alongside positions using MonitoredInstrument interface.
- DB-PREDICTION-EXITS: prediction_exits table stores simulated exit events for predictions.
- Prediction monitoring runs AFTER real position monitoring in the Phase 6 loop.
- Schwab API data is cached by ticker during real position processing; predictions tap into the same cache.
- The exit cascade is identical to options exits (expiration > stop-loss > take-profit > trailing > time) but writes to prediction_exits instead of position_exits.
- Key difference from real positions: no cash impact, no portfolio updates, uses simulated_pnl instead of realized_pnl.
- DTE < 0 means the prediction's option expired between monitoring runs -- immediate forced resolution.
- Use fixture/mock prediction data for development and testing.

## Dependencies
- Depends on: story-006-015 (MonitoredInstrument protocol), story-006-005 (expiration logic), story-006-006 (premium monitoring logic)
- Blocks: story-006-020 (prediction monitoring tests), story-006-021 (prediction edge case tests)
