---
id: story-006-011
epic: epic-006
title: Implement Full Close Finalization
priority: high
story_points: [TBD]
source_requirements: [PIPE-049]
dependencies: []
blocks: [story-006-009]
---

# Story: Implement Full Close Finalization

## Description
Implement the position finalization logic that executes when a position is fully closed (shares_remaining or contracts_remaining reaches 0). Set status to 'closed', record exit_date, calculate hold_days as calendar days from open_date, and compute realized_return_pct as SUM(position_exits.realized_pnl) / position_size.

## Acceptance Criteria
- [ ] Position status is set to 'closed' when shares_remaining (stocks) or contracts_remaining (options) reaches 0
- [ ] exit_date is set to the date of the final exit
- [ ] hold_days is calculated as calendar days between open_date and exit_date (not trading days)
- [ ] realized_return_pct is calculated as SUM(all position_exits.realized_pnl for this position) / position_size
- [ ] Finalization correctly handles positions with multiple partial exits (sum ALL exit records)
- [ ] Portfolio current_value is recalculated after close: cash_available + SUM(open stock values) + SUM(open options values)
- [ ] Division-by-zero is prevented: if position_size is 0, realized_return_pct is set to 0.0

## Technical Notes
- PIPE-049: Full close finalization sets status='closed', exit_date, hold_days, realized_return_pct = SUM(exits.realized_pnl) / position_size.
- position_size is the original position value at entry (entry_price * shares for stocks, entry_premium * contracts * 100 for options).
- hold_days = (exit_date - open_date).days using calendar days.
- This function is called by partial exit mechanics (story-006-009) when remaining quantity reaches 0.
- Also called directly by full exit conditions (stop-loss 100%, expiration 100%, time stop 100%).
- Must handle both single-exit closes and multi-exit closes (e.g., 50% take-profit + 50% trailing stop).

## Dependencies
- Depends on: none (foundational exit mechanic)
- Blocks: story-006-009 (partial exit mechanics calls finalization when remaining = 0)
